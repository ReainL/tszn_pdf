
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>在 SSIS 中并没有直接提供从数据源到 XML 的转换输出，Destination 的输出对象有 Excel File, Flat File, Database 等，但是并没有直接提供 XML 文件输出的配置。</p><p>但是我们仍然可以通过下面这些方法来实现：</p><p>方法一：在数据流中使用平面文件对字符串 XML 转换输出</p><p>方法二：在控制流中使用 Script Task 输出 XML 文件</p><h2 id="articleHeader2">需求描述</h2><p>要将下面的这种查询结果转换成 XML -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021423165478316.png"/></p><p>需要输出成 XML 文件的格式 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021423250321624.png"/></p><p>那么首先在SQL 语句中就需要将格式转换一下，可以将将查询结果包装成相应的 XML 格式 -</p><pre><code><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><br/>
<span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> T009_SALES_ORDER_DETAIL  <br/>
</span><span style="color: rgb(0, 0, 255);">FOR</span> XML <span style="color: rgb(0, 0, 255);">RAW</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">'</span>),ROOT(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">SalesOrder</span><span style="color: rgb(255, 0, 0);">'</span>),ELEMENTS</code></pre><p>关于 SQL XML 查询的内容，不是文本的重点，大家可以参考博客园中其他博友的博客：</p><ol><li><a href="http://www.cnblogs.com/kenshincui/archive/2011/12/31/2309217.html" target="_blank"><u><font color="#0066cc">SQL FOR XML</font></u></a></li><li><a href="http://www.cnblogs.com/doubleliang/archive/2011/07/06/2098775.html" target="_blank"><u><font color="#0066cc">灵活运用 SQL SERVER FOR XML PATH</font></u></a></li></ol><h2 id="articleHeader3">在数据流中使用平面文件对字符串 XML 转换输出</h2><p>在 Data Flow 中新建一个 Source 并且使用上面的 SQL 语句，这个 SQL 语句查询的结果是一个 XML 格式的大字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021429342979778.png"/></p><p>它的 Columns 输出的就是包含了整个 XML 结果的字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021429408602173.png"/></p><p>为了兼容后面文件输出时的字符类型转换问题，添加一个 Data Convertion 将这个输出改变一下数据类型，这里选择的是 Unicode text stream [DT_NTEXT]。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021431466577008.png"/></p><p>新建一个 Flat File Connection Manager，文件后缀名称是 .xml 结尾。如果测试环境是中文，或者输出的字符串中有双字节字符类型，那么就应该在 Locale 选择适当的环境语言，并且应该勾选上 Unicode。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021435200475750.png"/></p><p>并且在 Advanced 中新增加一个 Column，并且一定要注意在类型中应该选择的应该是 Unicode text stream。<strong><span style="color: rgb(255, 0, 0);">并且这也就是要用 Flat File Connection 而不使用 Raw File 的原因，因为 Raw File 中不支持 Text 文本数据类型。</span></strong></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021436569537077.png"/></p><p>新建一个 Flat File Destination 组件，并且使用上面编辑好了的 Flat File Connection Manager。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021451546575024.png"/></p><p>使用刚才在 Data Conversion 中编辑过的新 Column 与输出 Column 匹配。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021452001578076.png"/></p><p>保存并执行 SSIS Package。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021452322039553.png"/></p><p>你认为一定成功了，对吧！打开一看，傻眼了吧！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021453410789944.png"/></p><p>原因是什么呢？我们可以回到 OLE_SRC_OrderDetail 中 Preview 一下，看到了吗？在这里这个输出是Byte字节数组。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021454499531337.png"/></p><p>需要将上面的 SQL 再次包装成 XML 一下，将这个查询结果单独包装成一个字符串格式。</p><pre><code><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"><br/>
(<br/>
  </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 0, 255);">TOP</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">10</span><br/>
     <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderID</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderDetailID</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CarrierTrackingNumber</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">OrderQty</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">ProductID</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">UnitPrice</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">UnitPriceDiscount</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"><br/>
    ,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">ModifiedDate</span><span style="color: rgb(255, 0, 0);">]</span><br/>
   <span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Sales</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">FOR</span> XML <span style="color: rgb(0, 0, 255);">RAW</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">'</span>),ROOT(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">SalesOrder</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),ELEMENTS<br/>
)</span><span style="color: rgb(0, 0, 255);">AS</span> XML_Order</code></pre><p>不包装时在 SQL Server 中的查询结果可以理解它是一个正儿八经的 XML 文件，点击打开就是一整个 XML 格式的文本 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021457174072955.png"/></p><p>包装之后在 SQL Server 中的查询结果 - 这才是真正的文本数据。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021459169224610.png"/></p><p>再次 Preview 一下，看到 XML 格式的字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021500407359203.png"/></p><p>修改后面的 Mapping 关系，并保存执行输出，在浏览器中查看 XML 文件结果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021500527504367.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021502280479453.png"/></p><h2 id="articleHeader4">在控制流中使用 Script Task 输出 XML 文件</h2><p>新建两个变量，一个保存文件路径，另一个保存 XML 字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021509229697259.png"/></p><p>注意这时使用的是 Execute SQL Task 是一个控制流控件， SQL Statement 中使用上面那个包装过的 XML 查询。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021512082507064.png"/></p><p>Result Set 中将输出的 XML 结果用上面新建的变量来保存。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021512550164745.png"/></p><p>新建一个 Script Task 传入两个变量。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021514105477502.png"/></p><p>Script 中引用 System.IO 命名空间，然后就是下面这几句代码。</p><pre><code><span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> Main()<br/>
{<br/>
            </span><span style="color: rgb(0, 0, 255);">string</span> content = Dts.Variables[<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">User::XmlString</span><span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">].Value.ToString();<br/>
            </span><span style="color: rgb(0, 0, 255);">string</span> filePath = Dts.Variables[<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">User::XmlFilePath</span><span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">].Value.ToString();<br/>
            StreamWriter writer </span>= <span style="color: rgb(0, 0, 255);">new</span><span style="color: rgb(0, 0, 0);"> StreamWriter(filePath);<br/>
            writer.WriteLine(content);<br/>
            writer.Close();<br/>
           <br/>
            Dts.TaskResult </span>= (<span style="color: rgb(0, 0, 255);">int</span><span style="color: rgb(0, 0, 0);">)ScriptResults.Success;<br/>
}</span></code></pre><p>保存执行并查看输出的 XML 文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021517027975346.png"/></p><p>输出的结果有一个 ROOT ，这可以在代码中非常容易的处理掉。</p><pre><code> <span style="color: rgb(0, 0, 255);">string</span> content = Dts.Variables[<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">User::XML_STRING</span><span style="color: rgb(128, 0, 0);">"</span>].Value.ToString().Replace(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;ROOT&gt;</span><span style="color: rgb(128, 0, 0);">"</span>, <span style="color: rgb(128, 0, 0);">""</span>).Replace(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;/ROOT&gt;</span><span style="color: rgb(128, 0, 0);">"</span>, <span style="color: rgb(128, 0, 0);">""</span>);</code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/021519120167835.png"/></p><h2 id="articleHeader5">XP_CMDSHELL 输出</h2><p>PS : 更新补充一下不使用 SSIS 工具直接通过 SQL 输出到文件的方式 - XP_CMDSHELL</p><pre><code><span style="color: rgb(0, 0, 255);">EXEC</span> sp_configure <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">show advanced options</span><span style="color: rgb(255, 0, 0);">'</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">RECONFIGURE</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">EXEC</span> sp_configure <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">xp_cmdshell</span><span style="color: rgb(255, 0, 0);">'</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">RECONFIGURE</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span><br/>
 <br/>
<span style="color: rgb(0, 0, 255);">EXEC</span> XP_CMDSHELL <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">BCP "SELECT(SELECT TOP 2 * FROM [AdventureWorks2012].[Sales].[SalesOrderDetail]  FOR XML RAW(</span><span style="color: rgb(255, 0, 0);">''</span><span style="color: rgb(255, 0, 0);">SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">''</span><span style="color: rgb(255, 0, 0);">),ROOT(</span><span style="color: rgb(255, 0, 0);">''</span><span style="color: rgb(255, 0, 0);">SalesOrder</span><span style="color: rgb(255, 0, 0);">''</span><span style="color: rgb(255, 0, 0);">),ELEMENTS )AS XML_Order " QUERYOUT "D:\text.xml" -c -T</span><span style="color: rgb(255, 0, 0);">'</span><br/>
 <br/>
<span style="color: rgb(0, 0, 255);">EXEC</span> sp_configure <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">show advanced options</span><span style="color: rgb(255, 0, 0);">'</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">RECONFIGURE</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">EXEC</span> sp_configure <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">xp_cmdshell</span><span style="color: rgb(255, 0, 0);">'</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span> <br/>
<span style="color: rgb(0, 0, 255);">RECONFIGURE</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></code></pre><p>这样也是可以的，但是一般情况下至少我很少选择这种方式，原因主要有几个：</p><p>1. XP_CMDSHELL 默认被禁用的，要使用 sp_configure 来控制，因此需要级别比较高的权限，但是在实际操作中客户在很多时候不会给那么多的权限。</p><p>2. 很重要的一点就是在 BI 当中，我们所有的文件输出一定有日志的记录，包括输出路径，起始时间，文件大小等等，使用 SSIS 可以更好的跟 Process Log 结合起来使用。</p><p>3. 如果是一些比较复杂的 SQL 查询输出，在 SQL 中拼接字符串也是一件非常痛苦的事情。<br/></p>
</div>]
</body>
</html>
