
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p>在 ETL 项目中还有一种比较常见的文件经常会被处理 - CSV 文件，全称 Comma-Separated Values - 字符分隔值文件。实际上它本身就是以纯文本形式存储数据的，逗号分隔，所以在 SSIS 中也完全可以按照平面文件的方式来处理这种类型的文件。</p><p>右键打开 CSV 文件，可以看到它和平常的平面文件没有什么区别，就是以半角逗号,分隔的的一个平面文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856045326225.png"/></p><p>我们下面的例子是先加载 CSV 文件，然后处理完成之后再把数据又导出成一个 CSV 文件。</p><h3 id="articleHeader2" style="margin-left: 0px;">从 CSV 文件导入数据</h3><p>尽管默认情况下，CSV 文件是被 Office Excel 打开的，但是实质上是一个平面文件。因此在数据流中选择的还是 Flat File Source，并在新建连接管理器的时候需要选择 .csv 文件类型以访问 CSV 数据源文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856183751330.png"/></p><p>由于这里是中文数据源，并且文件中还包含有一些全角符号，所以处理的时候应该选择 Unicode 编码，并且第一行没有 Column Name。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856254389339.png"/></p><p>由于这个 CSV 文件没有列名称，因此默认情况下会显示 Column 0, Column 1... 为了显示方便包括和匹配后面目标表上的列，这里更改了列的名称，数据类型不作处理。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856329382048.png"/></p><p>目标表的结构保持和文件默认格式一致，确保所有的数据都能够正常加载成功。</p><pre><code><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">CREATE</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">TABLE</span> <span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">T011_STAGING_HOTEL</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;"> (<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">HotelName</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">HotelAddress</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">X</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">Y</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">MinPrice</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">)<br/>
)</span></code></pre><p style="margin-left: auto;">设置好源和目标的 Mapping 关系，保存并执行包，发现出错了 - </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856394225700.png"/></p><p>查看错误信息如下：</p><p><span style="color: rgb(255, 0, 0);">[FF_SRC_CSV_HOTEL [2]] Error: Data conversion failed. The data conversion for column "HotelAddress" returned status value 4 and status text "Text was truncated or one or more characters had no match in the target code page.".</span></p><p><span style="color: rgb(255, 0, 0);">[FF_SRC_CSV_HOTEL [2]] Error: The "FF_SRC_CSV_HOTEL.Outputs[Flat File Source Output].Columns[HotelAddress]" failed because truncation occurred, and the truncation row disposition on "FF_SRC_CSV_HOTEL.Outputs[Flat File Source Output].Columns[HotelAddress]" specifies failure on truncation. A truncation error occurred on the specified object of the specified component.</span></p><p><span style="color: rgb(255, 0, 0);">[FF_SRC_CSV_HOTEL [2]] Error: An error occurred while processing file "D:\BIWORKSPACE_FILE\BIWORK_SSIS\INPUT_DIRECTORY\011\北京酒店信息.csv" on data row 46.</span></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856453289694.png"/></p><p>上面的这个报错信息告诉了我们大概以下几点原因：</p><ol><li>HotelAddress 列的转换，列有可能会被截断或者 Code Page 字符编码不同。</li><li>这个错误发生在第46行的位置。</li></ol><p>查看源数据文件基本上就是这个问题，也就是说 CSV 文件源到目标 OLE DB Destination 控件给我们推荐的表中列的长度定义并不一定完全准确。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856506416506.png"/></p><p>可以试着把 FF_SRC_CSV_HOTEL 中的 Error Output 的 Truncation 都设置为 Ignore failure。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061856559537615.png"/></p><p>测试并执行包，包运行是成功的，说明确实是发生了截断的错误。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857020637783.png"/></p><p>查看一下已经导入的目标表，发现第46行的数据的确发生了截断。在观察这个数据的同时，我们还发现了这个问题 - 在表格中的数据存在中大量中文符号，即全角符号类似于"（","）","【】"。这类符号应该在程序中要替换成半角的符号，即常见的英文格式下的符号。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857081104035.png"/></p><p>所以这里要做三件事情：</p><ol><li>修改 Flat File Connection Manager 中对 HotelAddress 列长的定义。</li><li>要对包含有中文全角符号的列进行过滤转换处理。</li><li>修改表结构，增加数据列定义的长度。</li></ol><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857172662672.png"/></p><p>在 Derived Column 中，写入表达式并替换旧的 HotelAddress</p><pre><code><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>(<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>(<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>(<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>(<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>(<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">REPLACE</span>( [HotelAddress] , <span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">（</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>, <span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">(</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>),<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">）</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>,<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">)</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>), <span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">【</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>,<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">""</span>),<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">】</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>,<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">""</span>),<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">，</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>,<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">,</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>),<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">。</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>,<span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">.</span><span style="color: rgb(128, 0, 0); line-height: 1.5 !important;">"</span>) </code></pre><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857289692163.png"/></p><pre><code><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">CREATE</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">TABLE</span> <span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">T011_STAGING_HOTEL</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;"> (<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">HotelName</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">HotelAddress</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">250</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">X</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">Y</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
    </span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">[</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">MinPrice</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">]</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">nvarchar</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">50</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">)<br/>
)</span></code></pre><p style="margin-left: auto;">保存并执行包，运行成功。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857371889486.png"/></p><p>查看数据表的结果，数据格式得到了统一，这就是能够解释 ETL 自身概念的一个例子 - Extract 抽取，Transform 转换，Load 加载。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857469534835.png"/></p><h3 id="articleHeader3" style="margin-left: 0px;">CSV 文件的输出</h3><p>下面我们要把这张表中的数据转出成一个 CSV 文件，那么在导出的时候由于前面说过 CSV 文件本身就是一种平面文件格式，因此选用 Flat File Destination 作为数据，源就是上面的这张表。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061857537038172.png"/></p><p>双击 FF_DST_HOTEL_CSV 编辑，并新建一个输出文件的链接管理器，默认选择 Delimited格式。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858002823796.png"/></p><p>输出的时候选择 .csv 格式。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858073754563.png"/></p><p>另外这里选择 Unicode 输出，并且 Text qualifier 选择"，这是因为 Hotel Address 列种包含有逗号，需要把每列括起来以区分 CSV 文件列的分隔符逗号。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858137508715.png"/></p><p>同时可以更改一下输出列的名称。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858251255007.png"/></p><p>在 Flat File Destination 中完成 Mapping。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858356888414.png"/></p><p>保存并运行包，整个输入和输出的流程都成功了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061858438606049.png"/></p><p>检查输出的文件，尽管感觉输出的列加上了双引号看起来不自然，但是这样可以有效的分隔了列数据。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/061859086572274.png"/></p>
</div>]
</body>
</html>
