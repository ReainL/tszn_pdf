
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<p>根据与源表, 对目标表执行插入、更新或删除操作.根据在另一个表中找到的差异在一个表中插入,更新或删除行,可以对两个表进行同步. <br/></p><p>在数据仓库应用中,这种SQL语句的使用比SSIS工具的使用更加容易维护些,因为表同步的逻辑可以写在存储过程中,维护的时候只需要维护存储过程即可,<br/>而不需要打开Package去检查SSIS Component的配置.<br/> <br/><span style="color: rgb(0, 128, 128);">/*</span><span style="color: rgb(0, 128, 128);">* Merge Operation and Output Clause*</span><span style="color: rgb(0, 128, 128);">*/</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Source table</span><span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@SourceTable</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);">(   ID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span><span style="color: rgb(0, 0, 0);">,   DSPT </span><span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0);">50</span><span style="color: rgb(0, 0, 0);">))</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Target table</span><span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@TargetTable</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);">(   ID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span><span style="color: rgb(0, 0, 0);">,   DSPT </span><span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0);">50</span><span style="color: rgb(0, 0, 0);">)) </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Log table</span><span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@Log</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);">(   ID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(255, 0, 255);">IDENTITY</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span><span style="color: rgb(0, 0, 0);">,   Operation </span><span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0);">20</span><span style="color: rgb(0, 0, 0);">),   OldID </span><span style="color: rgb(0, 0, 255);">INT</span><span style="color: rgb(0, 0, 0);">,   OldValue </span><span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0);">100</span><span style="color: rgb(0, 0, 0);">),   NeID </span><span style="color: rgb(0, 0, 255);">INT</span><span style="color: rgb(0, 0, 0);">,   NewValue </span><span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0);">100</span><span style="color: rgb(0, 0, 0);">)) </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Insert testing data</span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@SourceTable</span> <span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(128, 0, 0);">1</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ST 1001</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">2</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ST 1002</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">3</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ST 1003</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">4</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ST 1004</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">5</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ST 1005</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">) </span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@TargetTable</span> <span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(128, 0, 0);">1</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TT 1001</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">2</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TT 1002</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">3</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TT 1003</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">6</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TT 1006</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),(</span><span style="color: rgb(128, 0, 0);">7</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TT 1007</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">) </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@SourceTable</span>/**<br/>1 ST 1001<br/>2 ST 1002<br/>3 ST 1003<br/>4 ST 1004<br/>5 ST 1005<br/>**/<br/><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@TargetTable</span>/**<br/>1 TT 1001<br/>2 TT 1002<br/>3 TT 1003<br/>6 TT 1006<br/>7 TT 1007<br/>**/ <br/><span style="color: rgb(0, 128, 128);">/*</span><span style="color: rgb(0, 128, 128);">* Merge operation *</span><span style="color: rgb(0, 128, 128);">*/</span><span style="color: rgb(0, 0, 0);">MERGE </span><span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@TargetTable</span> <span style="color: rgb(0, 0, 255);">AS</span> T           <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Merge data from source table into target table</span>USING <span style="color: rgb(0, 128, 0);">@SourceTable</span> <span style="color: rgb(0, 0, 255);">AS</span> S                <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Using source table</span> <span style="color: rgb(0, 0, 255);">ON</span> T.ID <span style="color: rgb(128, 128, 128);">=</span> S.ID                      <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Join conditions</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> If join condition is true, then matched</span><span style="color: rgb(0, 0, 255);">WHEN</span><span style="color: rgb(0, 0, 0);"> MATCHED            </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Update or Delete operation                </span> <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(0, 0, 255);">SET</span> T.DSPT <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> S.DSPT  </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Not matched</span><span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(128, 128, 128);">NOT</span> MATCHED <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> TARGET   </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Insert new data        </span> <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);">(S.ID,S.DSPT)</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Delete or update by using flag to indicate the values in target</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> table don't exist in source table    </span><span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(128, 128, 128);">NOT</span> MATCHED <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> SOURCE               </span><span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">DELETE</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Can log the operation details by using output clause</span>OUTPUT $ACTION <span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">ACTION</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);">,   Deleted.ID </span><span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Deleted ID</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">,   Deleted.DSPT </span><span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Deleted Description</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">,   Inserted.ID </span><span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Inserted ID</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">,   Inserted.DSPT </span><span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Inserted Description</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@Log</span><span style="color: rgb(0, 0, 0);">; </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Show the changes</span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@Log</span>/**<br/>1 UPDATE 1 TT 1001 1 ST 1001<br/>2 UPDATE 2 TT 1002 2 ST 1002<br/>3 UPDATE 3 TT 1003 3 ST 1003<br/>4 INSERT NULL NULL 4 ST 1004<br/>5 INSERT NULL NULL 5 ST 1005<br/>6 DELETE 6 TT 1006 NULL NULL<br/>7 DELETE 7 TT 1007 NULL NULL<br/>**/ <br/><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@SourceTable</span>/**<br/>1 ST 1001<br/>2 ST 1002<br/>3 ST 1003<br/>4 ST 1004<br/>5 ST 1005<br/>**/<br/> <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@TargetTable</span>/**<br/>1 ST 1001<br/>2 ST 1002<br/>3 ST 1003<br/>4 ST 1004<br/>5 ST 1005<br/>**/<br/> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Log user's insert operation</span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@SourceTable</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> To record the inserted ID and Description</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> when new record added into @Sourcetable</span>OUTPUT <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">INSERT</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(0, 0, 255);">NULL</span>,<span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,Inserted.ID,Inserted.DSPT   </span><span style="color: rgb(0, 0, 255);">INTO</span> <span style="color: rgb(0, 128, 0);">@Log</span><span style="color: rgb(0, 0, 255);">VALUES</span>(<span style="color: rgb(128, 0, 0);">10</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Insert a new value</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">) </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Show the final result</span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(0, 128, 0);">@Log<br/>/**<br/>1 UPDATE 1 TT 1001 1 ST 1001<br/>2 UPDATE 2 TT 1002 2 ST 1002<br/>3 UPDATE 3 TT 1003 3 ST 1003<br/>4 INSERT NULL NULL 4 ST 1004<br/>5 INSERT NULL NULL 5 ST 1005<br/>6 DELETE 6 TT 1006 NULL NULL<br/>7 DELETE 7 TT 1007 NULL NULL<br/>8 INSERT NULL NULL 10 Insert a new value<br/>**/</span></p>
</div>]
</body>
</html>
