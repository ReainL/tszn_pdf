
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>由于项目需要我们会从SharePoint 上读取一些配置数据，同时也有可能执行一些回写操作去更新SharePoint 的数据。之前没有做过这样的操作，有的也应该是通过 C# 编程去获取或者写入一些数据。查阅了一些相关的文章，自己也动手测试了一下如何在 SSIS Package 中访问SharePoint List 并将数据写入 SharePoint List。</p><p>两个操作 </p><ul><li>读取SharePoint List 的数据到数据库</li><li>从数据库中筛选一些数据然后插入到一个新的 SharePoint List 中</li></ul><p>这些操作不涉及到任何SharePoint 能够实现的功能，仅仅只是演示如何通过 SSIS 来完成这些操作， 也无关这个读写逻辑是否合理了。</p><h2 id="articleHeader2">实现过程</h2><p>步骤一 – 安装 SharePoint List Source and Destination</p><p>由于SSIS 是没有SharePoint 操作的控件的，但是目前已经有比较成型的第三方工具可以使用。</p><p>到 CodePlex 中去下载这个控件 <a href="http://sqlsrvintegrationsrv.codeplex.com/releases/view/17652"><u><font color="#0066cc">http://sqlsrvintegrationsrv.codeplex.com/releases/view/17652</font></u></a></p><p><u><font color="#0066cc"><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10164809-8d2611175272497dbce594dd24aaaa7e.png"/></font></u>                    </p><p>我目前的测试环境是 VS 2008，我下载的是第一个，应该也能兼容到 VS 2010。如果是 2012 版本，应该可以使用第二个 2012 的 Beta 版本，其安装和操作的过程大同小异。</p><p>下载之后安装，然后打开 VS 2008，在项目中 Data Flow Source 工具栏或者其他工具拦点击右键选择 Choose Items 后就会出现这个界面。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10164900-1e761dd8dcb640ccab57ab569bc45974.png"/></p><p>如果是VS 2010 或者 VS 2012 有可能不需要我们手动的添加这两个控件，也有可能连 SSIS Data Flow Items 可能都找不到。那么很有可能就是在安装的同时，这两个控件就已经自动的添加到 Data Flow 的工具箱了。</p><p>VS 2008 还是这样来选择一下，然后就能在工具箱看到这两个控件了，一个是Source，一个是Target。</p><p>默认情况下它们会出现在 General 下面。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10164954-a1c593c1d0cc4c00b7e9ef41d7a11233.png"/></p><p>你可以按照分类把 SharePoint List Source 拖放到 Data Flow Sources 和 Data Flow Destinations 中。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201305/10165119-431744e0f2f34b3386dd4fd76f995aab.png"/></p><p>这样第一步配置和安装的过程就算是完成了。</p><p>步骤二 –  读取 SharePoint List 的数据到数据库表</p><p><img alt="" height="222" src="http://images.cnitblog.com/blog/477275/201305/10170540-53fb6da713aa4dd991ead52f58886a3f.png" width="880"/></p><p>这里有一个List – Area Code，现在我们要把这个List 中的 Area Code，Region，Timezone Offset 还有 Description的内容读取到数据库中。</p><p>在设计 SSIS 的阶段也可以根据数据源的数据来创建表，但是最好根据实际需求先创建好表，结构如下-</p><pre><code>USE BIWork<br/>
GO<br/>
<br/>
IF OBJECT_ID('dbo.Area_Code','U') IS NOT NULL<br/>
DROP TABLE dbo.Area_Code<br/>
GO<br/>
<br/>
CREATE TABLE dbo.Area_Code<br/>
(<br/>
      ACID INT PRIMARY KEY IDENTITY(1,1),<br/>
      AreaCode NVARCHAR(10) NOT NULL,<br/>
      Region NVARCHAR(10),<br/>
      TimeOffset NVARCHAR(10),<br/>
      Descript NTEXT<br/>
)</code></pre><p>创建 SSIS 项目和Package 包，并在 Control Flow 中添加一个Data Flow，命名为 Extract SharePoint List。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10170710-099903a69b7e429e830900959b8d875d.png"/> </p><p>在这个Data Flow 中，添加 SharePoint List Source。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10170737-b9943755ebb54fcba9f32ac1f7818f19.png"/> </p><p>在编辑SharePoint List Source 之前先要创建一个 SharePoint Connection Manager。注意 – 不同的版本可能有一些区别，有的版本不需要 Connection Manager 没有这一项。</p><p>在 Connection Manager 中 New Connection 选择 SPCRED就可以了。</p><p><img alt="" height="414" src="http://images.cnitblog.com/blog/477275/201305/10170805-2dd108fd70264fcd9b7c5cbabbf552a0.png" width="553"/> </p><p>顺便把数据库的 Connection Manager 都创建好，创建完的结果应该是。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10170837-b70d24adadc242efa8b32069c2e006b1.png"/> </p><p>一个是 BIWORK 数据库的连接，另外两个都是SharePoint 的连接，后面都会用到。</p><p>下面就要对 SharePoint List Source 进行编辑。</p><p>在 SharePoint List Source 的Connection Manager 中选择好刚创建的连接。</p><p><img alt="" height="215" src="http://images.cnitblog.com/blog/477275/201305/10170856-7e6c43b67c7d490797b9416a4e47d446.png" width="667"/></p><p>Component Properties 中 有几个地方要注意。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10170915-0d14319eab8541d482c450c8180afede.png"/></p><p>由于在 SharePoint 中访问List 的URL 是<a href="http://biwork/Lists/Area%20Code/AllItems.aspx"><u><font color="#0066cc">http://biwork/Lists/Area%20Code/AllItems.aspx</font></u></a></p><p>因此在填写 SiteURL 的时候就只应该填写 Lists 之前的部分<a href="http://biwork/"><u><font color="#0066cc">http://biwork</font></u></a></p><p>在 SiteListName 中填写上需要访问的List 名称，在这里我们访问的是 Area Code。</p><p>不需要的Column 直接删除掉，只保留需要的Column，这样可以提高效率。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171555-53485b2dd1f54dfdbfbd54d9cfa16b5f.png"/></p><p>就点击保存，那么这样 SharePoint List Source 配置就完成了。</p><p>添加一个 OLE DB Destination。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171010-380eb8a7175a4facb84b996893307c5e.png"/></p><p>Mapping 的选择。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171632-59a9c30532c34bf9a6ae30ba031672fc.png"/></p><p>保存后执行Package并查询数据库结果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171707-910b7e95eb8f4fc99ac4e4ab678d616c.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171721-8e041f2611e842889b83f3abcb8d748c.png"/></p><p>Description 中有其它的 HTML 标签，应该是在设置 SharePoint List 的时候 Description Column 的类型是 Multiple line of Text 因此对应的数据库 Descript 类型也是 NTEXT 的，其它单行的数据就没有出现HTML 标签。</p><p>步骤三 – 将数据库中的数据导入到新的SharePoint List</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10171924-70fbd12185504bfc996593982f2d8f0c.png"/></p><p>创建一个新的List，并查询数据库中 Time Offset 为-5的数据插入到这个新的List 中 – New Area。</p><p>创建 Data Flow Task 并且在 OLE DB Source 中使用查询语句筛选出 Time Offset 为 -5 的数据。</p><pre><code>SELECT AreaCode,<br/>
       Region<br/>
FROM dbo.Area_Code<br/>
WHERE TimeOffset = -5</code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172035-8995cb8144814e7bbe2274a9f5c2bc7e.png"/></p><p>创建 SharePoint List Destination。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172116-702b63a1f9d146899a18bef35b014f62.png"/></p><p>Component Properties 配置。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172333-4a7d132e8cba4e279f30d098462809b2.png"/></p><p>SiteListName – New Area</p><p>SiteURL – <a href="http://biwork" rel="nofollow">http://biwork</a></p><p>Input Column 中应该要刷新一下才能看到 Mapping 信息。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172405-31b0faff4f9645618725f64998670c54.png"/></p><p>Insert Into SharePoint List Data Flow</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172512-1e304122c06748208b65b8b02461fec0.png"/> </p><p>执行Package 包</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172526-e918dac1fbb0424d9fe60bb7059e60e0.png"/> </p><p>检查 SharePoint List  - New Area 添加成功</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201305/10172540-5f3f6b77435343fdb645776db475c7d2.png"/></p><p>这样就完成对 SharePoint List 的读取和写入操作了。</p><p>除此之外还可以做删除 更新等操作，如有需要请参看其它文章。</p><ul><li><a href="http://sqlsrvintegrationsrv.codeplex.com/releases/view/17652"><u><font color="#0066cc">http://sqlsrvintegrationsrv.codeplex.com/releases/view/17652</font></u></a></li><li><a href="http://msdn.microsoft.com/en-us/library/hh368261.aspx"><u><font color="#0066cc">http://msdn.microsoft.com/en-us/library/hh368261.aspx</font></u></a></li><li><a href="http://dataqueen.unlimitedviz.com/2011/06/how-to-use-a-sharepoint-list-as-a-data-source-in-your-ssis-package/"><u><font color="#0066cc">http://dataqueen.unlimitedviz.com/2011/06/how-to-use-a-sharepoint-list-as-a-data-source-in-your-ssis-package/</font></u></a></li></ul><p>PS：最后补充一下，关于在 Visual Studio 2010 和 Visual Studio 2012 版本中这个插件都是安装完了重启一下 VS 就可以了。并且 SharePointList 组件是属于数据流的，在控制流中是看不到的。</p><p>以下我的 Visual Studio 2010 版本中的 SharePoint List Source 和 SharePoint List Destination。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/27165918-0428d31f49ce4803a81187edc67a7657.png"/></p><p>以下我的 Visual Studio 2012 版本中的 SharePoint List Source 和 SharePoint List Destination。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/27165925-20663e3025ef4c0e978f01f1ff9dab11.png"/><br/></p>
</div>]
</body>
</html>
