
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>基于上一篇文章 <a href="http://www.flybi.net/blog/biwork/562" target="_blank">SQL SERVER 表分区笔记 - 案例分享</a><span style="color: rgb(0, 0, 0);"> 继续了解 Sliding Window 滑动窗口的处理</span><p><span style="color: rgb(0, 0, 0);">Note: 示例中使用到了SQL Server 2000的Demo Database, 可以从此链接中下载</span></p><p><a href="http://www.microsoft.com/en-us/download/confirmation.aspx?id=23654"><u><font color="#0066cc">http://www.microsoft.com/en-us/download/confirmation.aspx?id=23654</font></u></a> </p><h2 id="articleHeader2">案例分享</h2><p>/****************************************************************</p><p>-- Order 分区表</p><p><span style="color: green;">******************************************************************/</span></p><p><span style="color: blue;">IF</span> <span style="color: fuchsia;">OBJECT_ID</span><span style="color: gray;">(</span><span style="color: red;">'dbo.Orders'</span><span style="color: gray;">)IS</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">TABLE</span> Orders</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_schemes</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PS_Orders'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> SCHEME PS_Orders</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_functions</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PF_Orders_OrderDateRange'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange</p><p>GO</p><p>-- 创建分区函数</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange<span style="color: gray;">(</span><span style="color: blue;">DATETIME</span><span style="color: gray;">)</span></p><p>AS</p><p><span style="color: blue;">RANGE</span> <span style="color: gray;">RIGHT</span> <span style="color: blue;">FOR</span> <span style="color: blue;">VALUES</span></p><p>(</p><p>   <span style="color: red;">'1996-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1997-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1998-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1999-01-01'</span></p><p>)</p><p><span style="color: blue;">GO</span></p><p>-- 创建分区方案</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> SCHEME PS_Orders</p><p>AS</p><p><span style="color: blue;">PARTITION</span> PF_Orders_OrderDateRange</p><p><span style="color: gray;">ALL</span> <span style="color: blue;">TO </span><span style="color: gray;">(</span>[primary]<span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p>-- 创建分区表</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders</p><p>(</p><p>   OrderID     <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   CustomerID  <span style="color: blue;">VARCHAR</span><span style="color: gray;">(</span>10<span style="color: gray;">)</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   EmployeeID  <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   OrderDate   <span style="color: blue;">DATETIME</span>    <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p>)</p><p><span style="color: blue;">ON</span> PS_Orders<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">CLUSTERED</span> <span style="color: blue;">INDEX</span> IXC_Orders_OrderDate <span style="color: blue;">ON</span> dbo<span style="color: gray;">.</span>Orders<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> PK_Orders</p><p><span style="color: blue;">PRIMARY</span> <span style="color: blue;">KEY</span><span style="color: gray;">(</span>OrderID<span style="color: gray;">,</span> CustomerID<span style="color: gray;">,</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p><span style="color: blue;">INSERT</span> <span style="color: blue;">INTO</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">SELECT</span> OrderID<span style="color: gray;">,</span></p><p>       CustomerID<span style="color: gray;">,</span></p><p>       EmployeeID<span style="color: gray;">,</span></p><p>       OrderDate</p><p><span style="color: blue;">FROM</span> Northwind<span style="color: gray;">.</span>dbo<span style="color: gray;">.</span>Orders</p><p>GO</p><p> </p><p>/****************************************************************</p><p>*** Order Archive  归档分区表,归档那些不经常查询不活跃的历史数据</p><p>*** 本示例中需要归档的数据1996年和年</p><p><span style="color: green;">******************************************************************/</span></p><p><span style="color: blue;">IF</span> <span style="color: fuchsia;">OBJECT_ID</span><span style="color: gray;">(</span><span style="color: red;">'dbo.OrdersArchive'</span><span style="color: gray;">)IS</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">TABLE</span> OrdersArchive</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_schemes</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PS_OrdersArchive'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_functions</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PF_OrdersArchive_OrderDateRange'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange</p><p><span style="color: blue;">GO</span></p><p>-- 创建分区函数</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span><span style="color: blue;">DATETIME</span><span style="color: gray;">)</span></p><p>AS</p><p><span style="color: blue;">RANGE</span> <span style="color: gray;">RIGHT</span> <span style="color: blue;">FOR</span> <span style="color: blue;">VALUES</span></p><p>(</p><p>   <span style="color: red;">'1996-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1997-01-01'</span></p><p>)</p><p><span style="color: blue;">GO</span></p><p>-- 创建分区方案</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive</p><p>AS</p><p><span style="color: blue;">PARTITION</span> PF_OrdersArchive_OrderDateRange</p><p><span style="color: gray;">ALL</span> <span style="color: blue;">TO </span><span style="color: gray;">(</span>[primary]<span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p>-- 创建分区表</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>OrdersArchive</p><p>(</p><p>   OrderID     <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   CustomerID  <span style="color: blue;">VARCHAR</span><span style="color: gray;">(</span>10<span style="color: gray;">)</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   EmployeeID  <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   OrderDate   <span style="color: blue;">DATETIME</span>    <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p>)</p><p><span style="color: blue;">ON</span> PS_OrdersArchive<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">CLUSTERED</span> <span style="color: blue;">INDEX</span> IXC_OrdersArchive_OrderDate <span style="color: blue;">ON</span> dbo<span style="color: gray;">.</span>OrdersArchive<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> PK_OrdersArchive</p><p><span style="color: blue;">PRIMARY</span> <span style="color: blue;">KEY</span><span style="color: gray;">(</span>OrderID<span style="color: gray;">,</span> CustomerID<span style="color: gray;">,</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p>/************************************************************************</p><p>查看分区表分区函数的分区范围</p><p>Orders -</p><p>PF_Orders_OrderDateRange    1    NULL                                   &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    5    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p> </p><p>OrdersArchive</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                   &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p>************************************************************************/</p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.Orders'</span></p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>GO</p><p> </p><p>/***************************************************************************</p><p>查询源分区表结果1996年以前的数据没有,所以分区是空的</p><p>2    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p>3    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>4    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p>/***************************************************************************</p><p>查询存档表结果 没有数据</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>OrdersArchive</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p>/*************************************************************************</p><p>运用滑动窗口机制,把分区表Orders 分区数据迁移入OrdersArchive</p><p>窗口滑动的步骤:</p><p>1. 在OrdersArchive 分区表增加一个空闲分区</p><p>2. 移动Orders 一个分区到相应的OrdersArchive 分区</p><p>3. 删除Orders 中的空闲分区</p><p> </p><p>移动订单日期为1996 年的分区数据</p><p>**************************************************************************/</p><p>-- 为OrderArchive 分区表的新增分区指定存放位置</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive <span style="color: blue;">NEXT</span> USED [PRIMARY]</p><p><span style="color: blue;">GO</span></p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>/***************************************************************************</p><p>在Split之前OrdersArchive 的分区情况</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                     &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p>-- 在OrderArchive 新增一个分区(用来存放1997 年数据)</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange<span style="color: gray;">()</span></p><p>SPLIT <span style="color: blue;">RANGE</span><span style="color: gray;">(</span><span style="color: red;">'1998-01-01'</span><span style="color: gray;">)</span></p><p>GO</p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>/***************************************************************************</p><p>在Split之后OrdersArchive 的分区情况</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p> </p><p>-- 移动Orders 1996 年数据到OrderArchive</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 2 <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">PARTITION</span> 2</p><p><span style="color: blue;">GO</span></p><p>/***************************************************************************</p><p>查询源分区表结果1996年位于分区 已经被Switch 到OrderArchive的分区了</p><p>所以不会再有分区的数据</p><p>3    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>4    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p>/***************************************************************************</p><p>查询存档表结果 2分区存储了年的数据是从Orders 表的分区Switch 过来的</p><p>2    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>OrdersArchive</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>/***************************************************************************</p><p>在Switch后OrdersArchive 的分区情况</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                     &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.Orders'</span></p><p>/***************************************************************************</p><p>在Switch后Orders 的分区情况</p><p>PF_Orders_OrderDateRange    1    NULL                                &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    5    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p> </p><p>/****************************************************************************</p><p>-- 合并Orders 空闲分区(1996 年数据)</p><p>*****************************************************************************/</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange<span style="color: gray;">()</span></p><p><span style="color: blue;">MERGE</span> <span style="color: blue;">RANGE</span><span style="color: gray;">(</span><span style="color: red;">'1996-01-01'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.Orders'</span></p><p>/****************************************************************************</p><p>-- 合并Orders 空闲分区(1996 年数据)后, Orders 分区情况</p><p>-- 之前分区相当于被合并到分区中成为新的分区</p><p>PF_Orders_OrderDateRange    1    NULL                                &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    2    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    3    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    4    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p>*****************************************************************************/</p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>/***************************************************************************</p><p>-- 合并Orders 空闲分区(1996 年数据)后, OrdersArchive 分区情况没有影响</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>/***************************************************************************</p><p>查询上面源分区表结果现在位于分区的是年的数据,因为之前的分区已经给</p><p>合并了,所以分区的边界变成了 NULL &lt; Val &lt;= 1997</p><p>2    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>3    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>OrdersArchive</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>/***************************************************************************</p><p>查询存档表结果</p><p>2    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p>/*************************************************************************</p><p>运用滑动窗口机制,把分区表Orders 分区数据迁移入OrdersArchive</p><p>窗口滑动的步骤:</p><p>1. 在OrdersArchive 分区表增加一个空闲分区</p><p>2. 移动Orders 一个分区到相应的OrdersArchive 分区</p><p>3. 删除Orders 中的空闲分区</p><p> </p><p>练习移动订单日期为1997 年的分区数据</p><p>1. 在为OrdersArchive 分区表增加一个空闲分区的步骤</p><p>   a. 为OrderArchive 分区表的新增分区指定存放位置</p><p>   b. 利用Split来分隔分区即新增了分区</p><p>**************************************************************************/</p><p>-- 步骤一:增加新的空闲分区</p><p>-- a. 指定新分区的存放位置,实则修改分区方案</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive <span style="color: blue;">NEXT</span> USED [PRIMARY]</p><p>GO</p><p>-- b. 新增分区,现在最大的已知的分区键列值是</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange<span style="color: gray;">()</span></p><p>SPLIT <span style="color: blue;">RANGE</span><span style="color: gray;">(</span><span style="color: red;">'1999-01-01'</span><span style="color: gray;">)</span></p><p> </p><p>-- 步骤二:移动Orders 一个分区到相应的OrdersArchive 分区</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 2 <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">PARTITION</span> 3</p><p> </p><p>-- 步骤三：删除Orders 中的空闲分区</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange<span style="color: gray;">()</span></p><p><span style="color: blue;">MERGE</span> <span style="color: blue;">RANGE</span><span style="color: gray;">(</span><span style="color: red;">'1997-01-01'</span><span style="color: gray;">)</span></p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.Orders'</span></p><p>/****************************************************************************</p><p>PF_Orders_OrderDateRange    1    NULL                                &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    2    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    3    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p>*****************************************************************************/</p><p> </p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range<span style="color: blue;"> </span><span style="color: red;">'dbo.OrdersArchive'</span></p><p>/***************************************************************************</p><p>PF_OrdersArchive_OrderDateRange    1    NULL                                &lt;= val &lt;    1996-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    2    1996-01-01 00:00:00.000    &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    3    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    4    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_OrdersArchive_OrderDateRange    5    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p><span style="color: green;">****************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>/***************************************************************************</p><p>2    270    1998-01-01 00:00:00.000  &amp;

                                                            </p></p></div>]
</body>
</html>
