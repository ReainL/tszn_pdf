
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>本文是自己以前学习表分区的笔记，所有代码均可直接拷贝通过看注释理解整个分区的操作过程，希望对大家有帮助。</p><p>/***************************************************************</p><h2 id="articleHeader2">BIWORK 分区表阅读与实践笔记</h2><p>Note: 示例中使用到了SQL Server 2000的 Demo Database, 可以从此链接中下载 </p><p><span style="color: rgb(0, 128, 0);"><a href="http://www.microsoft.com/en-us/download/confirmation.aspx?id=23654"><u><font color="#0066cc">http://www.microsoft.com/en-us/download/confirmation.aspx?id=23654</font></u></a></span></p><p>在检查删除Partition Function 以及Partition Scheme 时,要注意</p><p>Partition Scheme 引用了Partition Function, 所有需要先删除</p><p>Partition Scheme. 同理,引用了Partition Scheme 的表应该先删除掉.</p><p>引用关系: TABLE -&gt; PARTITION SCHEME -&gt; PARTITION FUNCTION</p><p>***************************************************************/</p><p><span style="color: blue;">IF</span> <span style="color: fuchsia;">OBJECT_ID</span><span style="color: gray;">(</span><span style="color: red;">'dbo.Orders'</span><span style="color: gray;">)IS</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">TABLE</span> Orders</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_schemes</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PS_Orders'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> SCHEME PS_Orders</p><p>GO</p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_functions</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PF_Orders_OrderDateRange'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange</p><p>GO</p><p>/***************************************************************</p><p>如果在不需要对数据库进行物理分组的情况下,比如分区表还是享用同</p><p>一个文件组,那么应该可以从创建分区函数开始</p><h3 id="articleHeader3">创建分区函数</h3><p>*** 确定分区键列的类型(DATETIME)以及分区的边界值:</p><p>   (''1997-01-01','1998-01-01','1999-01-01'')</p><p>*** N个边界值确定N+1 个分区</p><p>*** RIGHT - 第一个分区的所有值都小于VAL &lt; 1997-01-1</p><p>            第二个分区的值范围是1997-01-01 &lt;= VAL &lt; 1998-01-01</p><p>***************************************************************/</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_Orders_OrderDateRange<span style="color: gray;">(</span><span style="color: blue;">DATETIME</span><span style="color: gray;">)</span></p><p>AS</p><p><span style="color: blue;">RANGE</span> <span style="color: gray;">RIGHT</span> <span style="color: blue;">FOR</span> <span style="color: blue;">VALUES</span></p><p>(</p><p>   <span style="color: red;">'1997-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1998-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1999-01-01'</span></p><p>)</p><p>GO</p><p><span style="color: blue;">EXEC</span> dbo<span style="color: gray;">.</span>sp_show_partition_range</p><p><span style="color: blue;">     </span>@partition_function <span style="color: gray;">=</span> <span style="color: red;">'PF_Orders_OrderDateRange'</span></p><p>/***************************************************************</p><p>显示分区函数的分区情况,PARTITION FUNCTION,PARTITION,MinVal,VALUE,MaxVal </p><p>PF_Orders_OrderDateRange    1    NULL                                   &lt;= val &lt;    1997-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    2    1997-01-01 00:00:00.000    &lt;= val &lt;    1998-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    3    1998-01-01 00:00:00.000    &lt;= val &lt;    1999-01-01 00:00:00.000</p><p>PF_Orders_OrderDateRange    4    1999-01-01 00:00:00.000    &lt;= val &lt;    NULL</p><p>****************************************************************/</p><p> </p><p>/***************************************************************</p><h3 id="articleHeader4">创建了分区函数后，便可以创建分区方案</h3><p>*** 因为在上一个分区函数中有个边界值,4个分区,并且并没有其它的</p><p>    数据库文件组,所以当分区方案应用到具体的分区函数时所有的分区</p><p>    都是指向PRIMARY 文件组</p><p>***************************************************************/</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> SCHEME PS_Orders</p><p>AS</p><p><span style="color: blue;">PARTITION</span> PF_Orders_OrderDateRange</p><p><span style="color: blue;">TO </span><span style="color: gray;">(</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">)</span></p><p>GO</p><p> </p><p>/***************************************************************</p><h3 id="articleHeader5">创建分区表时要应用分区方案，并提供具体的分区键列</h3><p>ON 分区函数(分区键列)</p><p>****************************************************************/</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders</p><p>(</p><p>   OrderID     <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   CustomerID  <span style="color: blue;">VARCHAR</span><span style="color: gray;">(</span>10<span style="color: gray;">)</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   EmployeeID  <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   OrderDate   <span style="color: blue;">DATETIME</span>    <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p>)</p><p><span style="color: blue;">ON</span> PS_Orders<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p> </p><p>/******************************************************************</p><h3 id="articleHeader6">在创建分区表后，需要创建聚集分区索引</h3><p>*** 根据订单表Orders 查询时经常使用OrderDate 范围条件来查询的特点,</p><p>*** 我们最好在Orders.OrderDate 列上建立聚集索引（clustered index）.</p><p>*** 为了便于进行分区切换（partition swtich)</p><p>    大多数情况下,建议在分区表上建立分区索引。</p><p><span style="color: green;">*******************************************************************/</span></p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">CLUSTERED</span> <span style="color: blue;">INDEX</span> IXC_Orders_OrderDate <span style="color: blue;">ON</span> dbo<span style="color: gray;">.</span>Orders<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p>/*******************************************************************</p><h3 id="articleHeader7">为分区表创建主键</h3><p>如果主键不包含分区键列,将会出现以下错误信息:</p><p>Msg 1908, Level 16, State 1, Line 2</p><p>Column 'OrderDate' is partitioning column of the index 'PK_Orders'.</p><p>Partition columns for a unique index must be a subset of the index key.</p><p>Msg 1750, Level 16, State 0, Line 2</p><p>Could not create constraint. See previous errors.</p><p>原因:</p><p>主键实际上是个唯一索引,但分区表在建立唯一索引（分区索引）的时候,</p><p>分区列必须是唯一索引的一部分.因为SQL Server 不但要保证索引在各个</p><p>分区是唯一的,还要保证在整个表中是唯一的.</p><p><span style="color: green;">********************************************************************/</span></p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> PK_Orders</p><p><span style="color: blue;">PRIMARY</span> <span style="color: blue;">KEY</span><span style="color: gray;">(</span>OrderID<span style="color: gray;">,</span> CustomerID<span style="color: gray;">,</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p>/************************************************************************</p><p>查看分区表Orders 上的索引:</p><p>IXC_Orders_OrderDate|clustered located on PS_Orders|OrderDate</p><p>PK_Orders|nonclustered,unique,primary key located on PS_Orders|OrderID, CustomerID, OrderDate</p><p>************************************************************************/</p><p><span style="color: blue;">EXEC</span> <span style="color: maroon;">sp_helpindex</span><span style="color: blue;"> </span><span style="color: red;">'dbo.Orders'</span></p><p> </p><p>/**********************************************************************</p><h3 id="articleHeader8">从SQL Server 2000 NorthWind 导入测试数据</h3><p>***********************************************************************/</p><p><span style="color: blue;">INSERT</span> <span style="color: blue;">INTO</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">SELECT</span> OrderID<span style="color: gray;">,</span></p><p>       CustomerID<span style="color: gray;">,</span></p><p>       EmployeeID<span style="color: gray;">,</span></p><p>       OrderDate</p><p><span style="color: blue;">FROM</span> Northwind<span style="color: gray;">.</span>dbo<span style="color: gray;">.</span>Orders</p><p> </p><p>/************************************************************************</p><h3 id="articleHeader9">查看分区表各分区数据情况（数据行数，最大最小OrderDate 值）</h3><p>*************************************************************************/</p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>GO</p><p>/************************************************************************</p><p>在目前的测试数据中,并没有大于1999年的数据,所以在上面的查询结果中并没有</p><p>看到第个分区的信息: PARTITION,ROWS,MinVal,MaxVal</p><p>1    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p>2    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>3    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p>*************************************************************************/</p><p>-- 插入一条测试数据</p><p><span style="color: blue;">INSERT</span> <span style="color: blue;">INTO</span> dbo<span style="color: gray;">.</span>Orders <span style="color: blue;">VALUES</span><span style="color: gray;">(</span>11111<span style="color: gray;">,</span><span style="color: red;">'TEST'</span><span style="color: gray;">,</span>1<span style="color: gray;">,</span><span style="color: red;">'2000-10-10 10:10:10:100'</span><span style="color: gray;">)</span></p><p>-- 再次查询</p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>/************************************************************************</p><p>查询结果显示了个分区的信息</p><p>PARTITION,ROWS,MinVal,MaxVal</p><p>1    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p>2    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>3    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p>4    1        2000-10-10 10:10:10.100    2000-10-10 10:10:10.100</p><p>*************************************************************************/</p><p>GO</p><h2 id="articleHeader10">切换分区表的一个分区到普通数据表</h2><p>/*************************************************************************</p><p>************* 切换分区表的一个分区到普通数据表***************************</p><p><span style="color: green;">************* Partition to Table ****************************************/</span></p><p>/*************************************************************************</p><p>1. 首先建立普通数据表Orders_1998，该表用来存放订单日期为1998 年的所有数据</p><p>2. 分区到普通表的切换，最好满足以下的前提条件:</p><p>   a. 普通表必须建立在分区表切换分区所在的文件组上ON [PRIMARY]</p><p>   b. 普通表的表结构跟分区表的一致</p><p>   c. 普通表上的索引要跟分区表一致(聚集索引,非聚集索引)</p><p>   d. 普通表必须是空表，不能有任何数据</p><p><span style="color: green;">*************************************************************************/</span></p><p><span style="color: blue;">IF</span> <span style="color: fuchsia;">OBJECT_ID</span><span style="color: gray;">(</span><span style="color: red;">'Orders_1998'</span><span style="color: gray;">)</span> <span style="color: gray;">IS</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">TABLE</span> Orders_1998</p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998</p><p>(</p><p>   OrderID     <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   CustomerID  <span style="color: blue;">VARCHAR</span><span style="color: gray;">(</span>10<span style="color: gray;">)</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   EmployeeID  <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   OrderDate   <span style="color: blue;">DATETIME</span>    <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: gray;">)</span><span style="color: blue;">ON</span> [PRIMARY]</p><p>GO</p><p> </p><p>-- 添加聚集索引,和分区表一致</p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">CLUSTERED</span> <span style="color: blue;">INDEX</span> IXC_Orders1998_OrderDate <span style="color: blue;">ON</span> dbo<span style="color: gray;">.</span>Orders_1998<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p> </p><p>-- 添加主键,和分区表一致</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998 <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> PK_Orders_1998</p><p><span style="color: blue;">PRIMARY</span> <span style="color: blue;">KEY</span><span style="color: gray;">(</span>OrderID<span style="color: gray;">,</span>CustomerID<span style="color: gray;">,</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p><br/></p><p>/***************************************************************************</p><p>** 开始切换分区表Orders 第三个分区的数据(1998年的数据)到普通表Orders_1998</p><p>** 关键字- SWITCH PARTITION [NUMBER] TO [History Table]</p><p>***************************************************************************/</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 3 <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>Orders_1998</p><p> </p><p>/***************************************************************************</p><p>查询源分区表结果</p><p>分区号为的数据已经没有了</p><p>1    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p>2    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>4    1        2000-10-10 10:10:10.100    2000-10-10 10:10:10.100</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p>/***************************************************************************</p><p>查询存档表结果</p><p>3    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders_1998</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><h2 id="articleHeader11">切换普通表数据到分区表的一个分区中</h2><p>/************************************************************************</p><p>*************  切换普通表数据到分区表的一个分区中  *********************</p><p><span style="color: green;">*************    Table to Partition             ************************/</span> </p><p> </p><p>/*************************************************************************</p><p>上面我们已经把分区表Orders 第三个分区的数据切换到普通表Orders_1998 中了,</p><p>现在我们再切换回来:</p><p>**************************************************************************/</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998 SWITCH <span style="color: blue;">PARTITION</span> 3 <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>Orders</p><p>/*************************************************************************</p><p>错误信息:</p><p>Msg 4911, Level 16, State 2, Line 1</p><p>Cannot specify a partitioned table without partition number in ALTER TABLE</p><p>SWITCH statement. The table 'SSISDemoDB.dbo.Orders' is partitioned.</p><p>原因:</p><p>实际上应该是将dbo.Orders_1998 表中的数据SWITCH 到dbo.Orders 表的</p><p>Partition 分区中.</p><p>而不能说是将dbo.Orders_1998 的分区的数据SWITCH 到dbo.Orders 全表中</p><p>**************************************************************************/</p><p> </p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998 SWITCH <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>Orders <span style="color: blue;">PARTITION</span> 3</p><p>/*************************************************************************</p><p>错误信息:</p><p>Msg 4982, Level 16, State 1, Line 1</p><p>ALTER TABLE SWITCH statement failed. Check constraints of source table</p><p>'dbo.Orders_1998' allow values that are not allowed by range defined by</p><p>partition 3 on target table 'dbo.Orders'.</p><p> </p><p>原因:</p><p>表dbo.Orders 的数据经过分区函数的分区列定义, 各个分区的数据实际上已经经过</p><p>了数据约束检查,符合分区边界范围(Range)的数据才会录入到各个分区中.</p><p>但是在历史表/存档表dbo.Orders_1998中的数据实际上是没有边界约束的,比如完全</p><p>可以手动的插入一条年的数据,这样一来在进行SWITCH时肯定是不会成功的.</p><p>所以在SWITCH时,先进行了约束性检查,尽管没有不符合规范的数据,但是有潜在的威胁.</p><p> </p><p>所以在SWITCH之前,先为dbo.Orders_1998添加一个检查约束,并再次SWITCH,成功！</p><p>**************************************************************************/</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998 <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> CK_Orders1998_OrderDate</p><p><span style="color: blue;">CHECK</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">&gt;=</span><span style="color: red;">'1998-01-01'</span> <span style="color: gray;">AND</span> OrderDate<span style="color: gray;">&lt;</span><span style="color: red;">'1999-01-01'</span><span style="color: gray;">)</span></p><p> </p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders_1998 SWITCH <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>Orders <span style="color: blue;">PARTITION</span> 3 </p><p> </p><p>/***************************************************************************</p><p>查询源分区表结果,分区的数据已经从dbo.Orders_1998 回来了</p><p>1    152    1996-07-04 00:00:00.000    1996-12-31 00:00:00.000</p><p>2    408    1997-01-01 00:00:00.000    1997-12-31 00:00:00.000</p><p>3    270    1998-01-01 00:00:00.000    1998-05-06 00:00:00.000</p><p>4    1        2000-10-10 10:10:10.100    2000-10-10 10:10:10.100</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p> </p><p>/***************************************************************************</p><p>查询存档表结果,没有任何数据,已经成功SWITCH to Orders 表的PARTITION 3</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders_1998</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><p>/****************************************************************************</p><p>所以在进行存档表的数据向分区表迁移过程中(TABLE TO PARTITION),</p><p>相比(PARTITION TO TABLE)多一个条件:</p><p>普通表必须加上和分区数据范围一致的约束条件.</p><p>*****************************************************************************/</p><h2 id="articleHeader12">切换分区表数据到分区表</h2><p>/************************************************************************</p><p>*************  切换分区表数据到分区表   ********************************</p><p>*************    PARTITION TO PARTITION  **********************************/</p><p> </p><p>/*************************************************************************</p><p>-- 新的存档分区表在结构上和源分区表是一致的,包括分区函数和分区方案,</p><p>但是需要重新创建,不能简单地直接使用dbo.Orders 表上的分区函数和分区方案,</p><p>因为他们之间有绑定关系. </p><p>**************************************************************************/</p><p><span style="color: blue;">IF</span> <span style="color: fuchsia;">OBJECT_ID</span><span style="color: gray;">(</span><span style="color: red;">'OrdersArchive'</span><span style="color: gray;">)</span> <span style="color: gray;">IS</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">TABLE</span> OrdersArchive</p><p><span style="color: blue;">GO</span></p><p> </p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_schemes</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PS_OrdersArchive'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive</p><p>GO</p><p> </p><p><span style="color: blue;">IF</span> <span style="color: gray;">EXISTS</span><span style="color: blue;"> </span><span style="color: gray;">(</span><span style="color: blue;">SELECT</span> <span style="color: gray;">*</span> <span style="color: blue;">FROM</span> <span style="color: green;">sys</span><span style="color: gray;">.</span><span style="color: green;">partition_functions</span> <span style="color: blue;">WHERE</span> name <span style="color: gray;">=</span> <span style="color: red;">'PF_OrdersArchive_OrderDateRange'</span><span style="color: gray;">)</span></p><p><span style="color: blue;">DROP</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange</p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> <span style="color: blue;">FUNCTION</span> PF_OrdersArchive_OrderDateRange<span style="color: gray;">(</span><span style="color: blue;">DATETIME</span><span style="color: gray;">)</span></p><p>AS</p><p><span style="color: blue;">RANGE</span> <span style="color: gray;">RIGHT</span> <span style="color: blue;">FOR</span> <span style="color: blue;">VALUES</span></p><p>(</p><p>   <span style="color: red;">'1997-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1998-01-01'</span><span style="color: gray;">,</span></p><p>   <span style="color: red;">'1999-01-01'</span></p><p>)</p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">PARTITION</span> SCHEME PS_OrdersArchive</p><p>AS</p><p>-- 分区Scheme和分区函数绑定了</p><p><span style="color: blue;">PARTITION</span> PF_OrdersArchive_OrderDateRange</p><p><span style="color: blue;">TO </span><span style="color: gray;">(</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">,</span>[primary]<span style="color: gray;">)</span></p><p>GO</p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>OrdersArchive</p><p>(</p><p>   OrderID     <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   CustomerID  <span style="color: blue;">VARCHAR</span><span style="color: gray;">(</span>10<span style="color: gray;">)</span> <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   EmployeeID  <span style="color: blue;">INT</span>         <span style="color: gray;">NOT</span> <span style="color: gray;">NULL,</span></p><p>   OrderDate   <span style="color: blue;">DATETIME</span>    <span style="color: gray;">NOT</span> <span style="color: gray;">NULL</span></p><p>)</p><p>-- 表和分区Scheme绑定了</p><p><span style="color: blue;">ON</span> PS_OrdersArchive<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">GO</span></p><p> </p><p><span style="color: blue;">CREATE</span> <span style="color: blue;">CLUSTERED</span> <span style="color: blue;">INDEX</span> IXC_OrdersArchive_OrderDate <span style="color: blue;">ON</span> dbo<span style="color: gray;">.</span>OrdersArchive<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p> </p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">ADD</span> <span style="color: blue;">CONSTRAINT</span> PK_OrdersArchive</p><p><span style="color: blue;">PRIMARY</span> <span style="color: blue;">KEY</span><span style="color: gray;">(</span>OrderID<span style="color: gray;">,</span> CustomerID<span style="color: gray;">,</span>OrderDate<span style="color: gray;">)</span></p><p>GO</p><p> </p><p>/*********************************************************************************</p><p>开始切换分区</p><p>**********************************************************************************/</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 1  <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">PARTITION</span> 1</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 2  <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">PARTITION</span> 2</p><p><span style="color: blue;">ALTER</span> <span style="color: blue;">TABLE</span> dbo<span style="color: gray;">.</span>Orders SWITCH <span style="color: blue;">PARTITION</span> 3  <span style="color: blue;">TO</span> dbo<span style="color: gray;">.</span>OrdersArchive <span style="color: blue;">PARTITION</span> 3</p><p>/***************************************************************************</p><p>查询源分区表结果,只会有分区的数据</p><p>4    1    2000-10-10 10:10:10.100    2000-10-10 10:10:10.100</p><p><span style="color: green;">***************************************************************************/</span></p><p><span style="color: blue;">SELECT</span> <span style="color: blue;">PARTITION</span> <span style="color: gray;">=</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       <span style="color: blue;">ROWS</span>      <span style="color: gray;">=</span> <span style="color: fuchsia;">COUNT</span><span style="color: gray;">(*),</span></p><p>       MinVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MIN</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">),</span></p><p>       MaxVal    <span style="color: gray;">=</span> <span style="color: fuchsia;">MAX</span><span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">FROM</span> dbo<span style="color: gray;">.</span>Orders</p><p><span style="color: blue;">GROUP</span> <span style="color: blue;">BY</span> <span style="color: fuchsia;">$PARTITION</span><span style="color: gray;">.</span>PF_Orders_OrderDateRange<span style="color: gray;">(</span>OrderDate<span style="color: gray;">)</span></p><p><span style="color: blue;">ORDER</span> <span style="color: blue;">BY</span> <span style="color: blue;">PARTITION</span></p><h2 id="articleHeader13">总结</h2><p>/***************************************************************************</p><p>总结: 分区表分区切换并没有真正去移动数据,而是SQL Server 在系统底层改变了表</p><p>的元数据。因此分区表分区切换是高效,快速,灵活的.利用分区表的分区切换功能,</p><p>我们可以快速加载数据到分区表.卸载分区数据到普通表,然后TRUNCATE 普通表,</p><p>以实现快速删除分区表数据,快速归档不活跃数据到历史表。</p><p>****************************************************************************/</p>
</div>]
</body>
</html>
