
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1"><span style="color: rgb(0, 0, 0);">开篇介绍</span></h2><p><span style="color: rgb(0, 0, 0);"><span style="color: rgb(0, 0, 0);"><img alt="" height="362" src="http://images.cnitblog.com/blog/477275/201308/06211405-e898eb106bd14fa4a414dc8d361f4b7b.jpg" width="285"/></span></span></p><p><span style="color: rgb(0, 0, 0);">SQL Server 窗体函数主要用来处理由 OVER 子句定义的行集, 主要用来分析和处理</span></p><ul><li><span style="color: rgb(0, 0, 0);">Running totals</span></li><li><span style="color: rgb(0, 0, 0);">Moving averages</span></li><li><span style="color: rgb(0, 0, 0);">Gaps and islands</span></li></ul><h2 id="articleHeader2">初步了解 OVER 关键字</h2><p>先看一个简单的应用 - 按照订单额从高到低对订单表信息做一个排名。</p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">USE</span><span style="color: rgb(0, 0, 0);"> TSQL2012<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> orderid,<br/>
       orderdate,<br/>
       val,<br/>
       RANK() </span><span style="color: rgb(0, 0, 255);">OVER</span>(<span style="color: rgb(0, 0, 255);">ORDER</span> <span style="color: rgb(0, 0, 255);">BY</span> val <span style="color: rgb(0, 0, 255);">DESC</span>) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> rnk<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
</span><span style="color: rgb(0, 0, 255);">ORDER</span> <span style="color: rgb(0, 0, 255);">BY</span> rnk    </span></span></code></pre><p>查询结果 -</p><p><span style="color: rgb(0, 0, 0);">OrderID OrderDate　　　　　　       Val　　　　Rnk</span></p><p><span style="color: rgb(0, 0, 0);">10865    2008-02-02 00:00:00.000    16387.50    1</span></p><p><span style="color: rgb(0, 0, 0);">10981    2008-03-27 00:00:00.000    15810.00    2</span></p><p><span style="color: rgb(0, 0, 0);">11030    2008-04-17 00:00:00.000    12615.05    3</span></p><p><span style="color: rgb(0, 0, 0);">10889    2008-02-16 00:00:00.000    11380.00    4</span></p><p><span style="color: rgb(0, 0, 0);">10417    2007-01-16 00:00:00.000    11188.40    5</span></p><p><span style="color: rgb(0, 0, 0);">10817    2008-01-06 00:00:00.000    10952.85    6</span></p><p><span style="color: rgb(0, 0, 0);">10897    2008-02-19 00:00:00.000    10835.24    7</span></p><p><span style="color: rgb(0, 0, 0);">10479    2007-03-19 00:00:00.000    10495.60    8</span></p><h3 id="articleHeader3"><strong>OVER 的作用</strong></h3><p><span style="color: rgb(0, 0, 0);">OVER 的作用就是定义了行集窗体，这个窗体的集合为当前行提供了一个上下文环境。RANK 函数根据指定的集合以及行集的排序顺序计算出当前行的排名，以 Rnk = 5 为例，排序后这条数据的前面有4条数据，所以它的排名就是 4 + 1 = 5。</span></p><p><span style="color: rgb(0, 0, 0);">再总结简单一点就是：OVER 定义了一个行的集合，它是一个函数，每次向当前行返回一个唯一的值。如何返回? 在这个例子中就使用 RANK 函数返回了当前行的一个排名。</span></p><h3 id="articleHeader4"><strong>与OVER搭配使用的其它函数</strong></h3><p><span style="color: rgb(0, 0, 0);">聚合的函数 - SUM, COUNT, MIN, MAX</span></p><p><span style="color: rgb(0, 0, 0);">排名的函数 - RANK， DENSE_RANK, ROW_NUMBER, NTILE</span></p><p><span style="color: rgb(0, 0, 0);">Distribution 函数 - PERCENT_RANK, CUME_DIST, PERCENTILE_CONT, PERCENTILE_DISC</span></p><p><span style="color: rgb(0, 0, 0);">Offset 函数  - LAG, LEAD, FIRST_VALUE, LAST_VALUE</span></p><h2 id="articleHeader5">SQL Server Window Function 的应用</h2><p><span style="color: rgb(0, 0, 0);">窗体函数的应用非常广泛 - 像分页、去重、分组的基础上返回 Top N 的行、计算 Running Totals、Gaps and islands、百分率, Hierarchy 排序、Pivoting 等等。</span></p><p><span style="color: rgb(0, 0, 0);">使用 Windows 窗体函数的原因一方面是因为 SQL Server 的优化器不够完美，尽管足够强大，但是并不会涵盖所有的优化规则。</span></p><p><span style="color: rgb(0, 0, 0);">第二, 在执行计划的选择上，SQL Server 并不会真正执行所有有可能的计划来获取一个最优的选择，对于 SQL 本身这种指令性语言的解析和优化优化器只能说是在最短时间里尽量做到足够好，选择一个好的执行计划。而 Window 窗体函数本身就经历过了很好的调优处理，所以性能会更加好一些。</span></p><h3 id="articleHeader6"><span style="color: rgb(0, 0, 0);">集的整体与顺序的概念</span></h3><p><span style="color: rgb(0, 0, 0);">对于集的理解，两个方面“整体”与“排序。把集当作一个整体来看，不要关心集中的某一条数据，排序、集是没有顺序的。相对于迭代性的像游标操作，首先遍历的是一条一条的数据，其次是基于一定的顺序的情况下来执行遍历操作的。迭代行的思考方式就是一次一条，有某种顺序，而窗体函数思考方式是整体的，无序的。</span></p><h3 id="articleHeader7">用迭代方式来解释窗体函数工作的过程</h3><ul><li><span style="color: rgb(0, 0, 0);">首先通过 OVER 定义了一个根据 val 排序的集。</span></li><li><span style="color: rgb(0, 0, 0);">遍历查询中的每一行时, 用当前遍历到的行到这个集中从头开始去比较。</span></li><li><span style="color: rgb(0, 0, 0);">如果当前行是这个集中的第一行</span><span style="color: rgb(0, 0, 0);">, </span><span style="color: rgb(0, 0, 0);">那么就返回一个</span><span style="color: rgb(0, 0, 0);">1。</span></li><li>如果当前行的 val 等于这个集中之前的某一个val的值，就返回找到的排名。</li><li>否则就返回在之后找到的这个排名。</li></ul><p>但是实际上并不是这样来工作的，实际上窗体函数逻辑性的为 SELECT 查询结果中的每一行都创建了一个独立的窗体环境，默认没有任何限制和规则的窗体。在这个例子中，只是定义了一个排序规则，每一行对应的窗体都由 SELECT 查询结果集的所有行组成，并且所有窗体此时也都共存.对于查询中的每一行, RANK()的计算就是去当前行关联的窗体中找出比当前行 val 值大的集中所有行的条数然后加1。</p><p><span style="color: rgb(0, 0, 0);">我的疑惑是如果为每一行都创建一个窗体环境，那需要多大的开销啊？</span></p><h3 id="articleHeader8"><span style="color: rgb(0, 0, 0);"></span>使用窗体函数 (Window Function) 与 Group, 子查询语句的比较 </h3><p><font color="#e33737">对于Group来说，SELECT语句中的列必须是Group子句中出现的列或者是聚合列，那么如果需要同时在 SELECT 语句中查询其它的非 Group 或者非聚合列, 那么就需要额外的子查询。</font></p><p>可以非常直观的通过几个例子来比较使用窗体函数和 Group, 子查询解决实际问题的难易程度。</p><p><span style="color: rgb(0, 0, 0);">比如要查询每个客户的每个订单的值，以及这个订单于这个订单客户的所有订单总和比，</span><span style="color: rgb(0, 0, 0);">以及这个订单与这个客户所有订单平均值的差。</span></p><p>分析以下代码，发现没有办法直接在一个 SELECT 语句中完成查询。</p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> custid,<br/>
            orderid,<br/>
            val <br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
</span><span style="color: rgb(0, 0, 255);">ORDER</span> <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> custid,<br/>
                orderid<br/>
<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> custid,<br/>
            </span><span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> TotalVal,<br/>
            </span><span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> AvgVal<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
</span><span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span> custid </span></span></code></pre><p><span style="color: rgb(0, 0, 0);">这里不得不使用关联两个查询，因为没有办法在一个Group查询中同时显示 Detail和汇总的信息，</span><span style="color: rgb(0, 0, 0);">Order 是细节，Val 总和和平均值是基于 Customer ID 的汇总。</span></p><p><span style="color: rgb(0, 0, 0);">查询如下 -</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">WITH</span> Aggregates <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"><br/>
(<br/>
   </span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> custid,<br/>
               </span><span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> sumval,<br/>
               </span><span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> avgval<br/>
   </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
   </span><span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> custid<br/>
)<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> O.orderid,<br/>
            O.custid,<br/>
            O.val,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>. <span style="color: rgb(128, 128, 128);">*</span> O.val <span style="color: rgb(128, 128, 128);">/</span> A.sumval <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctcust,<br/>
            O.val </span><span style="color: rgb(128, 128, 128);">-</span> A.avgval <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffcust<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O<br/>
</span><span style="color: rgb(128, 128, 128);">JOIN</span> Aggregates <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> A<br/>
</span><span style="color: rgb(0, 0, 255);">ON</span> O.custid <span style="color: rgb(128, 128, 128);">=</span> A.custid;</span></span></code></pre><p>结果显示如下</p><p>/**---------------------------------------------------------</p><p>10835    1    845.80    19.79    133.633334</p><p>10952    1    471.20    11.03    -240.966666</p><p>10643    1    814.50    19.06    102.333334</p><p>10692    1    878.00    20.55    165.833334</p><p>11011    1    933.50    21.85    221.333334</p><p>10702    1    330.00    7.72    -382.166666</p><p>10625    2    479.75    34.20    129.012500</p><p>10759    2    320.00    22.81    -30.737500</p><p>10308    2    88.80    6.33    -261.937500</p><p>10926    2    514.40    36.67    163.662500</p><p>--------------------------------------------------------------**/</p><p><span style="color: rgb(0, 0, 0);">但如果这时再加一个比 - 单个订单与总订单额/平均额比，这时汇总的级别又不相同了， 需要单独再汇总一次。</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">WITH</span> CustAggregates <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"><br/>
(<br/>
    </span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> custid,<br/>
                </span><span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> sumval,<br/>
                </span><span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> avgval<br/>
    </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
    </span><span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> custid<br/>
),<br/>
GrandAggregates </span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"><br/>
(<br/>
     </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> sumval,<br/>
                 </span><span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> avgval<br/>
     </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
)<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> O.orderid,<br/>
            O.custid,<br/>
            O.val,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>. <span style="color: rgb(128, 128, 128);">*</span> O.val <span style="color: rgb(128, 128, 128);">/</span> CA.sumval <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctcust,<br/>
            O.val </span><span style="color: rgb(128, 128, 128);">-</span> CA.avgval <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffcust,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>. <span style="color: rgb(128, 128, 128);">*</span> O.val <span style="color: rgb(128, 128, 128);">/</span> GA.sumval <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctall,<br/>
            O.val </span><span style="color: rgb(128, 128, 128);">-</span> GA.avgval <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffall<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O<br/>
</span><span style="color: rgb(128, 128, 128);">JOIN</span> CustAggregates <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> CA<br/>
</span><span style="color: rgb(0, 0, 255);">ON</span> O.custid <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> CA.custid<br/>
</span><span style="color: rgb(0, 0, 255);">CROSS</span> <span style="color: rgb(128, 128, 128);">JOIN</span> GrandAggregates <span style="color: rgb(0, 0, 255);">AS</span> GA;</span></span></code></pre><p>查询结果</p><p>/**--------------------------------------------------------------</p><p>10835    1    845.80    19.79    133.633334    0.07    -679.252072</p><p>10952    1    471.20    11.03    -240.966666    0.04    -1053.852072</p><p>10643    1    814.50    19.06    102.333334    0.06    -710.552072</p><p>10692    1    878.00    20.55    165.833334    0.07    -647.052072</p><p>11011    1    933.50    21.85    221.333334    0.07    -591.552072</p><p>10702    1    330.00    7.72    -382.166666    0.03    -1195.052072</p><p>10625    2    479.75    34.20    129.012500    0.04    -1045.302072</p><p>10759    2    320.00    22.81    -30.737500    0.03    -1205.052072</p><p>10308    2    88.80    6.33    -261.937500    0.01    -1436.252072</p><p>----------------------------------------------------------------**/</p><p><span style="color: rgb(0, 0, 0);">如果提出更多的聚合和比较，查询语句会越来越复杂，并且查询优化器也不能确定每次是否都访问的是同一个数据集，因此需要分别访问数据集，造成性能下降。</span></p><p>通过使用窗体函数可以很容易解决这些问题，因为可以为每一种聚合定义一个窗体上下文。</p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 0);">SELECT orderid,<br/>
            custid,<br/>
            val,<br/>
            CAST(</span><span style="color: rgb(128, 0, 128);">100</span>.* val/ SUM(val) OVER(PARTITION BY custid) AS NUMERIC(<span style="color: rgb(128, 0, 128);">5</span>,<span style="color: rgb(128, 0, 128);">2</span><span style="color: rgb(0, 0, 0);">)) AS pctcut,<br/>
            val </span>-<span style="color: rgb(0, 0, 0);"> AVG(val) OVER(PARTITION BY custid) AS diffcust,<br/>
            CAST(</span><span style="color: rgb(128, 0, 128);">100</span>.* val/ SUM(val) OVER() AS NUMERIC(<span style="color: rgb(128, 0, 128);">5</span>,<span style="color: rgb(128, 0, 128);">2</span><span style="color: rgb(0, 0, 0);">)) AS pctall,<br/>
            val </span>-<span style="color: rgb(0, 0, 0);"> AVG(val) OVER() AS diffall<br/>
FROM Sales.OrderValues</span></span></span></code></pre><p>窗体函数中的窗体初始状态是 SELECT 后的查询结果集，在子查询中可能要过滤很多条件，因为各个子查询各自独立，各自基于一个查询来过滤，但是通过窗体函数只需要在 SELECT 的集合中限制一遍就可以了。</p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> orderid,<br/>
            custid,<br/>
            val,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>. <span style="color: rgb(128, 128, 128);">*</span> val <span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(0, 0, 0);"><br/>
                             (<br/>
                                 </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">SUM</span><span style="color: rgb(0, 0, 0);">(O2.val)<br/>
                                 </span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O2<br/>
                                 </span><span style="color: rgb(0, 0, 255);">WHERE</span> O2.custid <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> O1.custid<br/>
                                 </span><span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
                                 <span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"><br/>
                              ) </span><span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctcust,<br/>
             val </span><span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(0, 0, 0);"> (<br/>
                          </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">AVG</span><span style="color: rgb(0, 0, 0);">(O2.val)<br/>
                          </span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O2<br/>
                          </span><span style="color: rgb(0, 0, 255);">WHERE</span> O2.custid <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> O1.custid<br/>
                          </span><span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
                          <span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffcust,<br/>
             </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>. <span style="color: rgb(128, 128, 128);">*</span> val <span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(0, 0, 0);"><br/>
                            (<br/>
                                </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">SUM</span><span style="color: rgb(0, 0, 0);">(O2.val)<br/>
                                </span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O2<br/>
                                </span><span style="color: rgb(0, 0, 255);">WHERE</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
                                <span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>))     <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctall,<br/>
              val </span><span style="color: rgb(128, 128, 128);">-</span> (   <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">AVG</span><span style="color: rgb(0, 0, 0);">(O2.val)<br/>
                          </span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O2<br/>
                          </span><span style="color: rgb(0, 0, 255);">WHERE</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
                          <span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffall<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> Sales.OrderValues <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> O1<br/>
</span><span style="color: rgb(0, 0, 255);">WHERE</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span>;</span></span></code></pre><p><span style="color: rgb(0, 0, 0);">这里的 WHERE 条件保证了在这个查询中应用的窗体就已经是介于20070101 ~ 20080101 之间的行集。</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> orderid,<br/>
            custid,<br/>
            val,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>.<span style="color: rgb(128, 128, 128);">*</span> val<span style="color: rgb(128, 128, 128);">/</span> <span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">OVER</span>(PARTITION <span style="color: rgb(0, 0, 255);">BY</span> custid) <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctcut,<br/>
            val </span><span style="color: rgb(128, 128, 128);">-</span> <span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">OVER</span>(PARTITION <span style="color: rgb(0, 0, 255);">BY</span> custid) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffcust,<br/>
            </span><span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span>.<span style="color: rgb(128, 128, 128);">*</span> val<span style="color: rgb(128, 128, 128);">/</span> <span style="color: rgb(255, 0, 255);">SUM</span>(val) <span style="color: rgb(0, 0, 255);">OVER</span>() <span style="color: rgb(0, 0, 255);">AS</span> NUMERIC(<span style="color: rgb(128, 0, 0); font-weight: bold;">5</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> pctall,<br/>
            val </span><span style="color: rgb(128, 128, 128);">-</span> <span style="color: rgb(255, 0, 255);">AVG</span>(val) <span style="color: rgb(0, 0, 255);">OVER</span>() <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> diffall<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> Sales.OrderValues<br/>
</span><span style="color: rgb(0, 0, 255);">WHERE</span> orderdate <span style="color: rgb(128, 128, 128);">&gt;=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20070101</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<span style="color: rgb(128, 128, 128);">AND</span> orderdate <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">20080101</span><span style="color: rgb(255, 0, 0);">'</span></span></span></code></pre><h2 id="articleHeader9"><span style="color: rgb(0, 0, 0);">Gaps and islands 的问题</span></h2><p><span style="color: rgb(0, 0, 0);">在一组可排序的值中找到连续的数据或者间隙，这个在实际的应用比较广泛，比如查询某个产品有连续下载或者购买的时段，发生的频率或者连续达到某个KPI的时段有哪些等等。</span></p><p><span style="color: rgb(0, 0, 0);">比如这个例子 -</span></p><p>用户ID        有效期起始        有效期结束</p><p>1                2012-10-01        2012-10-31</p><p>2                2012-10-01        2012-10-31</p><p>1                2012-12-01        2012-12-31</p><p>2                2012-11-01        2012-11-30        </p><p><span style="color: rgb(0, 0, 0);">合并有效期 -</span></p><p>用户ID        有效期起始        有效期结束</p><p>1                2012-10-01        2012-10-31</p><p>1                2012-12-01        2012-12-31</p><p>2                2012-10-01        2012-11-30</p><p><span style="color: rgb(0, 0, 0);">下面用一个实际的代码来说明这个过程。</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SET</span> NOCOUNT <span style="color: rgb(0, 0, 255);">ON</span><span style="color: rgb(0, 0, 0);">;<br/>
</span><span style="color: rgb(0, 0, 255);">USE</span><span style="color: rgb(0, 0, 0);"> TSQL2012;<br/>
<br/>
</span><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">dbo.T1</span><span style="color: rgb(255, 0, 0);">'</span>, <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">U</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span> <span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> dbo.T1;<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> dbo.T1<br/>
(<br/>
    col1 </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
    <span style="color: rgb(0, 0, 255);">CONSTRAINT</span> PK_T1 <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span><span style="color: rgb(0, 0, 0);"><br/>
);<br/>
<br/>
</span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span><span style="color: rgb(0, 0, 0);"> dbo.T1(col1)<br/>
</span><span style="color: rgb(0, 0, 255);">VALUES</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">2</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">3</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">11</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">12</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">13</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">27</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">33</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">34</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">35</span>),(<span style="color: rgb(128, 0, 0); font-weight: bold;">42</span><span style="color: rgb(0, 0, 0);">);<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><br/>
<span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1</span></span></code></pre><p><span style="color: rgb(0, 0, 0);">原数据查询</span></p><p><span style="color: rgb(0, 0, 0);">2</span></p><p><span style="color: rgb(0, 0, 0);">3</span></p><p><span style="color: rgb(0, 0, 0);">11</span></p><p><span style="color: rgb(0, 0, 0);">12</span></p><p><span style="color: rgb(0, 0, 0);">13</span></p><p><span style="color: rgb(0, 0, 0);">27</span></p><p><span style="color: rgb(0, 0, 0);">33</span></p><p><span style="color: rgb(0, 0, 0);">34</span></p><p><span style="color: rgb(0, 0, 0);">35</span></p><p><span style="color: rgb(0, 0, 0);">42</span></p><p>需要实现的查询结果 </p><p><span style="color: rgb(0, 0, 0);">start_range end_range</span></p><p><span style="color: rgb(0, 0, 0);">----------- -----------</span></p><p><span style="color: rgb(0, 0, 0);">2   3</span></p><p><span style="color: rgb(0, 0, 0);">11 13</span></p><p><span style="color: rgb(0, 0, 0);">27 27</span></p><p><span style="color: rgb(0, 0, 0);">33 35</span></p><p><span style="color: rgb(0, 0, 0);">42 42</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> col1,<br/>
(<br/>
   </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 在 T1 中找出比 Col1 大的并且加1后在T1中不存在的最小值</span><br/>
   <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">MIN</span><span style="color: rgb(0, 0, 0);">(B.col1)<br/>
   </span><span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> B<br/>
   </span><span style="color: rgb(0, 0, 255);">WHERE</span> B.col1 <span style="color: rgb(128, 128, 128);">&gt;=</span><span style="color: rgb(0, 0, 0);"> A.col1<br/>
   </span><span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(128, 128, 128);">EXISTS</span><span style="color: rgb(0, 0, 0);"><br/>
   (<br/>
       </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><br/>
       <span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> C<br/>
      </span><span style="color: rgb(0, 0, 255);">WHERE</span> C.col1 <span style="color: rgb(128, 128, 128);">=</span> B.col1 <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);"><br/>
   )<br/>
)<br/>
</span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> grp<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span> A;</span></span></code></pre><p><span style="color: rgb(0, 0, 0);">-- 查询结果</span></p><p>2          3</p><p>3          3</p><p>11        13</p><p>12        13</p><p>13        13</p><p>27        27</p><p>33        35</p><p>34        35</p><p>35        35</p><p>42        42</p><p><span style="color: rgb(0, 0, 0);">再分组查询</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">MIN</span>(T.col1) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> start_range,<br/>
       </span><span style="color: rgb(255, 0, 255);">MAX</span>(T.col1) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> end_range<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);">(<br/>
            </span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> col1,<br/>
                        (<br/>
                          </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 在 T1 中找出比 Col1 大的并且加1后在T1中不存在的最小值</span><br/>
                          <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">MIN</span><span style="color: rgb(0, 0, 0);">(B.col1)<br/>
                          </span><span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> B<br/>
                          </span><span style="color: rgb(0, 0, 255);">WHERE</span> B.col1 <span style="color: rgb(128, 128, 128);">&gt;=</span><span style="color: rgb(0, 0, 0);"> A.col1<br/>
                          </span><span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(128, 128, 128);">EXISTS</span><span style="color: rgb(0, 0, 0);"><br/>
                           (<br/>
                              </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(128, 128, 128);">*</span><br/>
                              <span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> C<br/>
                              </span><span style="color: rgb(0, 0, 255);">WHERE</span> C.col1 <span style="color: rgb(128, 128, 128);">=</span> B.col1 <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);"><br/>
                          )<br/>
                       ) </span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> grp<br/>
            </span><span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1 <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> A<br/>
)</span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> T<br/>
</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 分组找最大和最小值</span><br/>
<span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span> T.grp    </span></span></code></pre><p>Start_range end_range</p><p><span style="color: rgb(0, 0, 0);">2                   3</span></p><p><span style="color: rgb(0, 0, 0);">11                13</span></p><p><span style="color: rgb(0, 0, 0);">27                27</span></p><p><span style="color: rgb(0, 0, 0);">33                35</span></p><p><span style="color: rgb(0, 0, 0);">42                42</span></p><p><span style="color: rgb(0, 0, 0);">再来看使用窗口函数。</span></p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> col1,<br/>
      (col1 </span><span style="color: rgb(128, 128, 128);">-</span> ROW_NUMBER() <span style="color: rgb(0, 0, 255);">OVER</span>(<span style="color: rgb(0, 0, 255);">ORDER</span> <span style="color: rgb(0, 0, 255);">BY</span> col1)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> grp<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> dbo.T1</span></span></code></pre><p>查询结果</p><p>2          1</p><p>3          1</p><p>11        8</p><p>12        8</p><p>13        8</p><p>27        21</p><p>33        26</p><p>34        26</p><p>35        26</p><p>42        32</p><p>聚合查询</p><pre><code><span><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">MIN</span>(T.col1) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> start_range,<br/>
       </span><span style="color: rgb(255, 0, 255);">MAX</span>(T.col1) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> end_range<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"><br/>
(<br/>
    </span><span style="color: rgb(0, 0, 255);">SELECT</span><span style="color: rgb(0, 0, 0);"> col1,<br/>
           (col1 </span><span style="color: rgb(128, 128, 128);">-</span> ROW_NUMBER() <span style="color: rgb(0, 0, 255);">OVER</span>(<span style="color: rgb(0, 0, 255);">ORDER</span> <span style="color: rgb(0, 0, 255);">BY</span> col1)) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> grp<br/>
    </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> dbo.T1<br/>
)</span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> T<br/>
</span><span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span> T.grp</span></span></code></pre><p><span style="color: rgb(0, 0, 0);">Start_range end_range</span></p><p><span style="color: rgb(0, 0, 0);">2                   3</span></p><p><span style="color: rgb(0, 0, 0);">11                13</span></p><p><span style="color: rgb(0, 0, 0);">27                27</span></p><p><span style="color: rgb(0, 0, 0);">33                35</span></p><p><span style="color: rgb(0, 0, 0);">42                42</span></p><h2 id="articleHeader10"><span style="color: rgb(0, 0, 0);">Window Function 的元素</span></h2><p>Window Function 的OVER语句中有三个非常重要的元素 - Partitioning, Ordering, Framing。</p><h3 id="articleHeader11"><span style="color: rgb(0, 0, 0);">Partitioning 分区 - PARTITION BY 支持所有的窗口函数</span></h3><p>通过PARTITION BY 得到的窗体集是基于当前查询结果的当前行的一个集，比如说 PARTITION BY CustomerID，当前行的 CustomerID = 1，那么对于当前行的这个 Window 集就是在当前查询结果之上再加上 CustomerID = 1 的一个查询结果。如果当前行的 CustomerID = 2，那么它的窗体就是在查询结果上所有 CustomerID = 2 的集。</p><p><span style="color: rgb(0, 0, 0);">如果没有指定 PARTITION BY，那么窗体集将不会在查询结果之上去过滤 CustomerID = ***，那就应该是整个查询结果集。</span><!--

                                                            </div-->
<div class="meta clearfix">
<div class="aw-article-vote pull-left" style="position: relative;">
<a class="agree" href="javascript:;" onclick="AWS.User.article_vote($(this), 560, 1);" style="font-size: 18px;"><i class="icon icon-agree"></i> 推荐 <b>0</b></a>
</div>
<span class="pull-right more-operate">
<div class="bdsharebuttonbox"><a class="bds_more" data-cmd="more" href="#"></a><a class="bds_qzone" data-cmd="qzone" href="#" title="分享到QQ空间"></a><a class="bds_sqq" data-cmd="sqq" href="#" title="分享到QQ好友"></a><a class="bds_tsina" data-cmd="tsina" href="#" title="分享到新浪微博"></a><a class="bds_renren" data-cmd="renren" href="#" title="分享到人人网"></a><a class="bds_weixin" data-cmd="weixin" href="#" title="分享到微信"></a><a class="bds_mail" data-cmd="mail" href="#" title="分享到邮件分享"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</span>
</div>
</p></div>]
</body>
</html>
