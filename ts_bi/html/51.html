
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>之前做过一个美国的医疗保险的项目，保险提供商有大量的文件需要发送给比如像银行，医疗协会，第三方服务商等。比如像与银行交互的 ACH 文件，传送给协会的 ACH Credit 等文件。这些文件格式在美国都是开放的，通用的，可以直接到相关网站下载。也就是说像银行，协会等他们接受这种固定格式的文件，读取数据，读取公司编号进行业务来往或者记录。我当时就是直接在网上搜索到一个 PDF 格式的文件说明，大概有10来页，就是告诉你这个格式是如何定义，应该如何来处理的。</p><p>那么这种文件并非像我们通常看到的一个文件所有的行都是遵循一种格式，这种文件分为很多 Section：</p><ol><li>File Header/Trailer</li><li>Batch Header/Trailer</li><li>还有细节的交易数据等</li></ol><p>可以参看 - <a href="http://www.treasurysoftware.com/ach.html"><u><font color="#0066cc">http://www.treasurysoftware.com/ach.html</font></u></a> 或 <a href="http://www.treasurysoftware.com/ach-file-format.html"><u><font color="#0066cc">http://www.treasurysoftware.com/ach-file-format.html</font></u></a> </p><p>会发现第1,2,3-5,6,7 行它们的格式都不一样，不同于我们之前的平面文件输出，在同一种格式下批量输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012218584851647.png"/></p><p>它们的文件格式说明就明确规定了某一行的输出有多少列，每列应该是什么内容，宽度，格式等等都严格的定义了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012221040637483.png"/></p><h2 id="articleHeader2">案例演示与讲解</h2><p>下面我使用 Adventure Works DW 2012 数据中的数据模拟输出类似于这种格式的平面文件。</p><p>比如下方是我的一个文件示例，第一行是单独的一个 Section，第二行也是，自第三行起到倒数第二行的格式是相同的，最后一行又是独立的一个输出格式。那么这个文件就是由 4 个 Section 组成。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012221173138701.png"/></p><p> </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012221260477466.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012221364075700.png"/></p><p>假设格式的定义如下所示：</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012221484532620.png"/></p><p>一般来说，对于 Header 或者 Trailer 中数据通常以描述性数据为主。比如像 Header 1 中的标题部分 -  ADVENTUREWORKS EMPLOYEE INFORMATION  这些都是固定的长度。但同时也有动态变化的内容，比如 Header 1 中的文件输出日期，以及 Header 2 中的员工数量。像 Trailer 部分，一般也是这种描述性的数据为主。</p><p>那么如何来输出这种格式的数据，很显然我们不能直接指定一个数据源表，然后将表中的内容给查询出来然后控制好长度直接输出，因为几个不同 Section 部分的格式是不一样的。我们的做法是，将 Header 1 和 Header 2 这样占少量行的数据拼接成一个整体输出；而对于像 Content 部分细节数据则使用数据库表操作自然输出。</p><p>同时，还要解决一个问题，如何让这不同格式的 Section 能够输出到同一个文件？这些在下面的步骤中都将能看到。</p><p>下面这三部分的数据将为 OLE DB Source 提供数据查询结果 -</p><h3 id="articleHeader3">对于 Header 1 和 Header 2 的处理</h3><p>创建存储过程，此存储过程输出一个两行单列的表数据。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">T006_GET_EMPLOYEE_FILE_HEADERS</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> T006_GET_EMPLOYEE_FILE_HEADERS<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> T006_GET_EMPLOYEE_FILE_HEADERS<br/>
</span><span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span><br/>
 <span style="color: rgb(0, 0, 255);">SET</span> NOCOUNT <span style="color: rgb(0, 0, 255);">ON</span><br/>
<br/>
 <span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@EMPLOYEE</span> <span style="color: rgb(0, 0, 255);">INT</span><br/>
 <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0);">@EMPLOYEE</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">COUNT</span>(<span style="color: rgb(128, 128, 128);">*</span><span style="color: rgb(0, 0, 0);">)<br/>
 </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> T006_EMPLOYEE<br/>
<br/>
 </span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">FILE CREATED DATE:</span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Description</span><br/>
   <span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">12</span>),<span style="color: rgb(255, 0, 255);">GETDATE</span>(),<span style="color: rgb(128, 0, 0); font-weight: bold;">110</span>) <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> File Created Date</span><br/>
   <span style="color: rgb(255, 0, 255);">SPACE</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">20</span>) <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 80 spaces</span><br/>
   <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">**********</span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);"> ADVENTUREWORKS EMPLOYEE INFORMATION </span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Company Report Name</span><br/>
   <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">**********</span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 255);">SPACE</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">95</span>) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> HEADER<br/>
 </span><span style="color: rgb(0, 0, 255);">UNION</span><br/>
 <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TOTAL EMPLOYEES:</span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">10</span>),<span style="color: rgb(0, 128, 0);">@EMPLOYEE</span>) <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 255);">SPACE</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">184</span><span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(255, 0, 255);">LEN</span>(<span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">10</span>),<span style="color: rgb(0, 128, 0);">@EMPLOYEE</span>))) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> HEADER<br/>
</span><span style="color: rgb(0, 0, 255);">END</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><p><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012224035631578.png"/></p><h3 id="articleHeader4">对于 Trailer 的数据处理</h3><p>创建存储过程，输出一个一行一列的表数据。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">T006_GET_EMPLOYEE_FILE_TRAILERS</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> T006_GET_EMPLOYEE_FILE_TRAILERS<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> T006_GET_EMPLOYEE_FILE_TRAILERS<br/>
</span><span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span><br/>
 <span style="color: rgb(0, 0, 255);">SET</span> NOCOUNT <span style="color: rgb(0, 0, 255);">ON</span><br/>
 <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">REPLACE</span>(<span style="color: rgb(255, 0, 255);">SPACE</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">92</span>),<span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">*</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);"> ADVENTUREWORKS </span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(128, 128, 128);">+</span><br/>
   <span style="color: rgb(255, 0, 255);">REPLACE</span>(<span style="color: rgb(255, 0, 255);">SPACE</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">92</span>),<span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">*</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> TRAILER<br/>
</span><span style="color: rgb(0, 0, 255);">END</span></span></code></pre><p><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012224216573749.png"/></p><h3 id="articleHeader5">对于 Content 的数据处理 </h3><p>直接使用查询即可，然后在输出文件的时候确保各列输出的格式与长度。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">SELECT</span> FirstName <span style="color: rgb(128, 128, 128);">+</span><span style="color: rgb(255, 0, 0);">'</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(128, 128, 128);">+</span>LastName <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> CustomerName,<br/>
 Title,<br/>
 HireDate,<br/>
 BirthDate,<br/>
 EmailAddress,<br/>
 Phone,<br/>
 MaritalStatus<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> T006_EMPLOYEE</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012224499222615.png"/></p><p>在控制流中，需要由3个数据流包构成，分别操作 Header 部分的输出，Content 部分的输出以及 Trailer 部分的输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012225001102135.png"/></p><p>连接管理器 CM_FF_EMPLOYEE_HEADER 接受来自于 T006_GET_EMPLOYEE_FILE_HEADERS 存储过程的输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012225162669566.png"/></p><p>连接管理器 CM_FF_EMPLOYEE_CONTENT 接受 SELECT 查询结果，同时要注意控制各列按指定宽度输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012225257031716.png"/></p><p>连接管理器 CM_FF_EMPLOYEE_TRAILER 接受存储过程 T006_GET_EMPLOYEE_FILE_TRAILERS 的输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012225354389009.png"/></p><p>但是要注意，它们指向的都是同一个目标平面文件。当然，马上就会有人问：那么不会出现后一个文件将前一个文件覆盖掉的后果吗？</p><p>这就是本案例处理的关键点所在 - <span style="color: rgb(255, 0, 0);">在 CM_FF_EMPLOYEE_HEADER 目标编辑器中选中 Overwrite data in the file - 覆盖已存在的文件。</span></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012226297355453.png"/></p><p>但是在后面两个输出中将不会选择这个选项，那么后面两个输出 Content 和 Trailer 将会紧接着 Header 写入到同一个文件中形成一个整体。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012226375006848.png"/></p><p> 最终的输出效果如下 - </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012226494854553.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/012227015008716.png"/><br/><br/></p>
</div>]
</body>
</html>
