
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p>在 ETL 的设计与开发过程中，我们经常需要通过一些编程的方式来解决一些比较复杂的需求，比如通过 C# 的代码来完成一些复杂逻辑的操作。那么在 SSIS 中有两个基本的控件可以让我们通过 C# 或者 VB 的语法进行自定义编程，一个是控制流中的 Script Task ，一个是数据流中的 Script Component。如果要学习和掌握 Script Component，那么首先就应该来学习 Script Task，并掌握例如如何进行包变量的读写操作，断掉调试等基本操作。</p><h3 id="articleHeader2" style="margin-left: 0px;">Script Task 中的变量读写操作</h3><p>新建一个包并拖放一个 Script Task 到控制流中，并新建以下变量，注意它们的数据类型。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041343431757586.png"/></p><p>我们要做的事情是，在 Script Task 中将通过系统变量启动时间给 PV_CURRENT_DATE 来赋值。并且 PV_YEAR, PV_MONTH,PV_DAY 的值均来自于对系统时间的解析，而 PV_PACKAGE_NAME 则取自系统变量包的名称。</p><p>在这里首先选择 C# 或者 VB 的编程方式，这个选择取决于大家对这两种编程方式的熟悉程度，对于我来说 C# 的熟悉程度要高于 VB 一些，所以会选择 C#，这也是 SQL Server 2008 以后才有的支持。</p><ol><li>ReadOnlyVariables - 这些变量是只读的，也就是说在编辑 Script Task 的时候不能给变量来赋值。</li><li>ReadOnlyWriteVariables - 这些变量是可读可写的，在编辑代码的时候可以给它们来赋值。</li></ol><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041344387691171.png"/></p><p>在 ReadOnlyVariables 中选择系统变量，只读属性。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041344500662622.png"/></p><p>在选择 ReadWriteVariables 时会发现只有用户自定义的变量是可以被选择的，这也就说明系统变量是只读的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041345051597232.png"/></p><p>选择完变量之后的效果，并编辑 Script。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041345190037829.png"/></p><p>在第一次打开的时候会比较慢，后面就会快一些。</p><h4 id="articleHeader3" style="margin-left: 0px;">Main 方法中的代码 </h4><p>在 Script Task 中，如果需要使用到一些类，比如像 IO 操作的类，那么需要在命名空间中去引用它，下面是几种默认的引用。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041345382844186.png"/></p><p>先获取两个系统变量的值保存在两个变量中，注意 CurrentDate 的类型是 DateTime 类型，它在接受系统变量 StartTime 的时候是需要强制类型转换将 .Value 表示的 Object 类型转换成 DateTime 类型的。其次再使用两个变量给用户自定义变量赋值，最后使用 MessageBox 进行值的显示操作。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>public</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>void</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> Main()<br/>
  {<br/>
   </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> TODO: Add your code here<br/>
            </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> System::PackageName,System::StartTime <br/>
            </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> User::PV_CURRENT_DATE,User::PV_DAY,User::PV_MONTH,User::PV_PACKAGE_NAME,User::PV_YEAR<br/>
            </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> System Variables</span><br/>
            String PackageName = Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>System::PackageName</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value.ToString();<br/>
            DateTime CurrentDate </span>= (DateTime)Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>System::StartTime</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value;<br/>
<br/>
            </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> User Defined Variables</span><br/>
            Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_CURRENT_DATE</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value =<span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> CurrentDate;<br/>
            Dts.Variables[</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_YEAR</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value =<span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> CurrentDate.Year;<br/>
            Dts.Variables[</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_MONTH</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value =<span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> CurrentDate.Month;<br/>
            Dts.Variables[</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_DAY</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value =<span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> CurrentDate.Day;<br/>
            Dts.Variables[</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_PACKAGE_NAME</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value =<span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> PackageName;<br/>
<br/>
            String VarMessage </span>= <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>Package Name - </span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span> + Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_PACKAGE_NAME</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value + <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>\n</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>+<br/>
                                <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>Current Date - </span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span> + ((DateTime)Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_CURRENT_DATE</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value).ToLongDateString() + <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>\n</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>+<br/>
                                <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>Year - </span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span> + Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_YEAR</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value + <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>\n</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>+<br/>
                                <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>Month - </span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span> + Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_MONTH</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>].Value + <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>\n</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>+<br/>
                                <span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>Day- </span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span> + Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_DAY</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value;<br/>
<br/>
            MessageBox.Show(VarMessage); <br/>
<br/>
   Dts.TaskResult </span>= (<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>int</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>)ScriptResults.Success;<br/>
  }</span></span></code></pre><p style="margin-left: auto;">保存并执行包的效果 - </p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041347146758001.png"/></p><h3 id="articleHeader4" style="margin-left: 0px;">常见错误举例说明与断点调试</h3><h4 id="articleHeader5" style="margin-left: 0px;">第一 - 丢失变量</h4><p>在选择变量的时候，少选了变量，这样在代码中使用到这个变量就会报错。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041347345506173.png"/></p><p>运行时错误 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041347433316721.png"/></p><p>也很难从这个错误信息中获取非常有价值的信息。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041347515504100.png"/></p><p>打开 Script 并在合适的位置放置断点 - BreakPoint。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041348015036807.png"/></p><p>将本包设置为项目的启动项。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041348123001173.png"/></p><p>点击进行断点执行和调试。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041348268629453.png"/></p><p>当包中有很多 Task 的时候，执行到这个 Task 的时候就会进入代码内部。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041348574876977.png"/></p><p>按 F10 逐过程或者F11 逐句单步调试的时候，会看到错误发生的地方。第一句提示我们的错误就是：</p><p><span style="color: rgb(255, 0, 0);">The element cannot be found in a collection。This error happens when you try to retrieve an element from a collection on a container during execution of the package and the element is not there.</span></p><p><span style="color: rgb(255, 0, 0);">不能在集合中找到这个元素，这个错误通常发生在包运行期间试图从容器中的集合里获取元素的时候那个元素却找不到了。</span></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041349310036217.png"/></p><p>通过这种方式我们就可以知道我们的错误发生在哪里了，就可以很快的修复这个错误。</p><h4 id="articleHeader6" style="margin-left: 0px;">第二 - 给只读变量赋值</h4><p>给 PV_CURRENT_DATE 只读状态，不能赋值。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041349488474801.png"/></p><p>按道理包在运行的时候会发生失败，但是最终包还是成功运行的！这里是微软 SSIS 2012 版本的一个 Bug，这个例子在 SQL Server 2008 R2 版本上会出现错误。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041350243782157.png"/></p><p>那么在 SSIS 2012 中要如何解决或者描述这个问题呢？ 测试一下，修改变量 PV_CURRENT_DATE 将它的 ReadOnly 属性修改为 True，标明是只读，这个时候才会出错。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041350400819652.png"/></p><p>通过断点调试就会发现这个错误的原因就是 : Error trying to write to a read-only variables，试图向只读的变量写值。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201410/041350534418934.png"/></p><h3 id="articleHeader7" style="margin-left: 0px;">总结</h3><p>这个 Bug 的发现也是非常偶然的，因为按照在 2008 R2 对这个控件的用法是没有问题的，按照使用习惯也是不会发现这个问题的。正好是在演示 ReadOnly 的变量不能赋值的时候才发现这个地方是有问题的，这个 Bug 还是非常明显的，我也就这个问题提到官网论坛去了。</p><p><a href="http://social.msdn.microsoft.com/Forums/sqlserver/en-US/62777694-f6b3-465d-8367-ef8169c0340f/is-it-a-bug-ssis-2012-readonlyvariables-in-script-task-doesnt-work?forum=sqlintegrationservices" target="_blank">Is it a bug - SSIS 2012 ReadOnlyVariables in Script Task doesn't work</a></p>
<ul class="aw-upload-file-list">
</ul>
</div>]
</body>
</html>
