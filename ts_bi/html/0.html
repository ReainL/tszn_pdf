
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>在这篇日志中 <a href="http://www.flybi.net/blog/biwork/589"><u><font color="#0066cc">如何在 ETL 项目中统一管理上百个 SSIS 包的日志和包配置框架</font></u></a> 我介绍到了包级别的日志管理框架，那么这个主要是针对包这一个层级的 Log 信息，包括包开始执行和结束时间，以及各个包的执行成功或者失败状态。</p><p>但是我们可以更加深一层次的将日志记录 Logging 以及数据信息 Auditing 信息延伸到包中的重要 Task 中。</p><p>通常情况下，SSIS 包从各个数据源加载数据到 Staging 表中，数据源可以是文件，也可以是其它数据库。然后经过数据仓库 SCD 以及 Lookup 等操作，将 Staging 中的数据清理并整理加载到各个维度以及事实表中。</p><p>假设我们需要知道在当前操作中，各个 Staging 表加载了多少数据，使用了多长时间。各个处理维度和事实的 Task 使用了多少时间，新增了多少数据，修改了多少数据。这些我们也是有能力做到的，如果再配合 <a href="http://www.flybi.net/blog/biwork/589"><u><font color="#0066cc">如何在 ETL 项目中统一管理上百个 SSIS 包的日志和包配置框架</font></u></a> 这篇文章中提到的包级别日志记录，那么我们将非常清晰的知道我们的 SSIS 包无论是在包级别，还是在各个重要 Task 级别的各种日志，数据信息。这些信息对于我们的包维护，性能分析，错误纠正，错误修复都是非常有价值的。</p><p>比如，我可以很轻松的通过自定义的报表浏览哪些 Task 在同等记录情况下最耗时间，各个 Task 在整个包的执行过程中所用的时间比。</p><p><img alt="" height="59" src="http://images.cnitblog.com/i/477275/201404/181449477605421.png" width="1046"/></p><p>不同的 ETL 项目在 Auditing 上会采取不同的策略，比如以文件加载为主的 ETL 是允许有部分错误数据加载失败的，但是以数据仓库为主的 ETL 则不希望出现错误数据加载的。因此在设计 Auditing 的时候要考虑到这些情况，比如设计的时候多出一个 失败数据总数的记录用于跟踪文件数据等。</p><p>在这里只讲如何实现 Auditing，简单的介绍一下核心操作，大家可以在这个基础之上去扩充。</p><h2 id="articleHeader2">关键点</h2><p>实现 Auditing 的关键点就是要借用控制流 Task 中的 Event Handler 下的 OnPostExecute 和 OnPreExecute 功能。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181447586195230.png"/></p><ol><li>OnError 功能已经在这篇 <a href="http://www.cnblogs.com/biwork/p/biworklog.html"><u><font color="#0066cc">如何在 ETL 项目中统一管理上百个 SSIS 包的日志和包配置框架</font></u></a> 文章中详细的介绍到了。</li><li>OnPreExecute - 在 Task 执行之前触发的事件。</li><li>OnPostExecute - 在 Task 执行完成之后触发的事件。</li></ol><p>通过这样两个事件我们很容易实现对 Task 执行前后表数据变化的操作记录。</p><h2 id="articleHeader3">数据源，目标表及其它数据库对象</h2><p>测试数据源是 AdventureWorksLT2012</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181503072754297.png"/></p><h3 id="articleHeader4">BIWORK_SSIS 数据库中的目标表 </h3><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">dbo.SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> dbo.SalesOrderDetail<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
 <br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderDetail</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);">(<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderID</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">int</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">SalesOrderDetailID</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">int</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">OrderQty</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">smallint</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">ProductID</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">int</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">UnitPrice</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">money</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">UnitPriceDiscount</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">money</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">LineTotal</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">numeric</span><span style="color: rgb(255, 0, 0);">]</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">38</span>, <span style="color: rgb(128, 0, 0); font-weight: bold;">6</span>) <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">rowguid</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">uniqueidentifier</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">ModifiedDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">datetime</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><span style="color: rgb(0, 0, 0);"><br/>
) </span><span style="color: rgb(0, 0, 255);">ON</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">PRIMARY</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><h3 id="articleHeader5">Task 执行状态表</h3><p>EXECUTION_ID 应该使用 <a href="http://www.flybi.net/blog/biwork/589"><u><font color="#0066cc">如何在 ETL 项目中统一管理上百个 SSIS 包的日志和包配置框架</font></u></a> 中的 PROCESS_LOG_ID, 这样就将 SSIS 包日志和 TASK 关联起来了。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">USE</span><span style="color: rgb(0, 0, 0);"> BIWORK_SSIS<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">TASK_EXECUTION_STATUS</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> TASK_EXECUTION_STATUS<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> TASK_EXECUTION_STATUS <br/>
(<br/>
    EXECUTION_ID </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">255</span><span style="color: rgb(0, 0, 0);">),  <br/>
    PACKAGE_NAME </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span><span style="color: rgb(0, 0, 0);">),<br/>
    TASK_ID </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">),<br/>
    TASK_NAME </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">),<br/>
    TABLE_NAME </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">),<br/>
    ExistingRowsBefore </span><span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
    StartTime </span><span style="color: rgb(0, 0, 255);">DATETIME</span><span style="color: rgb(0, 0, 0);">,<br/>
    DeletedRows </span><span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
    UpdatedRows </span><span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
    InsertedRows </span><span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
    ExistingRowsAfter </span><span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
    EndTime </span><span style="color: rgb(0, 0, 255);">DATETIME</span><span style="color: rgb(0, 0, 0);">,<br/>
    ExecutionStatus </span><span style="color: rgb(0, 0, 255);">INT</span><span style="color: rgb(0, 0, 0);"><br/>
)</span></span></code></pre><h3 id="articleHeader6">获取表的条数</h3><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">dbo.GET_TABLE_COUNT</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> dbo.GET_TABLE_COUNT<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> dbo.GET_TABLE_COUNT<br/>
</span><span style="color: rgb(0, 128, 0);">@TABLE_NAME</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
</span><span style="color: rgb(0, 128, 0);">@ROW_COUNT</span> <span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);"> OUTPUT <br/>
</span><span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span> <br/>
<br/>
    <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0);">@ROW_COUNT</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">SUM</span><span style="color: rgb(0, 0, 0);">(PART.rows) <br/>
    </span><span style="color: rgb(0, 0, 255);">FROM</span><span style="color: rgb(0, 0, 0);"> sys.tables TBL<br/>
    </span><span style="color: rgb(0, 0, 255);">INNER</span> <span style="color: rgb(128, 128, 128);">JOIN</span> sys.partitions PART <span style="color: rgb(0, 0, 255);">ON</span> TBL.<span style="color: rgb(255, 0, 255);">object_id</span> <span style="color: rgb(128, 128, 128);">=</span> PART.<span style="color: rgb(255, 0, 255);">object_id</span><br/>
    <span style="color: rgb(0, 0, 255);">INNER</span> <span style="color: rgb(128, 128, 128);">JOIN</span> sys.indexes IDX <span style="color: rgb(0, 0, 255);">ON</span> PART.<span style="color: rgb(255, 0, 255);">object_id</span> <span style="color: rgb(128, 128, 128);">=</span> IDX.<span style="color: rgb(255, 0, 255);">object_id</span><br/>
    <span style="color: rgb(128, 128, 128);">AND</span> PART.index_id <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> IDX.index_id<br/>
    </span><span style="color: rgb(0, 0, 255);">WHERE</span> TBL.name <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@TABLE_NAME</span><br/>
    <span style="color: rgb(128, 128, 128);">AND</span> IDX.index_id <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span><br/>
    <span style="color: rgb(0, 0, 255);">GROUP</span> <span style="color: rgb(0, 0, 255);">BY</span> TBL.<span style="color: rgb(255, 0, 255);">object_id</span><span style="color: rgb(0, 0, 0);">, TBL.name <br/>
<br/>
    </span><span style="color: rgb(0, 0, 255);">RETURN</span> <span style="color: rgb(0, 128, 0);">@ROW_COUNT</span><br/>
<span style="color: rgb(0, 0, 255);">END</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><h3 id="articleHeader7">记录时间</h3><p>这个存储过程用来每次在执行 Task 之前获取目标表中的条数，并且插入 Task 启动时间 -</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">dbo.USP_INSERT_TASK_EXECUTION</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">P</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> dbo.USP_INSERT_TASK_EXECUTION<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> USP_INSERT_TASK_EXECUTION<br/>
    </span><span style="color: rgb(0, 128, 0);">@TARGET_TABLE_NAME</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(0, 128, 0);">@EXECUTION_ID</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">255</span><span style="color: rgb(0, 0, 0);">)  , <br/>
    </span><span style="color: rgb(0, 128, 0);">@PACKAGE_NAME</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">100</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(0, 128, 0);">@TASK_ID</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">255</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(0, 128, 0);">@TASK_NAME</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">) <br/>
</span><span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span><br/>
 <br/>
    <span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@ExistingRowsBefore</span> <span style="color: rgb(0, 0, 255);">BIGINT</span><br/>
<br/>
    <span style="color: rgb(0, 0, 255);">EXECUTE</span><span style="color: rgb(0, 0, 0);"> dbo.GET_TABLE_COUNT<br/>
    </span><span style="color: rgb(0, 128, 0);">@TABLE_NAME</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@TARGET_TABLE_NAME</span><span style="color: rgb(0, 0, 0);">,<br/>
    </span><span style="color: rgb(0, 128, 0);">@ROW_COUNT</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@ExistingRowsBefore</span><span style="color: rgb(0, 0, 0);"> OUTPUT <br/>
<br/>
    </span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span><span style="color: rgb(0, 0, 0);"> TASK_EXECUTION_STATUS<br/>
    (<br/>
        EXECUTION_ID, <br/>
        PACKAGE_NAME,<br/>
        TASK_ID,<br/>
        TASK_NAME,<br/>
        TABLE_NAME,<br/>
        ExistingRowsBefore,<br/>
        StartTime,<br/>
        DeletedRows,<br/>
        UpdatedRows,<br/>
        InsertedRows,<br/>
        ExistingRowsAfter,<br/>
        EndTime,<br/>
        ExecutionStatus<br/>
    )<br/>
    </span><span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);"><br/>
    (<br/>
        </span><span style="color: rgb(0, 128, 0);">@EXECUTION_ID</span><span style="color: rgb(0, 0, 0);">, <br/>
        </span><span style="color: rgb(0, 128, 0);">@PACKAGE_NAME</span><span style="color: rgb(0, 0, 0);">,<br/>
        </span><span style="color: rgb(0, 128, 0);">@TASK_ID</span><span style="color: rgb(0, 0, 0);">,<br/>
        </span><span style="color: rgb(0, 128, 0);">@TASK_NAME</span><span style="color: rgb(0, 0, 0);">,<br/>
        </span><span style="color: rgb(0, 128, 0);">@TARGET_TABLE_NAME</span><span style="color: rgb(0, 0, 0);">,<br/>
        </span><span style="color: rgb(0, 128, 0);">@ExistingRowsBefore</span><span style="color: rgb(0, 0, 0);">,<br/>
        </span><span style="color: rgb(255, 0, 255);">GETDATE</span><span style="color: rgb(0, 0, 0);">(),<br/>
        </span><span style="color: rgb(0, 0, 255);">NULL</span>, <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">@DeletedRows,</span><br/>
        <span style="color: rgb(0, 0, 255);">NULL</span>, <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">@UpdatedRows,</span><br/>
        <span style="color: rgb(0, 0, 255);">NULL</span>, <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">@InsertedRows,</span><br/>
        <span style="color: rgb(0, 0, 255);">NULL</span>, <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">@ExistingRowsAfter</span><br/>
        <span style="color: rgb(0, 0, 255);">NULL</span>, <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">@EndTime</span><br/>
        <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span> <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> In process</span><br/>
<span style="color: rgb(0, 0, 0);">)<br/>
</span><span style="color: rgb(0, 0, 255);">END</span></span></code></pre><h3 id="articleHeader8">更新 Task 状态表 </h3><p>当 @DeletedRows = -1 的时候，表明操作是 Truncate 操作。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">dbo.USP_UPDATE_TASK_EXECUTION</span><span style="color: rgb(255, 0, 0);">'</span> ) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> dbo.USP_UPDATE_TASK_EXECUTION <br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">PROCEDURE</span><span style="color: rgb(0, 0, 0);"> dbo.USP_UPDATE_TASK_EXECUTION<br/>
</span><span style="color: rgb(0, 128, 0);">@ExecutionID</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">),<br/>
</span><span style="color: rgb(0, 128, 0);">@TaskID</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">250</span><span style="color: rgb(0, 0, 0);">),<br/>
</span><span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
</span><span style="color: rgb(0, 128, 0);">@UpdatedRows</span> <span style="color: rgb(0, 0, 255);">BIGINT</span><span style="color: rgb(0, 0, 0);">,<br/>
</span><span style="color: rgb(0, 128, 0);">@InsertedRows</span> <span style="color: rgb(0, 0, 255);">BIGINT</span> <br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span><br/>
<br/>
    <span style="color: rgb(0, 0, 255);">UPDATE</span><span style="color: rgb(0, 0, 0);"> dbo.TASK_EXECUTION_STATUS<br/>
    </span><span style="color: rgb(0, 0, 255);">SET</span> DeletedRows <span style="color: rgb(128, 128, 128);">=</span> (<span style="color: rgb(255, 0, 255);">CASE</span> <span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(0, 0, 255);">THEN</span> ExistingRowsBefore <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(0, 0, 255);">END</span><span style="color: rgb(0, 0, 0);">),<br/>
        UpdatedRows </span><span style="color: rgb(128, 128, 128);">=</span> (<span style="color: rgb(255, 0, 255);">CASE</span> <span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span> <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 128, 0);">@UpdatedRows</span> <span style="color: rgb(0, 0, 255);">END</span><span style="color: rgb(0, 0, 0);">),<br/>
        InsertedRows </span><span style="color: rgb(128, 128, 128);">=</span> (<span style="color: rgb(255, 0, 255);">CASE</span> <span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span> <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 128, 0);">@InsertedRows</span> <span style="color: rgb(0, 0, 255);">END</span><span style="color: rgb(0, 0, 0);">),<br/>
        ExistingRowsAfter </span><span style="color: rgb(128, 128, 128);">=</span> (<span style="color: rgb(255, 0, 255);">CASE</span> <span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span> <span style="color: rgb(0, 0, 255);">ELSE</span> (ExistingRowsBefore <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(0, 128, 0);">@InsertedRows</span> <span style="color: rgb(128, 128, 128);">-</span> <span style="color: rgb(0, 128, 0);">@DeletedRows</span>) <span style="color: rgb(0, 0, 255);">END</span><span style="color: rgb(0, 0, 0);">),<br/>
        EndTime </span><span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">GETDATE</span><span style="color: rgb(0, 0, 0);">(),<br/>
        ExecutionStatus </span><span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
    <span style="color: rgb(0, 0, 255);">WHERE</span> EXECUTION_ID <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@ExecutionID</span><br/>
        <span style="color: rgb(128, 128, 128);">AND</span> TASK_ID <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@TaskID</span><br/>
<span style="color: rgb(0, 0, 255);">END</span> <br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><h2 id="articleHeader9">SSIS 包中的流程实现</h2><p>SSIS 包 - 第二个和第三个 Task 的功能完全一样，只为了演示的目的。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181531100722060.png"/></p><p>EST_TRUNCATE_SALES_ORDER_DETAIL Task - 在加载数据之前删除表数据。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181531549782340.png"/></p><p>它的 OnPreExecute 事件中添加了一个 Execute SQL Task 组件用来向 Task Execution 表插入操作前的记录。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181532305109686.png"/></p><p>调用 USP_INSERT_TASK_EXECUTION 存储过程根据表名查询记录数。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181533228073177.png"/></p><p>参数 Mapping 关系，注意这里要用 Source ID , Source Name 而不是 Task ID, Task Name。因为 Task 是指当前执行这些 SQL 的 Task 自身，而我们要监控的不是这个事件下的 Task ，而是控制流中的 Task 组件。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181538438389665.png"/></p><p>EST_TRUNCATE_SALES_ORDER_DETAIL 中 OnPostExecute 的配置 -</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181540435106805.png"/></p><p>这里就是 Update 操作了，因为 EST_TRUNCATE_SALES_ORDER_DETAIL 是 Truncate 表操作，所以这里给了 DeletedRows = -1。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181541206668920.png"/></p><p>更新的时候直接根据 Execution ID 和 Task ID 就可以了。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181542150729565.png"/></p><p>第二个 Task 也要配置 OnPreExecute 和 OnPostExecute 事件，也就是说每一个你需要监控的 Task 都要配置。感觉比较复杂，但是一次配置完成以后，受用可是长期的。</p><p>要注意的是第二个 Task 是从数据源加载数据，这样需要在加载的过程中获取记录数，通过 ROW COUNT 可以实现将数据流的条数赋值给变量保存。</p><p>另外要注意的是 - 这个变量的 SCOPE 是控制流组件自身，即作用域。因为可能要有很多 Task 需要用到记录条数的变量，全部放到包级别中这个变量会非常多，并且容易出错。可以理解为 InsertedRows 是局部变量，它的生命周期就是 Task 本身。</p><p>如果创建的变量位于包级别 SCOPE，可以点击下方的小方框 Move 到当前 Task 的 SCOPE 中。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181545027916426.png"/></p><p>变量的赋值。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181558023535732.png"/></p><p>OnPreExecute 的配置和上面的 Task 一样，复制一份即可，这里是 OnPostExecute 的配置。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181558317605382.png"/></p><p>需要什么变量就记录什么变量，就配置什么变量。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181600029321430.png"/></p><p>后面的两个 Task 一模一样，只是为了测试使用。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181600338857106.png"/></p><p>运行两次的结果，数据条数的记录是非常连贯的。</p><p><img alt="" height="112" src="http://images.cnitblog.com/i/477275/201404/181602085577550.png" width="1054"/></p><p>记录 SCD 的修改和新增条数只需要在相应的地方添加 ROW COUNT 组件来捕获即可。</p><p><img alt="" src="http://images.cnitblog.com/i/477275/201404/181617505574364.png"/></p><p>当然除了使用 ROW COUNT 组件，在某些特定的情况下也可以使用 @@ROWCOUNT 来获取新增，删除或者修改所影响到的条数。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@UpdateRowCnt</span> <span style="color: rgb(0, 0, 255);">INT</span><br/>
<span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@InsertRowCnt</span> <span style="color: rgb(0, 0, 255);">INT</span><br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">Inserting records from Source to Destination which does not exists</span><br/>
<span style="color: rgb(0, 0, 255);">insert</span> <span style="color: rgb(0, 0, 255);">into</span><span style="color: rgb(0, 0, 0);"> dbo.Client(ClientName,Country,Town)<br/>
</span><span style="color: rgb(0, 0, 255);">Select</span> clientName, Country, Town <span style="color: rgb(0, 0, 255);">from</span><span style="color: rgb(0, 0, 0);"> dbo.ClientSource S <br/>
</span><span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(128, 128, 128);">EXISTS</span> ( <span style="color: rgb(0, 0, 255);">Select</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(0, 0, 255);">from</span> dbo.Client CL <span style="color: rgb(0, 0, 255);">WHERE</span> CL.ClientName<span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);">S.ClientName)<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0);">@InsertRowCnt</span><span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 128, 0); font-weight: bold;">@@ROWCOUNT</span><br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);">Update Already existing records from Source</span><br/>
<span style="color: rgb(0, 0, 255);">Update</span><span style="color: rgb(0, 0, 0);"> CL<br/>
</span><span style="color: rgb(0, 0, 255);">set</span> CL.ClientType<span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);">S.CLientType<br/>
</span><span style="color: rgb(0, 0, 255);">from</span><span style="color: rgb(0, 0, 0);"> dbo.Client CL <br/>
</span><span style="color: rgb(0, 0, 255);">INNER</span> <span style="color: rgb(128, 128, 128);">JOIN</span><span style="color: rgb(0, 0, 0);"> dbo.ClientSource S <br/>
</span><span style="color: rgb(0, 0, 255);">ON</span> Cl.ClientName<span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);">S.ClientName<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0);">@UpdateRowCnt</span><span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 128, 0); font-weight: bold;">@@ROWCOUNT</span></span></code></pre><h2 id="articleHeader10">最后一个问题</h2><p>如果每次都在各个 Task 中的 OnPreExecute 和 OnPostExecute 中配置非常麻烦，有没有改进的方法。</p><p>答案是有的。</p><p>我提供一个思路，有兴趣的话可以自动动手尝试 -</p><p>Task 级别的 OnPreExecute 和 OnPostExecute 事件是当 Task 被执行前后被触发的，要注意的是包级别的 OnPreExecute 和 OnPostExecute 也是可以捕获 Task 级别的 OnPreExecute 和 OnPostExecute 事件。</p><p>可以定义一张表，表中记录需要被处理的 Task 名称，然后在包级别的 OnPreExecute 和 OnPostExecute 中处理 各个 Task 的 Auditing 信息。不在列表上的，就可以不用处理。</p><p>同时还要注意 Task 同步的问题，若是很多 Task 同时执行，并行执行的话，就需要在各自 Task 中定义好变量来记录然后再赋值给 Package 级别的变量可以避免这一问题。</p><h2 id="articleHeader11">与本文相关的文章</h2><p><a href="http://www.flybi.net/blog/biwork/589" target="_blank"><u><font color="#0066cc">如何在 ETL 项目中统一管理上百个 SSIS 包的日志和包配置框架</font></u></a></p>
</div>]
</body>
</html>
