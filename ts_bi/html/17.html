
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p style="margin-left: auto;">在 BI 项目中，有一个非常常用的控制流控件 - Execute SQL Task，在数据从数据源加载到目标表之前它经常会被用来执行一些清空表的操作。除此之外，它的在项目中的常用的情形还包括：</p><ol><li>执行插入，更新，Merge 等数据操作，包括可能的删除一些 Working table 和创建 Working table 等操作。</li><li>SSIS 日志中调用存储过程，或者直接插入包日志等。</li><li>保留 SQL 查询的结果或者存储过程的调用结果值到变量中，供包中其它 Task 使用。</li><li>配合 Foreach Loop 或者 For Loop 在循环中执行增，删，改，查等操作。</li></ol><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191426184406098.png"/></p><p style="margin-left: auto;">通常情况下，Connection Type 我们选择的都是 OLE DB 连接方式，少数情况下使用过 ADO.NET，其它的连接方式很少或者基本上没有使用过。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191428135183041.png"/></p><p style="margin-left: auto;">要执行的 SQL 语句写在 SQL Statement 中，比如执行存储过程，查询，删除，修改等都可以写在里面。并且也支持批处理，只需要在结束的位置添加 GO 命令就可以了。所以在 GO 关键字之间的 SQL 会一次性发出并执行。</p><h3 id="articleHeader2" style="margin-left: 0px;">简单的 SQL 插入语句操作</h3><p style="margin-left: auto;">在本文的例子中，首先演示一条插入语句的操作，目标表是一个包的Log日志表。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IF</span> <span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>OBJECT_ID</span>(<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>T013_PROCESS_LOG</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>) <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IS</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>NOT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DROP</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>TABLE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> T013_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>CREATE</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>TABLE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> T013_PROCESS_LOG<br/>
(<br/>
 ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>PRIMARY</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>KEY</span> <span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IDENTITY</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
 EXECUTION_ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
 PACKAGE_NAME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
 MACHINE_NAME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
 START_TIME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DATETIME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>,<br/>
 FINISH_TIME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DATETIME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>,<br/>
 EXECUTE_STATUS_ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INT</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'><br/>
)<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>SELECT</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>*</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>FROM</span> T013_PROCESS_LOG </span></code></pre><p style="margin-left: auto;">SQL Statement 中的语句：</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INSERT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INTO</span> T013_PROCESS_LOG <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>VALUES</span>(<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>1001</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>,<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>013_EXECUTE_SQL_TASK</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>,<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>LOCALHOST</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>,<span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GETDATE</span>(),<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span>)</span></code></pre><p style="margin-left: auto;">执行包之后查询数据库中的记录，插入操作成功。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191429445655359.png"/></p><h3 id="articleHeader3" style="margin-left: 0px;">带参数的 SQL 插入操作</h3><p style="margin-left: auto;">很显然在这张表中的数据有很多内容是不应该 Hard-code 写死的，因此下面演示参数的传递操作。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INSERT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INTO</span> T013_PROCESS_LOG <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>VALUES</span>(?,?,?,<span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GETDATE</span>(),<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span>)</span></code></pre><p style="margin-left: auto;">这条语句中我们看到有三个 ？ 分别表示了 EXECUTION_ID, PACKAGE_NAME 和 MACHINE_NAME，这几个值在包执行的时候就已经存在了，我们可以在 SSIS 中把他们引用出来。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191430434259242.png"/></p><p style="margin-left: auto;">保存并切换到 Parameter Mapping 位置，可以选择系统变量。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191431019565516.png"/></p><p style="margin-left: auto;">这三个参数与系统自带的变量进行绑定，注意选择好参数方向，数据类型和参数名称。</p><ol><li>System::ExecutionInstanceGUID - 包每次执行一次就会给这个变量赋值一次，一个独一无二的唯一标识。</li><li>System::PackageName - 包的名称。</li><li>System::MachineName - 机器名称。</li></ol><p style="margin-left: auto;">参数名称 Parameter Name 中的 0,1,2 表示的是 SQL 语句中 ? 的位置，这个位置不能弄错了。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191431221591544.png"/></p><p style="margin-left: auto;">配置完成后，执行包两次，能看到两个不同的 Execution ID，这种方式在自定义包的Log日志处理中非常有用。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191431511753078.png"/></p><h3 id="articleHeader4" style="margin-left: 0px;">Execute SQL Task 中处理带参数和输出的存储过程</h3><p style="margin-left: auto;">有很多情况下，为了因修改业务逻辑而影响到包，或者当 SQL 内容过多过复杂的时候，我们往往选择将 SQL 语句封装成一个存储过程。这样逻辑的修改不会影响包，也就是说在不需要打开包的情况下就把业务逻辑给修改好了。</p><p style="margin-left: auto;">以下存储过程插入一条记录，并将自增的 ID标识 返回。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IF</span> <span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>OBJECT_ID</span>(<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>USP_T013_INSERT_PROCESS_LOG</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>) <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IS</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>NOT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DROP</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>PROCEDURE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> USP_T013_INSERT_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>CREATE</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>PROCEDURE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> USP_T013_INSERT_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@EXECUTION_ID</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@PACKAGE_NAME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@MACHINE_NAME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@ID</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INT</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> OUTPUT<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>AS</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>BEGIN</span><br/>
 <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INSERT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INTO</span> T013_PROCESS_LOG <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>VALUES</span>(<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@EXECUTION_ID</span>,<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@PACKAGE_NAME</span>,<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@MACHINE_NAME</span>,<span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GETDATE</span>(),<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>)<br/>
 </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>SELECT</span> <span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@ID</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span> <span style='color: rgb(0, 128, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>@@IDENTITY</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>END</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span></span></code></pre><p style="margin-left: auto;">EXECUTE SQL TASK 中 SQL 语句。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>EXECUTE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> USP_T013_INSERT_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@EXECUTION_ID</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> ?,<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@PACKAGE_NAME</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> ?,<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@MACHINE_NAME</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> ?,<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@ID</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span> ? OUTPUT</span></code></pre><p style="margin-left: auto;">其它位置保持不变，对于存储过程的输出值需要有一个变量来接受保存，点击 New Variable 创建变量，或者应该事先创建好。</p><p style="margin-left: auto;"> <img alt="" src="http://images.cnitblog.com/blog/477275/201409/191431370188003.png"/></p><p style="margin-left: auto;">创建一个 Package 级别的变量，注意命名规范 - PV 表示 Package Variable。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191433218932197.png"/></p><p style="margin-left: auto;">添加 Mapping ，注意这里选择的 Output 类型是 Long 表示 Int 类型数据，3是？的位置。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191433343004073.png"/></p><p style="margin-left: auto;">添加一个 Script Task 来显示一下新插入产生的 Process Log ID。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191433475039305.png"/></p><p style="margin-left: auto;">选择用户自定义的变量。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191434164711556.png"/></p><p style="margin-left: auto;">Script 中的代码显示一下这个新的自增长的 ID 值。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>{<br/>
   </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> TODO: Add your code here</span><br/>
            MessageBox.Show(Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_PROCESS_LOG_ID</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value.ToString());<br/>
   Dts.TaskResult </span>= (<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>int</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>)ScriptResults.Success;<br/>
  }</span></span></code></pre><p style="margin-left: auto;">保存并执行，执行的过程中可以看到新的LOG ID。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191434437212365.png"/></p><p style="margin-left: auto;">查看数据库可以看到对应的 ID 值。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191434528626772.png"/></p><h3 id="articleHeader5" style="margin-left: 0px;">带有 ReturnValue 的操作</h3><p style="margin-left: auto;">关于 ReturnValue 和 Output 的概念以及区别大家可以参考 SQL Server 的官方文档，下面修改这个存储过程，添加一个返回值，表示存储过程执行成功。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IF</span> <span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>OBJECT_ID</span>(<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>USP_T013_INSERT_PROCESS_LOG</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>) <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IS</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>NOT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DROP</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>PROCEDURE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> USP_T013_INSERT_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>CREATE</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>PROCEDURE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> USP_T013_INSERT_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@EXECUTION_ID</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@PACKAGE_NAME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@MACHINE_NAME</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@ID</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INT</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> OUTPUT<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>AS</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>BEGIN</span><br/>
 <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INSERT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INTO</span> T013_PROCESS_LOG <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>VALUES</span>(<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@EXECUTION_ID</span>,<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@PACKAGE_NAME</span>,<span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@MACHINE_NAME</span>,<span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GETDATE</span>(),<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>)<br/>
 </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>SELECT</span> <span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>@ID</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>=</span> <span style='color: rgb(0, 128, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>@@IDENTITY</span><br/>
 <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>RETURN</span> <span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>END</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span></span></code></pre><p style="margin-left: auto;">修改 Execute SQL Task 中的 SQL 语句并修改 Parameter Mapping ，自行添加一个用户变量 - PV_USP_STATUS。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191435325036227.png"/></p><p style="margin-left: auto;">修改 Script Task 显示这个变量的结果。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>public</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>void</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> Main()<br/>
  {<br/>
   </span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>//</span><span style='color: rgb(0, 128, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> TODO: Add your code here</span><br/>
            MessageBox.Show(Dts.Variables[<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_PROCESS_LOG_ID</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value.ToString());<br/>
            MessageBox.Show(Dts.Variables[</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>User::PV_USP_STATUS</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>].Value.ToString());<br/>
   Dts.TaskResult </span>= (<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>int</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>)ScriptResults.Success;<br/>
  }</span></span></code></pre><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191436093934358.png"/></p><p style="margin-left: auto;">保存并执行包，第一次弹出的是自增长的 PROCESS LOG ID。</p><p style="margin-left: auto;">第二次弹出是描述存储过程的执行状态编码 1。</p><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/191436479878701.png"/></p>
<ul class="aw-upload-file-list">
</ul>
</div>]
</body>
</html>
