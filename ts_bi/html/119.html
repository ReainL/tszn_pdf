
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<p>下面的这个查询返回每个财月的 Customer Count 和 基于上个月比较的 Growth in Customer Base 的记录，Slicer 是 Mountain bikes。</p><pre><code><span style="font-size: 14px;"><span style="color: #0000ff;">SELECT</span> {<br/>
              <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Customer Count</span><span style="color: #ff0000;">]</span>,<br/>
              <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span><br/>
   } <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">0</span>,<br/>
NON EMPTY {<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Month</span><span style="color: #ff0000;">]</span>.MEMBERS} <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Adventure Works</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">WHERE</span><br/>
( <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product Categories</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #808080;">&amp;</span><span style="color: #ff0000;">[</span><span style="color: #ff0000;">1</span><span style="color: #ff0000;">]</span> )</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/02233543-ee0be0e6f8f54de1940d2300d4d6fe3a.x-png"/></p><p>现在来看看如何统计在每个财月中正增长的天数，这是我自己的写法。</p><pre><code><span style="font-size: 14px;"><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">AS</span><br/>
<span style="color: #ff00ff;">COUNT</span>(<br/>
   FILTER(<br/>
       DESCENDANTS(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.CURRENTMEMBER,<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>),<br/>
       <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span> <span style="color: #808080;">&gt;</span> <span style="color: #800000; font-weight: bold;">0</span><br/>
        )<br/>
 )<br/>
<span style="color: #0000ff;">SELECT</span> {<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Customer Count</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
   } <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">0</span>,<br/>
NON EMPTY {<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Month</span><span style="color: #ff0000;">]</span>.MEMBERS} <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Adventure Works</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">WHERE</span><br/>
( <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product Categories</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #808080;">&amp;</span><span style="color: #ff0000;">[</span><span style="color: #ff0000;">1</span><span style="color: #ff0000;">]</span> )</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/02233649-e36024bbdab84519beb417092606a480.x-png"/></p><p>当然书上的写法更加简洁一些直接在 Filter 的基础之上取得了 COUNT，并且由于天位于叶节点，所以使用 DESCENDANTS 的 Leaves 关键字直接取到叶级别上的月中的每一天，使用的非常灵活。</p><pre><code><span style="font-size: 14px;"><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">AS</span><br/>
FILTER(<br/>
DESCENDANTS(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.CurrentMember, , leaves),<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span> <span style="color: #808080;">&gt;</span> <span style="color: #800000; font-weight: bold;">0</span><br/>
).<span style="color: #ff00ff;">COUNT</span><br/>
<span style="color: #0000ff;">SELECT</span> {<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Customer Count</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
   } <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">0</span>,<br/>
NON EMPTY {<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Month</span><span style="color: #ff0000;">]</span>.MEMBERS} <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Adventure Works</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">WHERE</span><br/>
( <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product Categories</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #808080;">&amp;</span><span style="color: #ff0000;">[</span><span style="color: #ff0000;">1</span><span style="color: #ff0000;">]</span> )</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/02233734-8cbb81d9677241f998c109ded0e42c9a.x-png"/></p><p>Filter 函数实际上是一个迭代函数并且并不是以一个块结构去运行的，因此会降低查询的效率。实际上这个查询可以使用 SUM IF 结构来完成，因此度量值 [Measures].[Growth in Customer Base] 指的就是增长的比率，我们只需要统计增长的天数就可以了。</p><pre><code><span style="font-size: 14px;"><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">AS</span><br/>
<span style="color: #ff00ff;">SUM</span>(<br/>
Descendants(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.CurrentMember, , leaves),<br/>
IIF( <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span> <span style="color: #808080;">&gt;</span> <span style="color: #800000; font-weight: bold;">0</span>, <span style="color: #800000; font-weight: bold;">1</span>, <span style="color: #0000ff;">NULL</span>)<br/>
)<br/>
<span style="color: #0000ff;">SELECT</span> {<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Customer Count</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Growth in Customer Base</span><span style="color: #ff0000;">]</span>,<br/>
 <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Positive number of days</span><span style="color: #ff0000;">]</span><br/>
   } <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">0</span>,<br/>
NON EMPTY {<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Month</span><span style="color: #ff0000;">]</span>.MEMBERS} <span style="color: #0000ff;">ON</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Adventure Works</span><span style="color: #ff0000;">]</span><br/>
<span style="color: #0000ff;">WHERE</span><br/>
( <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product Categories</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #808080;">&amp;</span><span style="color: #ff0000;">[</span><span style="color: #ff0000;">1</span><span style="color: #ff0000;">]</span> )</span></code></pre><p>那么这种写法好在什么地方呢？ 是因为 SUM 和 IIF 函数都是经过调优的可以在所谓的块模式下运行的，特别是当在 IIF() 函数中有一个分支的值是 NULL 的情况下是非常快的。 在现在我们的例子中可能看不出来这个效果，但是如果当数据量特别大的时候，就会发现 SUM-IIF 这种写法比起 FILTER-COUNT 这种写法在性能上有很大的提升。</p>
</div>]
</body>
</html>
