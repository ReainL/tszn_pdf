
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>今天想写一个有关计算 Week Number 的函数，刚开始觉得应该很简单，凭着感觉七写八写到最后发现越写越乱，到最后搞了快两个小时以为解决了，结果一测还有好多数据不正确。非常有挫败感！感觉很不服气，觉得很丢人，跑出去站了会，冷静下来，重新拿起纸笔认真的分析了一下，连写到测试快半个小时还是解决了。</p><p>在 SQL Server 中默认情况下，每周的开始都是从周日开始算起的。但是在国内也有不一样的要求，比如按照习惯往往要求每周从周一算起。这样一来之前在数据仓库中的 Week Number 可能就不准确了，因为可能很多时候都是按默认方式来生成 Week Number 的。</p><h2 id="articleHeader2">解决的方式</h2><p>这里有三种方式可以解决这个问题：</p><p>第一种方式是直接通过 SET DATEFIRST VALUE 来更改重新生成新的 DimDate，然后每次需要单独计算 Week Number 的时候根据 Date Key 关联一下就可以了，但这样就需要不断 JOIN DimDate，每一条记录都要 LookUp 一遍，不太好。</p><p>第二种方式就是在存储过程中需要使用到  Week Number 的时候，就先设置一下 SET DATEFIRST 然后在使用 DATEPART() 函数来获取 Week Number。这种方式需要每次都显示的  SET DATEFIRST ，不太方便。</p><p>第三种方式就是直接写一个函数，每次调用一下就可以了。</p><p>关于使用 SET DATEFIRST &lt;VALUE&gt; - &lt;VALUE&gt; 的值从 1 到 7，即周一到周日，默认值是 7。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201402/122115408175505.png"/></p><pre><code class="lang-sql"><span style="font-size: 13px;"><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> The default first date in a week is Sunday, the value is 7</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0); font-weight: bold;">@@DATEFIRST</span>  <br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Default DATEFIRST is Sunday</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2013-12-31</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 53</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2014-01-01</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 1</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2014-01-05</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 2</span><br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Change the DATEFIRST to 1, Monday will be the first day of week.</span><br/>
<span style="color: rgb(0, 0, 255);">SET</span> DATEFIRST <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <br/>
<br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0); font-weight: bold;">@@DATEFIRST</span>  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 1</span><br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> After change the DATEFIRST to Monday</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2013-12-31</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 53</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2014-01-01</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 1</span><br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATENAME</span>(WEEK,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2014-01-05</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekName  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 1</span></span></code></pre><p>要注意的是 SET DATEFIRST 只在当前执行中有效，也就说比如新开一个查询页面继续查询 SELECT @@DATEFIRST 则还是显示默认值 7。</p><p>在创建时间维度的代码中添加 SET DATEFIRST 1，表示每周以周一开始。</p><pre><code class="lang-sql"><span style="font-size: 13px;"><span style="color: rgb(0, 0, 255);">USE</span> BIWORK_SSIS<br/>
<span style="color: rgb(0, 0, 255);">GO</span>  <br/>
<span style="color: rgb(0, 0, 255);">SET</span> NOCOUNT <span style="color: rgb(0, 0, 255);">ON</span> <br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 设置每周的起始天为周一</span><br/>
<span style="color: rgb(0, 0, 255);">SET</span> DATEFIRST <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">DimDateStartWithMonday</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">U</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span> DimDateStartWithMonday<br/>
<span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span> DimDateStartWithMonday<br/>
(<br/>
    DateKey <span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span>,<br/>
    FullDate DATE <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateName</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">20</span>),<br/>
    DayNumberOfWeek <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    DayNameOfWeek <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">10</span>) <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    DayNumberOfMonth <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    DayNumberOfYear <span style="color: rgb(0, 0, 255);">SMALLINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>, <br/>
    WeekNumberOfYear <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    EnglishMonthName <span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">10</span>) <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    MonthNumberOfYear <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    CalendarQuarter <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    CalendarSemester <span style="color: rgb(0, 0, 255);">TINYINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span>,<br/>
    CalendarYear <span style="color: rgb(0, 0, 255);">SMALLINT</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span> <br/>
)<br/>
<br/>
<span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@StartDate</span> <span style="color: rgb(0, 0, 255);">DATETIME</span><br/>
<span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@EndDate</span> <span style="color: rgb(0, 0, 255);">DATETIME</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 128, 0);">@StartDate</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2001-01-01</span><span style="color: rgb(255, 0, 0);">'</span>,<br/>
       <span style="color: rgb(0, 128, 0);">@EndDate</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2035-12-31</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">WHILE</span> (<span style="color: rgb(0, 128, 0);">@StartDate</span> <span style="color: rgb(128, 128, 128);">&lt;=</span> <span style="color: rgb(0, 128, 0);">@EndDate</span>)<br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span><br/>
    <span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> DimDateStartWithMonday <br/>
    (<br/>
        DateKey,<br/>
        FullDate,<br/>
        <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateName</span><span style="color: rgb(255, 0, 0);">]</span>,<br/>
        DayNumberOfWeek,<br/>
        DayNameOfWeek,<br/>
        DayNumberOfMonth,<br/>
        DayNumberOfYear, <br/>
        WeekNumberOfYear,<br/>
        EnglishMonthName, <br/>
        MonthNumberOfYear,<br/>
        CalendarQuarter,<br/>
        CalendarSemester,<br/>
        CalendarYear <br/>
    )<br/>
    <span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">CAST</span>(<span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">8</span>),<span style="color: rgb(0, 128, 0);">@StartDate</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">112</span>) <span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(0, 0, 255);">INT</span>) <span style="color: rgb(0, 0, 255);">AS</span> DateKey,<br/>
           <span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">10</span>), <span style="color: rgb(0, 128, 0);">@StartDate</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">20</span>) <span style="color: rgb(0, 0, 255);">AS</span> FullDate,<br/>
           <span style="color: rgb(255, 0, 255);">CONVERT</span>(<span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">20</span>), <span style="color: rgb(0, 128, 0);">@StartDate</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">106</span>) <span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateName</span><span style="color: rgb(255, 0, 0);">]</span>,<br/>
           <span style="color: rgb(255, 0, 255);">DATEPART</span>(DW,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> DayNumberOfWeek,<br/>
           <span style="color: rgb(255, 0, 255);">DATENAME</span>(DW,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> DayNameOfWeek,<br/>
           <span style="color: rgb(255, 0, 255);">DATENAME</span>(DD,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DayOfMonth</span><span style="color: rgb(255, 0, 0);">]</span>,<br/>
           <span style="color: rgb(255, 0, 255);">DATENAME</span>(DY,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DayOfYear</span><span style="color: rgb(255, 0, 0);">]</span>,  <br/>
           <span style="color: rgb(255, 0, 255);">DATEPART</span>(WW,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> WeekNumberOfYear,<br/>
           <span style="color: rgb(255, 0, 255);">DATENAME</span>(MM,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> EnglishMonthName,<br/>
           <span style="color: rgb(255, 0, 255);">DATEPART</span>(MM,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> MonthNumberOfYear,<br/>
           <span style="color: rgb(255, 0, 255);">DATEPART</span>(QQ,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> CalendarQuarter,<br/>
           <span style="color: rgb(255, 0, 255);">CASE</span> <span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(MM,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(128, 128, 128);">BETWEEN</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">6</span><br/>
                    <span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
                <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span><br/>
           <span style="color: rgb(0, 0, 255);">END</span> <span style="color: rgb(0, 0, 255);">AS</span> CalendarSemester,<br/>
           <span style="color: rgb(255, 0, 255);">DATEPART</span>(YY,<span style="color: rgb(0, 128, 0);">@StartDate</span>) <span style="color: rgb(0, 0, 255);">AS</span> CalendarYear <br/>
            <br/>
    <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@StartDate</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@StartDate</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<span style="color: rgb(0, 0, 255);">END</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201402/122132458826767.png"/></p><p>最后是函数，这个函数麻烦的地方就是要考虑周日的情况。默认情况下，周日是每个星期的第一天，但是这里改成了周一是每周的第一天，逻辑上就会复杂很多。</p><p>比如，2012-01-01 是周日，2012-01-02 是周一。按默认情况，这两天的 Week Number 都是 1，但是这里需要把 2012-01-02 的 Week Number 变成 2。</p><p>比如，2011-01-01 是周六，2012-01-02 是周日。按默认情况，周六的 Week Number 是 1， 周日的是 2。但是这里需要把周六和周日的都变成 1， 周一的变成 2。</p><p>除此之外，还要考虑之后的每一个周日与周一的交替情况。</p><pre><code class="lang-sql"><span style="font-size: 13px;"><span style="color: rgb(0, 0, 255);">USE</span> BIWORK_SSIS<br/>
<span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ETLWORK_GETWEEKNUMBER</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">FN</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">FUNCTION</span> ETLWORK_GETWEEKNUMBER<br/>
<span style="color: rgb(0, 0, 255);">GO</span><br/>
 <br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">FUNCTION</span> ETLWORK_GETWEEKNUMBER(<span style="color: rgb(0, 128, 0);">@DATE</span> <span style="color: rgb(0, 0, 255);">DATETIME</span>)  <br/>
<span style="color: rgb(0, 0, 255);">RETURNS</span> <span style="color: rgb(0, 0, 255);">INTEGER</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(0, 0, 255);">BEGIN</span> <br/>
<br/>
    <span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span> <span style="color: rgb(0, 0, 255);">DATETIME</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEADD</span>(YYYY,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(YYYY,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>) <br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> DECLARE @MONDAY_OF_WEEK DATETIME = DATEADD(WK,DATEDIFF(WK,0,@DATE),0) </span><br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> DECLARE @PREVIOUS_DATE DATETIME = DATEADD(DAY,-1,@DATE)</span><br/>
    <span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(0, 0, 255);">INTEGER</span><br/>
<br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 如果当前时间是当前年的第一天</span><br/>
    <span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(0, 128, 0);">@DATE</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span><br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 星期天是年第一天的情况</span><br/>
    <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 0, 255);">IF</span> (<span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEKDAY,<span style="color: rgb(0, 128, 0);">@DATE</span>) <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 255);">DATEDIFF</span>(DAYOFYEAR,<span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>)<span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(128, 0, 0); font-weight: bold;">7</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>))  <br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>)  <br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 星期天不是年第一天的情况</span><br/>
    <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 0, 255);">IF</span> (<span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEKDAY,<span style="color: rgb(0, 128, 0);">@DATE</span>) <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 255);">DATEDIFF</span>(DAYOFYEAR,<span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>)<span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(128, 0, 0); font-weight: bold;">7</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">&lt;&gt;</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>)) <br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>) <span style="color: rgb(128, 128, 128);">-</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 如果当前天的上一个周日小于年第一天</span><br/>
    <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">DATEADD</span>(<span style="color: rgb(255, 0, 255);">DAY</span>,<span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>)) <span style="color: rgb(128, 128, 128);">&lt;</span> <span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span> <br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <br/>
    <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 当前天前面的一个周日正好是以周日为开始年的 7 倍的天数</span><br/>
    <span style="color: rgb(0, 0, 255);">ELSE</span> <span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">DATEDIFF</span>(DAYOFYEAR,<span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(<span style="color: rgb(255, 0, 255);">DAY</span>,<span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>) ))<span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(128, 0, 0); font-weight: bold;">7</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>) <br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>) <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>  <br/>
    <span style="color: rgb(0, 0, 255);">ELSE</span> <br/>
        <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>)   <br/>
           <br/>
    <span style="color: rgb(0, 0, 255);">RETURN</span> <span style="color: rgb(0, 128, 0);">@WEEK_NUMBER</span><br/>
<span style="color: rgb(0, 0, 255);">END</span><br/>
<span style="color: rgb(0, 0, 255);">GO</span></span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201402/122213364763703.png"/></p><p>为了方便理解，可以查看下面的查询。</p><pre><code class="lang-sql"><span style="font-size: 13px;"><span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@DATE</span> <span style="color: rgb(0, 0, 255);">DATETIME</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">2012-01-29</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<span style="color: rgb(0, 0, 255);">DECLARE</span> <span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span> <span style="color: rgb(0, 0, 255);">DATETIME</span> <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">DATEADD</span>(YYYY,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(YYYY,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>) <br/>
<br/>
<span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(255, 0, 255);">DATEPART</span>(WEEK,<span style="color: rgb(0, 128, 0);">@DATE</span>), <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 一年中的周数，默认以周日开始 </span><br/>
       <span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>), <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 当前周的周一，默认从周日开始，但是仍然找周一</span><br/>
       <span style="color: rgb(255, 0, 255);">DATEADD</span>(<span style="color: rgb(255, 0, 255);">DAY</span>,<span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>)), <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 当前周先找周一，然后往前一天找到周日</span><br/>
       <span style="color: rgb(255, 0, 255);">DATEDIFF</span>(DAYOFYEAR,<span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(<span style="color: rgb(255, 0, 255);">DAY</span>,<span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>))), <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 当前天离年第一天的间隔</span><br/>
       <span style="color: rgb(255, 0, 255);">DATEDIFF</span>(DAYOFYEAR,<span style="color: rgb(0, 128, 0);">@FIRST_DATE_OF_YEAR</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(<span style="color: rgb(255, 0, 255);">DAY</span>,<span style="color: rgb(128, 128, 128);">-</span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(255, 0, 255);">DATEADD</span>(WK,<span style="color: rgb(255, 0, 255);">DATEDIFF</span>(WK,<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>,<span style="color: rgb(0, 128, 0);">@DATE</span>),<span style="color: rgb(128, 0, 0); font-weight: bold;">0</span>) ))<span style="color: rgb(128, 128, 128);">/</span><span style="color: rgb(128, 0, 0); font-weight: bold;">7</span> <span style="color: rgb(128, 128, 128);">+</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>  <span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 按天计算的周数</span></span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201402/122211497056053.png"/></p><p>测试一下，查找不匹配的 Week Number - 30多年的数据结果都匹配，记得要新开一个页面，以免之前 SET DATEFIRST 的影响。 <img alt="" src="http://images.cnitblog.com/blog/477275/201402/122226165685284.png"/></p><p>查询部分数据的 WeekNumber。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201402/122229259993424.png"/></p><p>当然，我感觉写的还是有点复杂，谁解决过类似问题的，期望有人能提出更简洁的写法。<br/></p>
</div>]
</body>
</html>
