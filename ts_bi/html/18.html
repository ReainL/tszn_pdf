
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p>在比较大的 ETL 项目中，父子包的使用频率非常的高。包括在一些自定义的 ETL 包调度框架中，父子包的使用构成了这些框架的基础。在 ETL 项目中使用父子包主要处于以下几点考虑：</p><ol><li>ETL 项目的并行开发 - 可以多人同时开发 ETL 子模块，最后统一集成到父包中。</li><li>业务模块的划分 - 不同的业务模块需要拆分到各个子包，最后组装起来，避免单个包业务逻辑过于复杂，模块划分不清的问题。</li><li>避免整个包失败的问题 - 避免因一个 Task 或者模块失败而导致整个包失败，在有的业务中是允许部分模块失败而其它模块可以继续执行的。</li><li>并行执行提高效率 - 多个子包并行执行，最大可能的利用服务器上的资源，提高整个 ETL 的执行效率。</li><li>共同参数，配置信息的控制 - 业务模块交叉的一些参数，配置都可以放在父包中完成，包括验证等。避免多个包中重复的参数配置，参数验证。</li></ol><h3 id="articleHeader2" style="margin-left: 0px;">案例的设计</h3><p>下面的案例通过一个父包，两个子包来演示父子包的调用过程并且演示子包引用父包参数的过程。</p><p>设计一张表对象，这是我们的目标表。</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IF</span> <span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>OBJECT_ID</span>(<span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>T014_PROCESS_LOG</span><span style='color: rgb(255, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>'</span>) <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>IS</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>NOT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DROP</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>TABLE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> T014_PROCESS_LOG<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GO</span><br/>
<br/>
<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>CREATE</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>TABLE</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> T014_PROCESS_LOG<br/>
(<br/>
    EXECUTION_ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
    PARENT_EXECUTION_ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
    PACKAGE_NAME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
    MACHINE_NAME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NVARCHAR</span>(<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>255</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>),<br/>
    START_TIME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DATETIME</span>  <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>,<br/>
    FINISH_TIME </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>DATETIME</span>  <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>,<br/>
    EXECUTE_STATUS_ID </span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INT</span><span style='color: rgb(0, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'> <br/>
)<br/>
<br/>
</span><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>SELECT</span> <span style='color: rgb(128, 128, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>*</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>FROM</span> T014_PROCESS_LOG </span></code></pre><h4 id="articleHeader3" style="margin-left: 0px;">父包的创建</h4><p>创建一个父包，并创建一个 Execute SQL Task，SQL Statement -</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INSERT</span> <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>INTO</span> T014_PROCESS_LOG <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>VALUES</span>(?,?,?,?,<span style='color: rgb(255, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>GETDATE</span>(),<span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>NULL</span>,<span style='color: rgb(128, 0, 0); font-weight: bold; font-family: "Courier New" !important; line-height: 1.5 !important;'>1</span>)</span></code></pre><p style="margin-left: auto;">由于父包是没有父级 Execution 的，因此 EXECUTION_ID 和 PARENT_EXECUTION_ID 是相同的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192052516593606.png"/></p><p>新建一个变量 PV_EXECUTION_ID，这个变量是通过一个表达式计算而来的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192053181121058.png"/></p><p>拖放如下变量到表达式 Expression 中，这样在包执行过程中，变量 PV_EXECUTION_ID 的值将等同于系统变量 System::ExecutionInstanceGUID。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054108154489.png"/></p><h4 id="articleHeader4" style="margin-left: 0px;">子包的创建与参数传递</h4><p>创建一个新的Package，并新建一个变量 PP_EXECUTION_ID，这个变量将会接受来自于父包的 Execution ID。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192053506286989.png"/></p><p>回到包中，右键查看 Package Configurations 选项。如果没有这个选项(2012之前直接显示，2012需要先在属性中使用，之后会出现在左侧右键出现的位置)，那么应该在包的属性中查找 Configurations，点击进入。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054204407582.png"/></p><p>启用包配置并添加。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054299096190.png"/></p><p>Configuration Type 选择 Parent package variable，Parent Variable 填入父包中的变量名称 PV_EXECUTION_ID。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054382685769.png"/></p><p>下一步选择子包中的变量，选择它的Value 属性，那么这一步的作用就是将父包中 PV_EXECUTION_ID 的值传递给子包中的变量 PP_EXECUTION_ID。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054454879263.png"/></p><p>为这个配置取一个名字 - PARANET_CONFIG，可以在下面看到具体的变量信息。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192054566431855.png"/></p><p>在子包中新建一个 Execution SQL Task，其连接方式和父包一样，SQL 语句一样，Data Mapping 中使用的是 PP_EXECUTION_ID，它将接受来自父包 PV_EXECUTION_ID 的值。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192055105341946.png"/></p><p>保存这个子包，并且按照同样的方式创建另外一个子包，包括上述的配置。</p><h4 id="articleHeader5" style="margin-left: 0px;">父子包的关联</h4><p>在父包中 Execute SQL Task 之后拖放一个 Sequence Container，并在 Sequence Container 中拖放两个 Execute Package Task，每一个 Task 将绑定一个子包文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192055280811919.png"/></p><p>按照下方完成配置，如果 Connection 没有选项的时候，是需要新建一个文件连接，这个文件连接指向包文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192055435817249.png"/></p><p>文件连接管理器连接到子包文件，两个子包通过这种方式连接到了父包当中。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192056021286348.png"/></p><p>执行父包，在 Sequence Container 中两个子包都会被并行执行。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/192056131436684.png"/></p><p>可以看到一次写入三条记录，第一条是父包写入的，第二条和第三条分别是两个子包写入的，但是他们的 PARENT_EXECUTION_ID 都是同一个，说明他们是来自于同一个父包的某一次执行。</p><p><img alt="" height="155" src="http://images.cnitblog.com/blog/477275/201409/192056246757460.png" width="961"/></p>
<ul class="aw-upload-file-list">
</ul>
</div>]
</body>
</html>
