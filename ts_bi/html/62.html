
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>关于 Slowly Changing Dimension 缓慢渐变维度的理论概念请参看 <a href="http://www.flybi.net/blog/biwork/974"><u><font color="#0066cc">数据仓库系列 - 缓慢渐变维度 (Slowly Changing Dimension) 常见的三种类型及原型设计</font></u></a></p><p>本篇文章总结了实现缓慢渐变维度的几种方式，并且分析了 Changing Attribute 和 Historical Attribute 输出的逻辑过程。</p><ul><li>示例一：SSIS 中使用 Slowly Changing Dimension 控件</li><li>示例二：使用 SQL 中 Merge 语句实现简单的 SCD 效果</li><li>示例三：在 SSIS 中使用 Lookup, Conditional Split, Multicast 等控件实现 SCD 效果</li></ul><h2 id="articleHeader2">测试表以及测试数据</h2><p>其中 Customer 是数据源表，DimCustomer 模拟的是数据仓库中的 Customer 维度表。</p><p>每个示例都是从空表开始，第一次运行的时候 Dimension 表没有数据，第二次运行之前将添加几条数据到 Customer 数据源表中，并同时修改若干数据。</p><p>但是要注意这个示例对数据源数据的加载是全部加载，而不考虑基于数据源数据的增量加载，关于增量加载的实现会放在 BI 系列的其它文章中讲解。</p><pre><code><span style="color: rgb(0, 0, 255);">USE</span><span style="color: rgb(0, 0, 0);"> BIWORK_SSIS<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Customer</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> Customer <br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> DimCustomer <br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> Customer<br/>
(<br/>
    ID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span> <span style="color: rgb(255, 0, 255);">IDENTITY</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">),<br/>
    FullName </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    City </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    Occupation </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">)<br/>
)<br/>
<br/>
</span><span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> DimCustomer <br/>
(<br/>
    CustomerID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span> <span style="color: rgb(255, 0, 255);">IDENTITY</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">),<br/>
    CustomerAlternateKey </span><span style="color: rgb(0, 0, 255);">INT</span><span style="color: rgb(0, 0, 0);">,<br/>
    FullName </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    City </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    Occupation </span><span style="color: rgb(0, 0, 255);">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    StartDate </span><span style="color: rgb(0, 0, 255);">DATETIME</span><span style="color: rgb(0, 0, 0);">,<br/>
    EndDate </span><span style="color: rgb(0, 0, 255);">DATETIME</span><span style="color: rgb(0, 0, 0);">,<br/>
    IsCurrent </span><span style="color: rgb(0, 0, 255);">BIT</span> <span style="color: rgb(0, 0, 255);">DEFAULT</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">)<br/>
)<br/>
<br/>
</span><span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> BIWORK_SSIS.dbo.Customer <span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);"><br/>
(</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">BIWORK</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Beijing</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">IT</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),<br/>
(</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">ZhangSan</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Shanghai</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Education</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),<br/>
(</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Lisi</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Guangzhou</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Student</span><span style="color: rgb(255, 0, 0);">'</span>)</code></pre><h2 id="articleHeader3">示例一  SSIS 中的 Slowly Changing Dimension</h2><p>新建一个 Package 并拖放一个 Data Flow，在 Data Flow 中建立好与 Customer 表的数据源连接，新建 Slowly Changing Dimension SCD_DimCustomer。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201310/13203457-44f35791d5184215afe63e690dd4a5db.png"/></p><p>双击 SCD_DimCustomer 编辑相关的属性。</p><p>Input Columns 来源于上游数据源即 Customer 表，Dimension Columns 描述 DimCustomer 表信息。</p><p>Key Type - Business Key 表示 Customer.ID 与 DimCustomer.CustomerAlternateKey 关联，后面的数据更新或者插入就跟这个 Business Key 相关。</p><p>其主要逻辑是以 Customer.ID 对比 DimCustomer.CustomerAlternateKey ，如果关联不到则表示 Customer 中有新数据则将新数据插入到 DimCustomer 中。</p><p>如果关联到则检查哪些字段是不需要更新 SCD Type 0，哪些字段的数据是需要更新的 SCD Type 1。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15211043-fd5d6aaaa61f433b99292b30fb1fcb91.png"/></p><p>下一步设计 DimCustomer 表中几个属性字段。</p><p>City - 历史数据，如果 City 发生更改则添加一条新的数据而保留此历史信息 - Type 2。</p><p>FullName - 固定的值，此字段的数据在数据仓库中不发生更改 - Type 0。</p><p>Occupation - 可更改的值，如果 Occupation 发生更改则只修改它而不保留历史信息 - Type 1。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201310/15211642-8049b5df5886457292ded2a29802d2eb.png"/></p><p> 在这里暂时不设置 - 如果检测到 Customer 中 FullName 发生更改就报错。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15213545-b514b23fcc2b4d8284420eb0f15e0ceb.png"/></p><p>对于 Type 2 Historical Attribute 的设计是使用有效时间段来表示的，具体的理论概念请参看 <a href="http://www.cnblogs.com/biwork/p/3363749.html"><u><font color="#0066cc">数据仓库系列 - 缓慢渐变维度 (Slowly Changing Dimension) 常见的三种类型及原型设计</font></u></a> 其中有详细的讲解。第一个选择是使用标志字段来表示这个记录是否到期或者是当前使用的，在我们现在的这个例子中可以先设计为有效期，后面可以修改让两种方式都存在。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201310/15213700-e589388aec35454bae3422da86e9e148.png"/></p><p>推断成员的设置，暂时这里不设置推断成员。推断成员一般发生在维度表的数据载入落后于Fact事实表的数据载入，因此Fact事实表数据加载在前因此就引用不到相应的Dimension Key而造成这个问题，这个以后会专门写一篇文章来讨论推断成员。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15214106-81e5d6520ac14448ba80c73a3087368c.png"/></p><p>Slowly Changing Dimension 这个控件此时会产生两个分支逻辑三组输出。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15214408-a3172e2e87214f89b439e6465527bca0.png"/></p><p>设置完了之后会自动生成其它的所有逻辑，并且已经帮助实现了 SCD 的功能。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15214555-cad12c939e0c4d62bcf2134b168eae89.png"/></p><p>执行之后看看具体的效果 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15215747-0785be1ec3044716b78a693b21b8e6a9.png"/></p><p>分析一下 Slowly Changing Dimension 的逻辑。</p><p>其中 New Output 输出就是直接插入新的纪录到 DimCustomer 中。</p><p>Historical Attribute Insert Output 向下的 OLE DB Command 中 SQL 语句为 -</p><pre><code><span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CustomerAlternateKey</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(0, 0, 255);">NULL</span></code></pre><p>对于历史的数据应该是修改 EndDate 将这条数据表示终止状态，并且继续添加一条新的数据。在这里因为多添加了一个 IsCurrent 来表示记录的状态，因此这条 SQL 语句应该修改为：IsCurrent = 0，这个逻辑需要在 SSIS 中做出细微的调整。</p><pre><code><span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ?, <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">IsCurrent</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CustomerAlternateKey</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(0, 0, 255);">NULL</span></code></pre><p>Changing Attribute Update Output 向下的 OLE DB Command 1 中 SQL 语句为 -</p><pre><code><span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Occupation</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CustomerAlternateKey</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(0, 0, 255);">NULL</span></code></pre><p>对于 SCD Type 1 的属性只需要直接更改即可，因此直接根据 Customer.ID 即关联到的 DimCustomer.CustomerAlternateKey 修改相应的属性。</p><p>对于 Historical Attribute Insert Output 下的 Derived Column 和 OLE DB Command 中作出的修改：</p><p>Derived Column 新增加一个 HistoricalCurrent ，其值为0，用来表示当条记录为历史记录。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15220735-66e9208d9196486f81cc2a26e9b2cc9f.png"/></p><p>修改 SQL 语句</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15220752-6f9f8a7dc5524b4ca5198cfc4d19dbf4.png"/></p><p>修改 Column Mapping</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15220801-49c7bfd5557d43d5adfae24a3813a7c2.png"/> </p><p>对源数据做出一定的修改：</p><pre><code><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 新插入一条</span><br/>
<span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">INTO</span> BIWORK_SSIS.dbo.Customer <span style="color: rgb(0, 0, 255);">VALUES</span><span style="color: rgb(0, 0, 0);"><br/>
(</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Wangwu</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Beijing</span><span style="color: rgb(255, 0, 0);">'</span>,<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Finance</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">)<br/>
<br/>
</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 修改 Changing Attribute </span><br/>
<span style="color: rgb(0, 0, 255);">UPDATE</span><span style="color: rgb(0, 0, 0);"> BIWORK_SSIS.dbo.Customer<br/>
</span><span style="color: rgb(0, 0, 255);">SET</span> Occupation <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">IT</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<span style="color: rgb(0, 0, 255);">WHERE</span> ID <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">3</span> <br/>
<br/>
<span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 同时修改 Changing Attribute 和 Historical Attribute </span><br/>
<span style="color: rgb(0, 0, 255);">UPDATE</span><span style="color: rgb(0, 0, 0);"> BIWORK_SSIS.dbo.Customer<br/>
</span><span style="color: rgb(0, 0, 255);">SET</span> Occupation <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Publisher</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">,<br/>
    City </span><span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">Hangzhou</span><span style="color: rgb(255, 0, 0);">'</span><br/>
<span style="color: rgb(0, 0, 255);">WHERE</span> ID <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">2</span></code></pre><p>再次执行 SSIS Package 并查询数据库结果 -</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201310/15221559-07795628b7eb493598a131307e54e593.png"/></p><p>新增的一条数据是 Wangwu ，因此将直接添加新的一条记录到 DimCustomer 中。</p><p>ZhangSan 因为修改了 City ，因此属于 Type 2 SCD 需要保留历史数据。所以先修改 ZhangSan 的 EndDate 和 IsCurrent 保留这条历史数据，然后再将最新的数据添加到 DimCustomer 中，也就是最后看到的 ZhangSan - Hangzhou - Publisher</p><p>Lisi 因为修改了 Occupation 属于 Type 1 SCD 只需要修改原数据即可，所以 Lisi 的 Occupation 直接更新为 IT 即可。</p><h2 id="articleHeader4">逻辑图解</h2><p>下面是对 SCD Type 1 和 Type 2 实现逻辑的总结，如果理解了这些逻辑我们也完全可以用其它的 SSIS 控件来实现 SCD 的功能。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15222525-3a4f6de517344027a28dc76afedb91bd.png"/></p><p>Type 2 SCD 要比 Type 1 要复杂一些，它有一个 Update 之后的 Insert 操作。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15222539-3db33c31a8124ace938872a2ee40e456.png"/></p><h3 id="articleHeader5">示例二 - 使用 SQL 中 MERGE 语句实现 SCD Type 1 和 SCD Type 2 的功能</h3><p>SQL MERGE 语句非常实用，可以非常简单的根据一些关联条件来比较两个表的数据，然后决定匹配的逻辑如何执行和不匹配的时候逻辑如何处理。关于 SQL MERGE 的语法和使用请参照 <a href="http://www.cnblogs.com/biwork/p/3370335.html"><u><font color="#0066cc">SQL Server - 使用 Merge 语句实现表数据之间的对比同步</font></u></a></p><p>使用 MERGE 语句来实现上面的效果</p><pre><code><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Type 2 SCD</span><br/>
MERGE <span style="color: rgb(0, 0, 255);">INTO</span> dbo.DimCustomer <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> Dim<br/>
USING dbo.Customer </span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> Src<br/>
    </span><span style="color: rgb(0, 0, 255);">ON</span> Dim.CustomerAlternateKey <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> Src.ID<br/>
</span><span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(128, 128, 128);">NOT</span> MATCHED <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> TARGET<br/>
    </span><span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">VALUES</span>(Src.ID,Src.FullName,Src.City,Src.Occupation,<span style="color: rgb(255, 0, 255);">GETDATE</span>(),<span style="color: rgb(0, 0, 255);">NULL</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">)<br/>
</span><span style="color: rgb(0, 0, 255);">WHEN</span> MATCHED <span style="color: rgb(128, 128, 128);">AND</span> Dim.City <span style="color: rgb(128, 128, 128);">&lt;&gt;</span><span style="color: rgb(0, 0, 0);"> Src.City<br/>
    </span><span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(0, 0, 255);">SET</span> Dim.EndDate <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(255, 0, 255);">GETDATE</span>(),Dim.IsCurrent <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">0</span><span style="color: rgb(0, 0, 0);">  <br/>
;<br/>
<br/>
</span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Type 1 SCD</span><br/>
MERGE <span style="color: rgb(0, 0, 255);">INTO</span> dbo.DimCustomer <span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> Dim<br/>
USING dbo.Customer </span><span style="color: rgb(0, 0, 255);">AS</span><span style="color: rgb(0, 0, 0);"> Src<br/>
    </span><span style="color: rgb(0, 0, 255);">ON</span> Dim.CustomerAlternateKey <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> Src.ID<br/>
    </span><span style="color: rgb(128, 128, 128);">AND</span> Dim.IsCurrent <span style="color: rgb(128, 128, 128);">=</span> <span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><br/>
<span style="color: rgb(0, 0, 255);">WHEN</span> <span style="color: rgb(128, 128, 128);">NOT</span> MATCHED <span style="color: rgb(0, 0, 255);">BY</span><span style="color: rgb(0, 0, 0);"> TARGET<br/>
    </span><span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">INSERT</span> <span style="color: rgb(0, 0, 255);">VALUES</span>(Src.ID,Src.FullName,Src.City,Src.Occupation,<span style="color: rgb(255, 0, 255);">GETDATE</span>(),<span style="color: rgb(0, 0, 255);">NULL</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">)<br/>
</span><span style="color: rgb(0, 0, 255);">WHEN</span> MATCHED <span style="color: rgb(128, 128, 128);">AND</span> Dim.Occupation <span style="color: rgb(128, 128, 128);">&lt;&gt;</span><span style="color: rgb(0, 0, 0);"> Src.Occupation<br/>
    </span><span style="color: rgb(0, 0, 255);">THEN</span> <span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(0, 0, 255);">SET</span> Dim.Occupation <span style="color: rgb(128, 128, 128);">=</span><span style="color: rgb(0, 0, 0);"> Src.Occupation <br/>
;</span></code></pre><p>因为在 MERGE 语句中有一些语法限制</p><ul><li>在 Merge Matched 操作中，只能允许执行 UPDATE 或者 DELETE 语句。</li><li>在 Merge Not Matched 操作中，只允许执行 INSERT 语句。</li><li>一个 Merge 语句中出现的 Matched 操作，只能出现一次 UPDATE 或者 DELETE 语句，否则就会出现下面的错误 - An action of type 'WHEN MATCHED' cannot appear more than once in a 'UPDATE' clause of a MERGE statement.</li><li>Merge 语句最后必须包含分号，以 ; 结束。</li></ul><p>所以在这里采取的方式是：</p><p>Type 2 SCD 注释的地方 - 根据 Customer.ID = DimCustomer.CustomerAlternateKey 关联如果没有找到匹配的记录，就意味是新数据，直接插入到 DimCustomer 表中。</p><p>如果匹配到了即此数据在维度表中也存在，因此先将此记录更新完毕标志此条记录为历史记录 - EndDate 和 IsCurrent 都设置了值表示 SCD Type 2。</p><p>Type 1 SCD 注释的地方 - 因为刚才的历史记录已经被标识为 IsCurrent = 0， 因此在此时的逻辑将匹配不到数据，因此作为新数据插入，这样就延续了 SCD Type 2 Update 之后的 Insert 操作。</p><p>对于匹配到的数据，再来比较 SCD Type 1 的列，如果不匹配的话那么就直接更新掉就可以了。</p><p>和示例一使用相同的测试数据和相同的数据修改方式后，执行完的效果也是一样的。</p><p>第一次执行</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15224604-4ee0d37d592c40fe9e3b4ec207788d2a.png"/></p><p>修改完测试数据之后再次执行</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15224628-cde20735f69f474096175e9c07f09a8d.png"/></p><hr/><p>在 SSIS 中使用 Lookup, Conditional Split, Multicast 等控件实现 SCD 效果</p><p>一旦理解了 SCD 的实现逻辑，我们完全可以自己通过 SSIS 中的其它 Task 来实现 Slowly Changing Dimension。</p><p>会使用到的 Task 包括 Lookup，Multicast，Conditional Split 等。</p><p>可以参看相应的 Task 的Demo 和一些原理介绍：</p><ul><li><a href="http://www.cnblogs.com/biwork/p/3296602.html"><u><font color="#0066cc">微软BI 之SSIS 系列 - Lookup 组件的使用与它的几种缓存模式 - Full Cache, Partial Cache, NO Cache</font></u></a></li><li><a href="http://www.cnblogs.com/biwork/p/3296602.html"><u><font color="#0066cc">微软BI 之SSIS </font></u></a>系列 - 在 SSIS 中使用 Multicast Task 将数据源数据同时写入多个目标表，备份数据表，以及写入Audit 信息</li></ul><p>新建一个 Data Flow Task 并且仍然将 Customer 表作为数据源，拖放一个 Lookup Task 并完成以下配置。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15230306-74ee9cd5c1364bb8a52d4680d8c7d703.png"/></p><p>LKP_DimCustomer 中 Reference Table 引用集/引用表是 DimCustomer。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15230317-da4bd0a52bf24560a7f25bdff1905e63.png"/></p><p>左边是Customer表，右边是要去 Look Up 的 DimCustomer，Customer.ID = DimCustomer.CustomerAlternateKey 关联。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15230527-616922c878114de6a4fb98438bab6bab.png"/></p><p>基于 Customer.ID = DimCustomer.CustomerAlternateKey 就会有两种结果，匹配的输出和不匹配的输出。</p><p>不匹配的输出就是添加新数据。</p><p>匹配的输出就是要去检查 Historical Attribute "City" 有没有更改，如果有更改就是一次 Update 然后加上一次 Insert 操作。</p><p>如果 Changing Attribute "Occupation" 有更改就是一次 Update 操作。</p><p>中间会使用到的三个状态 - StartDate , EndDate, IsCurrent 都会在整个流程中使用到，主要用来更新它们的状态。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15230624-e4f9e2175cac4095b7ba2f21d8fdfb1c.png"/></p><p>先实现不匹配的逻辑，即先添加一条新的数据。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15231547-6853c4424e4841ca8a7dac4e84f56e93.png"/></p><p>DC_NewInsertStartDate 需要准备 StartDate 和 IsCurrent = 1</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15231642-77c02c0f86ff4fc695d86f0c701fea7f.png"/></p><p>OLE_DST_DimCustomer 的配置</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15231720-9433697ef45646e9ab6102469671317c.png"/></p><p>Customer.ID = DimCustomer.CustomerAlternateKey 匹配的情况下有两种情况：</p><p>City 不匹配 和 Occupation 不匹配，添加一个 Conditional Split 并连接到 Lookup 的匹配输出上。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15232123-606aaacd166c487e832805574109b939.png"/></p><p>下面是全部的实现效果 - Changing Update 下的逻辑是直接修改 DimCustomer 的数据，OLE_CMD_Update 中</p><pre><code><span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Occupation</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CustomerAlternateKey</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(0, 0, 255);">NULL</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15233045-cf39fa4340a04d3f814469a534ef6d47.png"/></p><p>Historical_Update 下使用了一个 Multicast 将数据流分为两个分支，因为它是 Historical Attribute Update，因此逻辑是更新原历史数据，添加新数据。</p><p>OLE_CMD_UpdateHistorical 中的 SQL 语句，这里的 IsCurrent 将最终更新为 0 。</p><pre><code><span style="color: rgb(0, 0, 255);">UPDATE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">dbo</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DimCustomer</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">SET</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? ,IsCurrent <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(0, 0, 255);">WHERE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">CustomerAlternateKey</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(128, 128, 128);">=</span> ? <span style="color: rgb(128, 128, 128);">AND</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EndDate</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(0, 0, 255);">NULL</span></code></pre><p>使用前两个示例中的测试数据，第一次执行完 SSIS Package 之后三条数据走向了 Lookup No Match Output 表示新数据。 </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15234710-472e034aed8847d6826486b31757b2ee.png"/></p><p>查询数据表结果</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15234749-309ac931cff84a06b3d9155603c5b172.png"/></p><p>修改完测试数据之后再次执行，数据源 1 条是新数据走向 Lookup No Match Output，1 条是 Historical Update 因此需要 Update 历史数据然后再添加一条新数据，1 条是 Changing Update 因此直接 Update 就可以了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15234811-fd647f3de92343ef8a9f04774fcf90e5.png"/></p><p>执行效果如下所示</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201310/15234952-25d88eb5427e4cd1b04dad1d7dfb5e95.png"/></p><hr/><p>那么至此，这三种对于 Slowly Chaning Dimension 缓慢渐变维度的实现就全部演示完了。从中可以发现，整个 SCD 处理的逻辑在三个示例中本质上都是一样的。都是围绕着 Business Key 匹配和不匹配的结果来展开的，并且在这个过程中区别了 SCD Type 1 和 Type 2。对于 Type 1 就是一个更新操作，对于 Type 2 不仅有更新操作而且还有插入操作。只要理解了它们的实现逻辑，使用不同的方式实现起来并不困难。</p><p>这三种方式中，第一种方式即直接使用 SSIS 中提供的 SCD Task 实现起来最为简单，基本上都是配置性的内容。但是往往因为数据量过大可能造成性能上的问题，因此才会有示例二和示例三中出现的方法。第二种方式代码更为直接，但是如果遇到多个属性变化，在代码上会有一些变化，这个需要仔细认真的检查和测试。第三种方式相对于第一种方式要花费更多的时间，但是在实现方式上可以更为灵活的满足各种需要。</p><p>我并没有基于这三个示例做出性能上的测试，因为在实际的维度变化设计中，Historical Attribute 和 Changing Attribute 可能不止一个，可能会有多个。并且维度表的大小，数据源表的大小对性能上的影响也都存在。所以在这里只是提出常用到可以解决 SCD 问题的几种方式，并且可以根据实际的需求进行缓慢维度变化设计，根据实际测试的效率高低来选择合适的方案。</p><p>写的比较多，总结如果有不足或者遗漏之处还望指出，谢谢！ 另外：关于 Inferred Member 会另外专门写随笔总结！</p><p>PS：后面两个案例实际上是有错误的，大家如果仔细看的话。在检查历史数据的情况下，Lookup Dim 包括 Merge 里面的查找对比是应该要加上一个条件的 IsCurrent = 1，因为在比较 CustomerAlternateKey 的时候是只能与当前记录对比的，而不应该包含历史记录部分的对比。Multicast 可以去掉，将插入挪到更新之后，这样保证更新历史在前，插入新纪录在后。</p><p>上面的图片和文字我就不一一修改了，保留这些错误让大家也能看到这些错误的原因和解决过程，请大家自行测试发现错误纠正。<br/></p>
</div>]
</body>
</html>
