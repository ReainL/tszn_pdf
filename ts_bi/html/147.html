
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>在与数据库相关的项目中，比如像数据库维护、性能警报、程序出错警报或通知都会使用到在 SQL Server 中配置Email发送邮件的功能。</p><p>在BI项目中，这种功能也使用的比较多。比如 SSIS Package 一般会配置到 SQL Server Agent 按计划执行，这时 Package 执行失败后就需要在 Job 中发送邮件通知以及时排除错误。有的时候在 Package 级别也会将错误信息存入 Error Log中， 使用触发器来发送邮件，以防止 Job 中的Notification 没有配置成功或者禁用。</p><h2 id="articleHeader2">Database Mail 邮件的配置</h2><p>一个基于表级别, 一个基于 Job 级别，它们都需要使用到基本的邮件配置功能。</p><p>开始配置邮件服务。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233452-2b863d49d9ee47319e6ee62535eb788e.png"/></p><p> </p><p>第一次配置使用。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233504-1b70a8209056481f801c30f816382dd9.png"/></p><p> 填好 Profile 名称，它在很多地方会用到，并点击添加来添加一个新的 SMTP 账户。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233516-c5d9da923af6483f99dc5ffb451a72bd.png"/></p><p>添加 SMTP 账户，我个人使用的是126的邮箱，可以在它们官网上搜索一下它的SMTP服务器地址。</p><p>在SMTP账户验证的时候输入邮箱地址和密码。 </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233531-fbd79a40a64b437fbf88639bb5e677b4.png"/></p><p>下一步</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233549-10acc2bb0ddd47deb6946e978f1a1b1f.png"/></p><p>再下一步</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233611-a8792cda8a414f629f0d3e89598c8b2b.png"/></p><p>基本上可以直接使用默认配置，或者可以选择性的添加禁止发送的文件后缀。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233628-aa51de1e2c53463b9c1c8474e6d18def.png"/></p><p>完成</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233639-396c4cd26c84419e98889d45959f97d4.png"/></p><p>下面就要开始简单测试一下邮件发送的功能</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233653-cb7f0a9d0394400882fae1e9acf6f03f.png"/></p><p>测试自己发给自己</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233706-9b46c402cc1d4b40b280e5bb5f9c3496.png"/></p><p>有的时候会有一些延迟，第一次稍微等下就可以了。如果没有发送成功，一般的情况就是账户配置不正确，比如用户名和密码，第二个常见的错误就是 SMTP 服务器的设置不正确。</p><p>显示发送成功！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233717-f7125cf352ec47618b3836033c568e59.png"/></p><h2 id="articleHeader3">SQL Server Agent 上的配置</h2><h3 id="articleHeader4">新建一个测试 JOB<br/></h3><p>首先启用 SQL Server Agent</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233732-cbddd64f3726438a8603437bd6097644.png"/></p><p>先添加一个 Operator 操作员</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234442-daa20dd85c18467287224b89f49480d0.png"/></p><p>使用 withinker@126.com 作为接收邮件地址，SMTP 是发送邮件的账户，这里的Notification 是接收邮件的账户。</p><p>这个地址最好是一个公共邮件地址，能够映射或者包含整个团队的所有邮件，这样可以保证团队中的每一位成员都可以接受到邮件通知。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233753-44e542c9911444fbb17fc5ca5244b3fd.png"/></p><p>更改 SQL Server Agent 属性。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233803-1f081434953e4c579794b96d4866e15e.png"/></p><p>在 Alert System 中选择好之前配置好的 BIWORK Profile 它包含了 SMTP 发送邮件服务的 biwork@126.com 账户。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233818-e9bc083f4269479a987be7cc9c2334d5.png"/></p><p>一般可以不重启 SQL Server Agent，但是如果后来测试没有生效的话可以重启试一下。</p><p>那么这样 SQL Server Agent 的操作员和通知就已经配置完毕了，我们可以创建一个测试Job来测试一下，当JOB 完成时发送一个通知到操作员 <a href="mailto:withinker@126.com"><u><font color="#0066cc">withinker@126.com</font></u></a></p><h3 id="articleHeader5">测试 JOB 中的邮件发送</h3><p>新建一个 Job - TestJob</p><p> </p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07233845-149b4f931c17466d925a08473dac1674.png"/></p><p>在 Step 中创建一个简单的 SELECT 查询，实际使用中在这里还可以配置 SSIS Package 完成 ETL操作</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234041-593324b06fbf428d9d9ba1871f698fb1.png"/></p><p>还可以演示一下，作一个计划，每分钟执行这个步骤依次来模拟实际 JOB 计划。</p><p>把计划时间改成1分钟，也就是说1分钟这个 SQL 语句就会被执行1次。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234116-bcafff2743b74c9fb5eb24acb64409cd.png"/></p><p>在通知中，设置好操作员 withinker。并且为了演示邮件通知的效果，设置为当JOB执行完成后就发送邮件。实际应用中应该是JOB执行失败时发送邮件，这个可以在之后来调整。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234134-d10f4ebb44e946449e6614c155c8b0ba.png"/></p><p>配置完成后，就耐心等待准备一分钟接收一封通知邮件吧！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234149-66a9a273ffe34d378f073bca84faf11f.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201308/07234200-5281bad84cd44bad9d67d58a4e84e42a.png"/></p><p>到这里为止，整个邮件配置，操作员配置和JOB邮件通知的配置就完成了！<br/></p>
</div>]
</body>
</html>
