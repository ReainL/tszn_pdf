
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>这个问题来自于 <a href="http://www.flybi.net/question/1124"><u><font color="#0066cc">天善BI社区</font></u></a>，看了一下比较有意思，因为我自己认为在 SSIS中处理各种类型文件的经验还比较丰富(有一年的时间几乎所有ETL都跟文件相关)，但是这个问题确实之前没有特别考虑过。研究了一下，找到了解决的方法，赶紧记录下来。</p><p>简单描述一下这个问题，如果我们的 SOURCE 是直接从表里面查询，然后输出到文件的时候，查询语句中列的顺序就是输出文件列的顺序(逗号分隔的文件)。但是如果使用变量查询语句，那么这个输出顺序和查询列的顺序就会不一致了！如果我们的文件格式已经提前定义好了，那么这个就很不好调整了。除非手动一列一列的在文件管理器中删除所有列，然后重新建立，但这样会非常耗费时间和精力，并且非常容易出错。</p><h2 id="articleHeader2">解决过程</h2><p>先看看问题，再来看比较简单的解决方案。</p><p>测试数据源查询语句和结果 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04120301-a9947586bb164aac825e38e4a4828675.png"/></p><p>如果是直接查询的话，文件输出列的顺序没有任何问题和影响，下面是我的查询语句，和在 SQL Server 中的是一样的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121023-123a466b1dbb4da0894db977779c93cd.png"/></p><p>OLE DB Source 里的顺序与查询语句一致。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121034-616775c6afc54aca8e4b229d291b5c20.png"/></p><p>向下关联一个文件输出并在它的连接管理器中可以看到这些顺序都是一样的，不需要做出任何调整。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121041-06b43bb26f32435987945d7ccbdadfc8.png"/></p><p>最后的输出结果也是一样的，列的输出顺序都一致，没有问题。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121049-4d580f3e4e414f9caf3e18fa3f32266c.png"/></p><p>现在我们使用变量来保存这个查询语句 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04122241-11ed0026a2ef4e7f818aecbd05afc267.png"/></p><p>在数据源中使用这个变量作为查询语句来查询 -</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04122251-451fc395a20641e8b3722596e5032680.png"/></p><p>切换到 Columns 的时候发现非常诡异的地方出来了，整个列的输出顺序和查询的顺序不一样了。并且更为诡异的问题是，同样的两个变量语句，我反复删除试建了好几次。第一个的顺序和这个还不一样，第二个正常，这是第三个顺序。并且在最开始只测试几个字段的时候，这个顺序一直是正常的，现在看到的是我增加了好几个列才看到的。关于为什么有这个变化，或者与写没写 Top 10 我还真的没有办法重现刚才的第一个顺序，总之问题出现了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04122258-f5905ec887fd4b28b7adc04312e454a9.png"/></p><p>这样输出的时候，和文件管理器关联之后的顺序。以前的做法是先删除所有的，然后重新一项一项添加回去，并且还要注意数据类型都要记下来。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04123003-468ffe6674644cf48abe784759482201.png"/></p><p>但是这样确实存在一个问题，如果我们的输出列比较复杂，要不一个一个列的类型顺序记载下来会非常花费时间和精力。可以在这里调整，但是总觉得是一个效率比较低的选择。</p><p>输出的结果果然如此，顺序和期望的不一致！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04123440-26158428b64e4897b81e6192b56af3d0.png"/></p><p>解决的方法虽然也需要人工手动操作，但是比起在文件管理器中删除新建要容易的多，回到数据源的列，先取消全部可用的列。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04123629-3f61655442484c709ac685f849262456.png"/></p><p>然后对照查询语句列的顺序，依次选中需要的列，比如第一个先勾选 BusinessEntityID，第二个再勾选 NationalIDNumber，后面根据需要按顺序依次勾选。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04123918-5f2e8fd7dd574c8f95a229941ff3921e.png"/></p><p>按顺序选择完成之后，这样所有的列又按照查询顺序输出了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04123959-0abd2d00a45f46ca9c4f35f0840cdb67.png"/></p><p>需要重新建立新的文件链接管理器，这样可以避免之前的缓存影响，再来看管理器中的列顺序也是对应一致的，没有问题了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121041-06b43bb26f32435987945d7ccbdadfc8.png"/></p><p>输出结果也是一致的了！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201312/04121049-4d580f3e4e414f9caf3e18fa3f32266c.png"/></p><p>写到这里我也仍然怀疑，如果直接用表难道就一直没有出现这个现象吗，还是没有碰到？ 这个确实记不清了，但是从这个问题反而使得另外的一个问题变得很清晰，也就是无论输入源的查询顺序是怎么样的，我们完全可以控制它的输出顺序。因为有的时候可能会碰到第三方直接给你一个视图或者存储过程，输出的就是这样的顺序，但是下游文件格式已经固定了，那么就可以通过这种方式来完成自定义的顺序向下输出了。</p>
</div>]
</body>
</html>
