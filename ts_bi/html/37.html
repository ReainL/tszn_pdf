
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p>在 ETL 项目中，我们经常碰到这样的场景 - 数据源来自于文件，一个或者很多个文件。这些文件有可能是每日或者每周从其它应用程序中传送过来作为 ETL 项目的数据源。我们在 SSIS 中可以从这些文件数据源中加载数据，之后再进行转换入库等过程。但是有一个很重要的问题，就是源文件被处理之后不断在硬盘上累加累加，因此到最后磁盘空间不够。因此通常的做法就是当源文件处理完成之后，我们需要将源文件拷贝复制到另外一个备份服务器磁盘，然后再删除掉这些文件。</p><p>在 SSIS 中我们实际上有两种处理文件的方式，一种是通过 Script Task 自己写代码的形式实现，一种就是通过 File System Task 来实现。在这篇文章中我们将介绍使用 File System Task 来完成对文件以及文件夹的操作。</p><h4 id="articleHeader2" style="margin-left: 0px;">File System Task  </h4><p>File System Task 主要用来在 SSIS 中处理单个文件或者文件夹，比如复制，移动，删除，重命名等常规操作。当然还有对文件或者文件夹的一些属性的操作，比如显示或隐藏，只读操作等。</p><p>在我的测试 INPUT_DRECTORY 下有一个文件</p><p>D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15\Employee.txt，我们可以将这个文件先复制到 D:\BIWORKSPACE_FILE\ARCHIVE_DIRECTORY\15 文件夹下，并在存储的时候将文件名称后面加上时间后缀。</p><p>新建一个包，并添加一个 File System Task。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221717090761431.png"/></p><p>新建两个变量，一个变量表示 Source File 源文件路径，另一个表示 Archive File 目标文件路径，并且目标文件的生成是根据当前时间的。</p><p>PV_ARCHIVE_FILE_PATH 中的表达式 -</p><pre><code><span style='font-family: "Microsoft YaHei"; line-height: 1.5 !important;'><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>D:\\BIWORKSPACE_FILE\\ARCHIVE_DIRECTORY\\15\\</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>+ <span style='color: rgb(0, 0, 255); font-family: "Courier New" !important; line-height: 1.5 !important;'>REPLACE</span>( (DT_WSTR, <span style='color: rgb(128, 0, 128); font-family: "Courier New" !important; line-height: 1.5 !important;'>31</span>)(DT_DBDATE) GETDATE(),<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>-</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>,<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>_</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span>) +<span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>_Employee.txt</span><span style='color: rgb(128, 0, 0); font-family: "Courier New" !important; line-height: 1.5 !important;'>"</span></span></code></pre><p style="margin-left: auto;"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221718003106282.png"/></p><p style="margin-left: auto;">如果指定的都是变量，那么就不需要新建文件连接，File System Task 在内部的处理其实类似于 C#中的代码处理一样。在 Operation 中有很多的操作，如同前面介绍的一样，File System Task 在当前的配置中只能处理单个文件或者文件夹，但是配合以 Foreach Loop 就可以处理多个文件了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221718105143533.png"/></p><p>保存并执行，这个过程非常的简单，在 Archive Folder 下能看到保存之后的文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221718203575739.png"/></p><p>如果把 Destination Connection 中 OverwriteDestination 属性修改为 False 的话，那么在第二次运行包的时候就会出现错误。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221718284515847.png"/></p><p>错误信息如下：</p><p><span style="color: rgb(255, 0, 0);">[File System Task] Error: An error occurred with the following error message: "The file 'D:\BIWORKSPACE_FILE\ARCHIVE_DIRECTORY\15\2014_09_21_Employee.txt' already exists.".</span></p><p>所以如果看到这种错误的话，就知道什么地方的属性设置错了。</p><h4 id="articleHeader3" style="margin-left: 0px;">Move File 的失败</h4><p>将 Operation 改成 Move File 然后执行。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221719468103619.png"/></p><p>会出现这样的一个错误：</p><p><span style="color: rgb(255, 0, 0);">[File System Task] Error: An error occurred with the following error message: "Could not find a part of the path.". </span></p><p><span style="color: rgb(255, 0, 0);"><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221720088261879.png"/></span></p><p>在这种情况下，是不能这样来操作的。我们先演示另外一种正确的方法，最后再来解决这个问题。</p><p>方式是，先拷贝然后再删除源文件。因此在这个 Task 之下再添加一个 Task，用来在拷贝之后删除源文件。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221720185295341.png"/></p><p>这样做是可以成功的，源文件也没有了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221721203105716.png"/></p><p> </p><p>再来看之前 Move 的那个问题，是什么原因造成的？所谓的 Move 移动，通常是指将一个文件从一个地方剪切移动到另外一个"地方"，而这个"地方"很明显指的应该是文件夹。</p><p>所以再新建一个变量 PV_MOVE_FILE_FOLDER - D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221720544988998.png"/></p><p>新建一个 File System Task，目标变量是指向 PV_MOVE_FILE_FOLDER 中的文件夹地址。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221721374678158.png"/></p><p>单独执行这个 Task，这次文件是可以 Move 成功的。但是也要注意，前提是这个文件必须是存在的，否则就会碰到类似于这样的错误：</p><p><span style="color: rgb(255, 0, 0);">[File System Task] Error: An error occurred with the following error message: "Could not find file 'D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15\Employee.txt'.".</span></p><p>最后再添加一个 File System Task 完成 Move File 之后对 Archive File 重命名。</p><p>新建一个变量 PV_MOVE_FILE_PATH 表示 Move 之后的 Archive File。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221721461237136.png"/></p><p>把这个文件作为数据源，然后目标文件还是表达式变量 PV_ARCHIVE_FILE_PATH，这样就完成了对被移动文件的重命名。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221722020295161.png"/></p><p>这样的效果就实现了，但是这种 Move 的方式很明显没有先 Copy 然后再 Delete 的方式简单。因为在文件拷贝的时候就直接可以跟文件重命名了！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221722102648311.png"/></p><h4 id="articleHeader4" style="margin-left: 0px;">演示 Directory 的操作</h4><p>在 D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15 下有一个文件夹 BIWORK_TEST_DIREC，它们的结构如下：</p><ol><li>D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15\BIWORK_TEST_DIREC\1\Employee.txt</li><li>D:\BIWORKSPACE_FILE\INPUT_DIRECTORY\15\BIWORK_TEST_DIREC\2\Made-in-China.com.csv</li></ol><p>我们将把 BIWORK_TEST_DIREC 以及它下面的所有文件夹和文件移动到 D:\BIWORKSPACE_FILE\ARCHIVE_DIRECTORY\15 目录下。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221722314351213.png"/></p><p>保存并执行，操作成功，原本在 INPUT_DIRECTORY 的文件夹和下面的文件就统统移动到 ARCHIVE_DIRECTORY 下来了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201409/221722543105901.png"/></p><h4 id="articleHeader5" style="margin-left: 0px;">总结</h4><p>当然使用 File System Task 操作文件是不是最好的方式？不见得，因为每一次操作，比如移动文件，拷贝，移动文件夹等等步骤必须分开在不同的 File System Task 中。但是实际上这些步骤可以都一起在 Script Task 中实现，并且 File System Task 对于文件源是无法做到验证的。比如移动文件的时候由于源文件不存在而造成失败，这种情况在 Script Task 中都是可以很好的避免的，因此实际上大多数时候都是通过 Script Task 来实现这类文件操作的。但是由于不同的开发者习惯不同，因此在各种 ETL 项目中， File System Task 的使用还是比较普遍的，并且省掉了 Coding 部分直接通过简单的配置来实现这 比Script Task 要更加方便。</p><p>最后，通常情况下操作文件都是一批一批来处理的，这样只有结合到 Foreach Loop 等组件来实现多个文件的处理，这个是后面再来介绍。</p>
</div>]
</body>
</html>
