
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>最近有人问我有关文件处理中空值处理的相关问题： </p><ol><li>OLE DB Destination 中的 Keep Nulls 如何控制 NULL 值的显示？</li><li>为什么选中了 Keep Nulls 但是数据库中没有 NULL 值？ </li><li>为什么在 Flat File Source 中勾选上了 Retain null values..但目标表上显示的是一个当前日期，而不是 NULL ？</li></ol><p>单开此文来解释这些非常容易混淆的概念。</p><h2 id="articleHeader2">项目需求和文件处理中的问题</h2><p>在比较纯粹的 ETL 项目中都会碰到对空值的处理，特别是对以文件数据源中的控制处理。不同的项目，不同的设计，对最终输出值的控制是不一样的。</p><p>就 SSIS 对平面文件 NULL 值的处理，可以有这么几个实际开发中会碰到的问题或者需求，如果文件源中有空值 -</p><ol><li>如何让它在输出到目标表的时候使用目标表列的默认值？</li><li>如何让它在输出到目标表的时候显示 NULL ?</li><li>如何让它在输出到目标表的时候显示空白字符串 ？</li></ol><h2 id="articleHeader3">普遍性的概念理解上的误区</h2><p>通常情况下，在以平面文件为数据源的 ETL 处理过程中，对于数据源中的空值的控制往往涉及到源控件和目标控件，例如 Flat File Source 和 OLE DB Destination。但是，即使经验和丰富的 ETL 开发人员也非常容易混淆这几种不同配置的差异，并且特别对于 DEFAULT VALUE 这一点常常被忽略掉了。</p><p>我看到的一篇博客 - <a href="http://www.sqlservercentral.com/articles/Integration+Services+(SSIS)/61818/" target="_blank"><u><font color="#0066cc">http://www.sqlservercentral.com/articles/Integration+Services+(SSIS)/61818/</font></u></a> 这位作者本身的介绍的出发点没有错，但是就没有正确区分 OLE DB Destination 中 Fast Load 和 非 Fast Load 对于这个 NULL 值的影响。</p><p>包括之前我遇到的一个面试，面试我的人错误的认为对于空值的输出只有 NULL 和 空白字符串两种方式，而漏掉了 DEFAULT 处理。但是这一个细节其实是非常重要的，了解这一个特性可以避免在 ETL 中加入条件判断，类型转换来确保目标列的值不是 NULL 或者空白字符串。</p><p>所以这些小细节是非常容易出错，概念的混淆也是普遍性的。因此，这篇文章以不同的测试案例总结让大家区分不同的配置对空值的影响，最终理解这些细节。</p><h2 id="articleHeader4">概括与总结</h2><p>我先用下面这幅图来说明这个区别，后面是详细的比较案例，最后再来解释这些区别的原因。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212152074561389.png"/></p><p>数据源如下图所示，是一个以逗号分隔的文本文件，注意到第4行的逗号分隔部分的内容是一个空字符串，而第5行是没有值，表示空值。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212152213157756.png"/></p><p>测试目标表部分结构, 注意到 Middle Name 和 Hire Date 这两列上有 Default 约束。</p><pre><code><span style="font-family: Microsoft YaHei;"><span style="color: rgb(0, 0, 255);">IF</span> <span style="color: rgb(255, 0, 255);">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">T005_STAGING_EMPLOYEE</span><span style="color: rgb(255, 0, 0);">'</span>) <span style="color: rgb(0, 0, 255);">IS</span> <span style="color: rgb(128, 128, 128);">NOT</span> <span style="color: rgb(0, 0, 255);">NULL</span><br/>
<span style="color: rgb(0, 0, 255);">DROP</span> <span style="color: rgb(0, 0, 255);">TABLE</span><span style="color: rgb(0, 0, 0);"> T005_STAGING_EMPLOYEE<br/>
</span><span style="color: rgb(0, 0, 255);">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255);">CREATE</span> <span style="color: rgb(0, 0, 255);">TABLE</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">T005_STAGING_EMPLOYEE_1</span><span style="color: rgb(255, 0, 0);">]</span><span style="color: rgb(0, 0, 0);"> (<br/>
    ID </span><span style="color: rgb(0, 0, 255);">INT</span> <span style="color: rgb(0, 0, 255);">PRIMARY</span> <span style="color: rgb(0, 0, 255);">KEY</span> <span style="color: rgb(255, 0, 255);">IDENTITY</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span>,<span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">FIRSTNAME</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">LASTNAME</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">MIDDLENAME</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span>) <span style="color: rgb(0, 0, 255);">DEFAULT</span>(<span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(255, 0, 0);">-</span><span style="color: rgb(255, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">NAMESTYLE</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">TITLE</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">HIREDATE</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span>) <span style="color: rgb(0, 0, 255);">DEFAULT</span>(<span style="color: rgb(255, 0, 255);">GETDATE</span><span style="color: rgb(0, 0, 0);">()),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">BIRTHDATE</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">),<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">EMAILADDRESS</span><span style="color: rgb(255, 0, 0);">]</span> <span style="color: rgb(0, 0, 255);">VARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold;">50</span><span style="color: rgb(0, 0, 0);">)<br/>
）</span></span></code></pre><h3 id="articleHeader5">第一个测试  </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 默认不选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212154080966879.png"/></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212154212066916.png"/></p><p>Mapping 中自动标识列忽略掉。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212154355344127.png"/></p><p>配置完成后保存并执行包，查看表结果，第四行输出的是空白字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212154445653920.png"/></p><h3 id="articleHeader6">第二个测试  </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 默认不选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View - Fast Load。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155014561347.png"/></p><p>看似查询结果没有什么变化，和第一个测试案例中的是一样的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155081901238.png"/></p><h3 id="articleHeader7">第三个测试  </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155150819942.png"/></p><p>保存并执行，查看数据表结果，第4行的 MIDDLE NAME 自动转换为 NULL 了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155325033698.png"/></p><h3 id="articleHeader8">第四个测试  </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View - Fast Load。</p><p>保存并执行包，查看结果， 会发现第4行的 Middle Name 使用了默认值 "-"。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155477377052.png"/></p><h3 id="articleHeader9">第五个测试 </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View - Fast Load。</p><p>Keep Nulls - 选中。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212155561432488.png"/></p><p>保存并执行，查看数据表结果，第4行的 MIDDLE NAME 此时又变成NULL 了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212156057688395.png"/></p><h3 id="articleHeader10">第六个测试 </h3><p>Flat File Source  - Retain null values from the source as null values in the data flow - 不选中。</p><p>OLE DB Destination - Data Access Mode - 选择 Table or View - Fast Load。</p><p>Keep Nulls - 选中。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212156165495989.png"/></p><p>保存运行之后的查询结果是空白字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212156295965241.png"/></p><h2 id="articleHeader11">案例测试的结论</h2><p>通过以上六个测试案例，可以看到当文件数据源中包含有空值的时候，不同的设置输出到数据表中的结果是不一样的，大概有三种：</p><ol><li>空白字符串</li><li>NULL 值</li><li>数据表中列的默认值</li></ol><p>简单总结一下，不同的配置对空值的处理结果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212156599244207.png"/></p><h3 id="articleHeader12">第一阶段 - Flat File Source 对空值的转换过程</h3><p>我们第一点要理解 Flat File Source  中 "Retain null values from the source as null values in the data flow" 的作用，很容易理解：</p><p>默认不选中 - 只要是空值就转成空白字符串向下输出</p><p>选中 - 只要是空值就转成 NULL向下输出</p><p> </p><p>可以打开一个监视器，看看在从 FF_SRC_EMPLOYEE 到 OLD_DST_STAGING_EMPLOYEE_1 的过程中，选中与否的区别。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212157113462930.png"/></p><p>默认不选中的情况下，空值变成字符串。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212157175496492.png"/></p><p>选中之后的效果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212157237535352.png"/></p><p>这是一定要理解的第一点，自 FF_SRC_EMPLOYE 它输出以后，最终到数据表中是否为 NULL 就已经与它自身无关了。只用理解它何时输出为 NULL 何时输出为空字符串就可以了。</p><h3 id="articleHeader13">第二阶段 OLE DB Destination 对空值的处理过程</h3><p>无论是 Fast Load 模式还是非 Fast Load 模式，只要接受上游空间向下输出的是非空值，即非NULL值，那么上游数据是什么，下游就接受成什么。</p><p>因此，即使是文件数据源中存在 NULL 空值，但是只要 Flat File Source 中的 Retain null values from the source as null values in the data flow 勾选上，那么空值在文件源段向下输出时就已经变成空白字符串。所以在 OLE DB Destination 中无论设置什么模式，最终都不会影响空白字符串的输出，因为空白字符串是有值的，长度为0的字符串。</p><p>只有当 Flat File Source 中的 Retain null values from the source as null values in the data flow 勾选上的时候，空值为转换为 NULL 值，这时 OLE DB Destination 中的设置才会影响到最终输出的值。</p><p>Access Mode 中各种配置对 NULL 值的处理方式</p><ol><li>Table or view - 对 NULL 不处理，上游是 NULL 值，它最终输出就是 NULL 值。</li><li>Table or view - fast load 加上默认不选中 Keep nulls - 如果目标列没有 DEFAULT 默认约束的话，那么输出到目标列就是 NULL 值；如果目标列有 DEFAULT 默认约束的话，那么输出到目标列使用的就是 DEFAULT 默认约束中的值。</li><li>Table or view - fast load + 选中 Keep nulls - 无论目标列有没有 DEFAULT 默认约束，都将保留 NULL 值。</li></ol><p>再回头来看这个总结就很容易了，比如在面试中被问到 - 如果文件源中有空值，如何让它在输出到目标表的时候使用目标表列的默认值？ 那么就很容易回答了！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201408/212157441598853.png"/></p><p>所以，把 Flat File Source 和 OLE DB Destination 分开来看，只考虑如何控制 Flat File Source 它的输出是否为 NULL，只考虑 OLE DB Destination 中对 NULL 值的不同处理方式，分成这样两个阶段这个概念就很容易理解了。并且，理解了上面这些内容，就不会再认为只要选中了 Flat File Source 中的 Retain null values from the source as null values in the data flow，文件中的 NULL 值就会输出到目标表了。</p><p>当然，这里面涉及到了 OLE DB Destination 控件中两个不同的加载模式 - Fast Load 和 非 Fast Load，包括其它的几个配置选项，会单独放到一篇文章中去讲解。<br/></p>
</div>]
</body>
</html>
