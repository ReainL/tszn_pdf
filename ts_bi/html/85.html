
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h2 id="articleHeader1">开篇介绍</h2><p>今天在<a href="http://www.flybi.net/question/1078?item_id=2066"><u><font color="#0066cc">天善问答</font></u></a>里看到一个问题，如果我没有理解错的话，它应该是指比如在一个报表中选取一个时间段，然后求出这个时间段的某个 Measure 的 SUM 和。并且同时求出这两个时间点对应的上一年的时间点之间的同一个 Measure 的 SUM 和。</p><p>比如当前选取的时间点是 2004年1月8日，结束时间点是 2004年3月1日。那么不仅要求这个时间段的某度量值总和，并且还要求 2003年1月8日到2003年3月1日时间段的某度量值总和。 也就是说，这个时间段是一个动态的，根据输入的两个时间段决定当年和上一年的计算。</p><p>这个里面有几个小知识点，于是总结了一下，先看下面这个 Report  的效果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150446-18e4d3a1805a40c4895f0118e993f8bc.png"/></p><p>还有使用 Date Picker 的效果 (注意如果使用日历控件，那么 <span style="color: rgb(255, 0, 0);">StartDate 和 EndDate 的类型都是 Date/Time 类型</span>)-</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28173708-25f08e43db9445c79a0a6dee5af6d276.png"/></p><h2 id="articleHeader2">非 Date Picker 参数时的设计</h2><p>在 Cube 中查一下验证一下，查询结果都是一样的。</p><pre><code><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">WITH</span> MEMBER <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Period</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(255, 0, 255);">SUM</span><span>(<br/>
 </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(128, 128, 128);">&amp;</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">20040108</span><span style="color: rgb(255, 0, 0);">]</span>:<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(128, 128, 128);">&amp;</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">20040301</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
   )<br/>
MEMBER </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Last Period</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
<span style="color: rgb(255, 0, 255);">SUM</span><span>(<br/>
 </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(128, 128, 128);">&amp;</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">20030108</span><span style="color: rgb(255, 0, 0);">]</span>:<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(128, 128, 128);">&amp;</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">20030301</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
,</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
   )<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span> NON EMPTY{<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Period</span><span style="color: rgb(255, 0, 0);">]</span><span>,<br/>
 </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Last Period</span><span style="color: rgb(255, 0, 0);">]</span>} <span style="color: rgb(0, 0, 255);">ON</span><span> COLUMNS,<br/>
NON EMPTY { (</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Product</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Category</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Category</span><span style="color: rgb(255, 0, 0);">]</span>.ALLMEMBERS ) } <span style="color: rgb(0, 0, 255);">ON</span><span> ROWS<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Step-by-Step</span><span style="color: rgb(255, 0, 0);">]</span></span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150533-9ca3f19fb3584c7bac39fdfa1d8996cc.png"/></p><p>新建一个 Dataset  - Datedata，连接的是 MDX Step by Step 中的示例Cube。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150624-0aabf6f18166414589369c911af88c1b.png"/></p><p>MDX 查询语句取得时间成员和可以用在 Report 下拉框中的标签。</p><pre><code><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">WITH</span> MEMBER <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateValue</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
   <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span><span>.CurrentMember.UniqueName<br/>
MEMBER </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateLabel</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span><br/>
   <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span><span>.CurrentMember.Name<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span><span><br/>
{  </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateValue</span><span style="color: rgb(255, 0, 0);">]</span>,  <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">DateLabel</span><span style="color: rgb(255, 0, 0);">]</span> } <span style="color: rgb(0, 0, 255);">ON</span><span> COLUMNS,<br/>
{ </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>} <span style="color: rgb(0, 0, 255);">ON</span><span> ROWS<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Step-by-Step</span><span style="color: rgb(255, 0, 0);">]</span></span></code></pre><p><img alt="" height="587" src="http://images.cnitblog.com/blog/477275/201311/28150724-7e5ace34aa964c3293d90c4fd9ae1445.png" width="940"/></p><p>创建两个时间参数 StartDate 和 EndDate 并且绑定到 DateData 中的时间成员，<span style="color: rgb(255, 0, 0);">它们选择的都是 Text 类型，这一点一定要注意</span>！！！。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150756-e4b785762b2b4c9eb86e08dc740c62a2.png"/></p><p>新建一个 Dataset 用来展现表格上的数据，注意在 SSRS Report 中的参数使用一般都是通过这种类似于子查询的方式完成的。</p><pre><code><span style='font-family: "Microsoft Yahei";'><span style="color: rgb(0, 0, 255);">WITH</span> MEMBER <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Last Year</span><span style="color: rgb(255, 0, 0);">]</span><br/>
<span style="color: rgb(0, 0, 255);">AS</span> <span style="color: rgb(255, 0, 255);">SUM</span><span>(<br/>
 {<br/>
  </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> 根据传入的参数分别取得上一年的开始时间点和结束时间点</span><br/>
  PARALLELPERIOD(<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar Year</span><span style="color: rgb(255, 0, 0);">]</span><span>,<br/>
     </span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span>,<br/>
     STRTOMEMBER(</span><span style="color: rgb(0, 128, 0);">@FromDateCalendar</span><span>, CONSTRAINED)<br/>
   ):<br/>
  PARALLELPERIOD(</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Date</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Calendar Year</span><span style="color: rgb(255, 0, 0);">]</span><span>,<br/>
     </span><span style="color: rgb(128, 0, 0); font-weight: bold;">1</span><span>,<br/>
     STRTOMEMBER(</span><span style="color: rgb(0, 128, 0);">@ToDateCalendar</span><span>, CONSTRAINED)<br/>
   )<br/>
  },<br/>
  </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
)<br/>
</span><span style="color: rgb(0, 0, 255);">SELECT</span> NON EMPTY {<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount</span><span style="color: rgb(255, 0, 0);">]</span><span>,<br/>
    </span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Measures</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Reseller Sales Amount of Last Year</span><span style="color: rgb(255, 0, 0);">]</span>} <span style="color: rgb(0, 0, 255);">ON</span><span> COLUMNS,<br/>
NON EMPTY { (</span><span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Product</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Category</span><span style="color: rgb(255, 0, 0);">]</span>.<span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Category</span><span style="color: rgb(255, 0, 0);">]</span>.ALLMEMBERS ) } <span style="color: rgb(0, 0, 255);">ON</span><span> ROWS<br/>
</span><span style="color: rgb(0, 0, 255);">FROM</span><span> (<br/>
             </span><span style="color: rgb(0, 128, 128);">--</span><span style="color: rgb(0, 128, 128);"> Report 传入的开始参数和结束参数</span><br/>
   <span style="color: rgb(0, 0, 255);">SELECT</span> ( STRTOMEMBER(<span style="color: rgb(0, 128, 0);">@FromDateCalendar</span>, CONSTRAINED) : STRTOMEMBER(<span style="color: rgb(0, 128, 0);">@ToDateCalendar</span><span>, CONSTRAINED) )<br/>
   </span><span style="color: rgb(0, 0, 255);">ON</span><span> COLUMNS<br/>
   </span><span style="color: rgb(0, 0, 255);">FROM</span> <span style="color: rgb(255, 0, 0);">[</span><span style="color: rgb(255, 0, 0);">Step-by-Step</span><span style="color: rgb(255, 0, 0);">]</span><span><br/>
)</span></span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150852-36a61aea2080430f89ddf1ec3e449ad6.png"/></p><p>保存并在 Dataset 中绑定两个时间参数。</p><p> <img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150913-c3be867d61c9445c8bf676bd64c028e0.png"/></p><p>这样基本上就完成了基于时间区间的同比时间段的报表。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150446-18e4d3a1805a40c4895f0118e993f8bc.png"/></p><p>还有一点要注意一下，比如像这个查询是不会返回结果的，因为2004年的上一年不是闰年。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150931-b73a893943244361a7a7d113f2e817a1.png"/></p><p>但是是有2003年2月28日这一天的，尽管下面的查询返回一个 NULL 但是这个成员是存在的。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28150939-a089568488df44b7ae2e0e92d38019b5.png"/></p><h2 id="articleHeader3">Date Picker 时的设计</h2><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28173708-25f08e43db9445c79a0a6dee5af6d276.png"/></p><p>在文章一开始的时候就介绍了，如果把时间参数设计成日历形式那么就需要将参数的类型从 Text 类型改成  Date/Time 类型。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174344-0228707154124464bb6c8100b9b46ffe.png"/></p><p>并且这里没有指定可供选择的值，因为一旦指定了值日历控件的样式就又会变成下拉框的样式。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174354-6433552647b14a66b40af33a8a77cb26.png"/></p><p>同时在 DateSet 那里要改变参数的格式，因为 Date\Time 类型是时间类型，并不是字符串类型，因此需要将它们转变成字符串格式。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174405-adb06c35698544db9df6db4b1dcf2539.png"/></p><p>转变的格式代码如下：</p><p>=<span style="color: rgb(163, 21, 21);">"[Date].[Calendar].[Date].&amp;["</span>&amp; Format(CDate(Parameters!StartDate.Value),<span style="color: rgb(163, 21, 21);">"yyyyMMdd"</span>) + <span style="color: rgb(163, 21, 21);">"]"</span></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174415-d12db44ba1604fa89232777073616bde.png"/></p><p>你可以从网上搜索到很多种不同的别人告诉你如何转换格式的经验和代码，但是要注意，你首先要确定的是你要转换的对象是什么？它需要什么格式？</p><p>先最好能够通过下面这种最简单的代码查看一下这种 Hard Code 形式的参数行不行，没有问题之后再放到上面去编辑。</p><p>在网上搜索到的转换过程一般都是使用作者自己代码示例的层次结构，比如说有的就是[Date].[Calendar].&amp;[20040228], 少了一个 Level。</p><p>第二就是转换的字符串格式可能并不是 yyyyMMdd 的类型，而是 yyyy-MM-dd 的类型，所以这两点一定要注意。注意到了，你的转换才会成功！</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174456-fda457115acf4e0683311e6028abc1f3.png"/></p><p>最后一个问题，就是如果用户选择了一个非法的成员传入的时候就会出现这个错误，原因是我们的成员并不包含 11/1/2013 或者 11/29/2013。所以实际上还是使用下拉框的形式最直接，最简单，因为它可直接限定可选择的内容，可以做成年月日级联的效果。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201311/28174504-3e07dc6d2e0549329333d47002fe381d.png"/><br/><br/></p>
</div>]
</body>
</html>
