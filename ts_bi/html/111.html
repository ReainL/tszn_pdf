
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<p>这一部分包含了两部分内容，一部分是对 MDX Infinite Recursion 无限循环的原理解析，第二部分是对计算成员的 SOLVE_ORDER 原理进行了解析。</p><p><strong>计算成员中上下文冲突的问题</strong><strong> - 避免无限循环 Avoiding Infinite Recursion</strong></p><p>直接看一个例子，并假设我们的纬度中多了一个地理纬度和国家这个层次结构。</p><pre><code><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes &amp; Accessories</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Geography</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Country</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">United States</span><span style="color: #ff0000;">]</span>) <br/>
    <span style="color: #808080;">+</span> <br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Geography</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Country</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Canada</span><span style="color: #ff0000;">]</span>)<br/>
<span style="color: #0000ff;">SELECT</span><br/>
{<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Calendar Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">CY 2003</span><span style="color: #ff0000;">]</span>),<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Calendar Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">CY 2004</span><span style="color: #ff0000;">]</span>)<br/>
} <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
{<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.AllMembers} <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span>;</code></pre><p>查询结果</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201304/18182338-41b20bb1aa994df49a12bb6e5415966b.png"/>                       </p><p>双击 单元格中出现的 #Error 出现下面的信息，指出 Bikes &amp; Accessories 依赖于 Bikes &amp; Accessories 构成了一个无限循环 <strong>Infinite Recursion</strong></p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201304/18182357-da3db429028344578f77d4640e96a416.png"/> </p><p>我们来分析下造成这个结果的原因：</p><p>按照我们之前所分析的过程，首先要对某一个具体的元组进行填充，直接用之前的例子并加一个地理纬度。</p><pre><code>(<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Calendar Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">CY 2003</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Periods</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes &amp; Accessories</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Geography</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Country</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Countries</span><span style="color: #ff0000;">]</span>     <br/>
)</code></pre><p>当这个元组被填充完毕后，需要进入到<strong>[Product].[Category].[Bikes &amp; Accessories] </strong>计算成员中分析具体的元组，当前计算成员中的表达式是：</p><p>([Geography].[Country].[United States]) + ([Geography].[Country].[Canada])</p><p>那么需要对当前这两个局部元组进行填充，按照<a href="http://www.cnblogs.com/biwork/archive/2013/04/18/3029187.html">上一篇笔记中</a>提到了一个非常重要的原则 - <span style="color: rgb(255, 0, 0);"><strong>引用当前环境下没有的引用</strong></span>。也就是说除了[Geography].[Country].[All Countries] 不引用外，其它的都引用，这样来填充一个局部元组，就变成了：</p><pre><code>(<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Calendar Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">CY 2003</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Periods</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes &amp; Accessories</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Geography</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Country</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">United States</span><span style="color: #ff0000;">]</span><br/>
)</code></pre><p>加上</p><pre><code>(<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Calendar Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">CY 2003</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Date</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Fiscal Year</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Periods</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes &amp; Accessories</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Subcategory</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Geography</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Country</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Canada</span><span style="color: #ff0000;">]</span><br/>
)</code></pre><p>然后发现<strong>[Product].[Category].[Bikes &amp; Accessories]</strong>还需要被解析，这样一直解析下去就会出现刚才的那种错误，错误指出<strong>[Product].[Category].[Bikes &amp; Accessories] </strong>依赖于 <strong>[Product].[Category].[Bikes &amp; Accessories] </strong>就是这个原因。</p><p><span style="color: rgb(255, 0, 0);">一般情况下，为了避免这种问题的发生，最好的方式就是确保一旦定义这个计算成员属于哪一个属性层次结构，那么在它的表达式中也最好引用同一个属性层次结构下的其它成员。如果有一个或者多个引用引用了其它的计算成员，也要确保那些计算成员不要直接或者间接地再指回来，这样也会造成无限循环。</span></p><p><strong>控制解决的顺序</strong><strong> Controlling Solve Order</strong></p><p>当一个元组包含一个以上的计算成员的时候，有时需要使用　SOLVE_ORDER 属性来控制它们的运算顺序。</p><pre><code><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">+</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">/</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>)<br/>
,FORMAT_STRING<span style="color: #808080;">=</span>"<span style="color: #0000ff;">Percent</span>"<br/>
<span style="color: #0000ff;">SELECT</span><br/>
{<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>),<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>),<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
} <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
{<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.AllMembers} <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201304/18182836-b2e79d46a98b46c3935320cecb5c85bc.png"/></p><p>这个示例中有两个计算成员：</p><p>一个是度量值成员　[Measures].[Combined Sales Amount]　用来存放零售和网络销售的总金额。</p><p>另一个是Product 纬度下的Bikes这类产品在占整个产品的销售比例。</p><p>在查询的结果中 Percent Bikes 和 Combined Sales Amount 对应的那一个单元格的值应该是 82.41+96.46 的平均百分比。</p><p>当没有指定 SOLVE_ORDER 的时候，SSAS 可能正好选择了 Combined Sales Amount 为高优先级别。也就是说先计算 Combined Sales Amount，后计算 Percent Bikes 的值。 (我理解的和书上不一样)</p><p>把这个例子改简单点，然后准备分解它：　</p><pre><code><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">+</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
,SOLVE_ORDER <span style="color: #808080;">=</span> <span style="color: #800000; font-weight: bold;">2</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">/</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>)<br/>
,FORMAT_STRING<span style="color: #808080;">=</span>"<span style="color: #0000ff;">Percent</span>"<br/>
,SOLVE_ORDER <span style="color: #808080;">=</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<span style="color: #0000ff;">SELECT</span><br/>
{<br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
} <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
{<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>} <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span></code></pre><p>首先，根据这个查询我们可以得到一个元组，假设只有这两个纬度或者层次结构，这就是一个完整的元组。</p><pre><code>(<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
    <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span><br/>
)</code></pre><p>根据SOLVE_ORDER  的优先级别，数值越大的越优先处理，因此将先解析计算成员[Measures].[Combined Sales Amount]。</p><p>那么在计算成员[Measures].[Combined Sales Amount]中，表达式中的两个元组将被填充和变形为：<img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"/></p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>　<span style="color: #008080;">--</span><span style="color: #008080;">　这是表达式中局部元组没有的引用,需要被填充</span><br/>
)<br/>
<span style="color: #808080;">+</span><br/>
(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #008080;">--</span><span style="color: #008080;">　这是表达式中局部元组没有的引用,需要被填充</span><br/>
)</code></pre><p>这个时候，由于[Product].[Category].[Percent Bikes] 也是一个计算成员，那么就在此时对这个计算成员在以上面两个元组为上下文的前提下进行解析。</p><p>对于操作符加号之前的第一个元组　－</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>　　<br/>
)</code></pre><p>实际上就变成了</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>　<span style="color: #008080;">--</span><span style="color: #008080;">　上下文的引用继续使用　</span><br/>
)<br/>
<span style="color: #808080;">/</span><br/>
(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>  <span style="color: #008080;">--</span><span style="color: #008080;"> 上下文的引用继续使用</span><br/>
)</code></pre><p>那么到这里就可以完全定位到这两个元组在空间上的位置并通过查询可以得到值</p><pre><code><span style="color: #0000ff;">SELECT</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span>;<br/>
<span style="color: #008080;">/*</span><span style="color: #008080;">* $66,302,381.56 *</span><span style="color: #008080;">*/</span><br/>
<br/>
<span style="color: #0000ff;">SELECT</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span>;<br/>
<span style="color: #008080;">/*</span><span style="color: #008080;">* $80,450,596.98 *</span><span style="color: #008080;">*/</span></code></pre><p>那就是　66,302,381.56　/80,450,596.98 = 0.824137</p><p>同样的道理，对于操作符之后的一个元组</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>  <br/>
)</code></pre><p>就等于</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Internet Sales Amount</span><span style="color: #ff0000;">]</span>　<span style="color: #008080;">--</span><span style="color: #008080;">　上下文的引用继续使用　</span><br/>
)<br/>
<span style="color: #808080;">/</span><br/>
(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>，<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Internet Sales Amount</span><span style="color: #ff0000;">]</span>  <span style="color: #008080;">--</span><span style="color: #008080;"> 上下文的引用继续使用</span><br/>
)<br/>
<br/>
-- 单独的组合查询一下结果<span style="color: #0000ff;"> SELECT</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span>;<br/>
<span style="color: #008080;">/*</span><span style="color: #008080;">* $28,318,144.65 *</span><span style="color: #008080;">*/</span><br/>
<br/>
<span style="color: #0000ff;">SELECT</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span>;<br/>
<span style="color: #008080;">/*</span><span style="color: #008080;">* $29,358,677.22 *</span><span style="color: #008080;">*/</span></code></pre><p>那就是　28,318,144.65/29,358,677.22 = 0.964557</p><p>因此最后计算成员[Measures].[Combined Sales Amount] 最终的结果就应该是：</p><p>0.824137 + 0.964557 的百分比 178.87%</p><p>最后看这个元组</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span><br/>
)</code></pre><p>因为先解析的是 [Measures].[Combined Sales Amount],但是在解析这个成员的过程中就已经解析了[Product].[Category].[Percent Bikes]，得到的最后的结果就是178.87%</p><p>如果把它们之间的SOLVE_ORDER 互换</p><pre><code><span style="color: #0000ff;">WITH</span><br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Reseller Sales Amount</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">+</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Internet Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
,SOLVE_ORDER <span style="color: #808080;">=</span> <span style="color: #800000; font-weight: bold;">1</span><br/>
<br/>
MEMBER <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span> <span style="color: #0000ff;">AS</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>)<span style="color: #808080;">/</span>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>)<br/>
,FORMAT_STRING<span style="color: #808080;">=</span>"<span style="color: #0000ff;">Percent</span>"<br/>
,SOLVE_ORDER <span style="color: #808080;">=</span> <span style="color: #800000; font-weight: bold;">2</span><br/>
<br/>
<span style="color: #0000ff;">SELECT</span><br/>
{<br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
} <span style="color: #0000ff;">ON</span> COLUMNS,<br/>
{<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>} <span style="color: #0000ff;">ON</span> ROWS<br/>
<span style="color: #0000ff;">FROM</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Step-by-Step</span><span style="color: #ff0000;">]</span></code></pre><p><img alt="" src="http://images.cnitblog.com/blog/477275/201304/18183430-44f9d6af18744a0ead4b2c6dfd54e4f6.png"/></p><p>很显然在解析元组的过程中，Percent Bikes 这个计算成员将首先被解析：</p><pre><code>(<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>,<br/>
<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Percent Bikes</span><span style="color: #ff0000;">]</span>  <span style="color: #008080;">--</span><span style="color: #008080;"> 首先被解析,可以理解为以它为入口去填充元组</span><br/>
)</code></pre><p>跳跃一下省去与上面雷同的一些步骤,那就变成了要解析：</p><pre><code>(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
<span style="color: #808080;">/</span><br/>
(<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">All Products</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Combined Sales Amount</span><span style="color: #ff0000;">]</span>)</code></pre><p>再继续变：</p><pre><code>(<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Reseller Sales Amount</span><span style="color: #ff0000;">]</span>) <span style="color: #808080;">+</span><br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Bikes</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Internet Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
)<br/>
<span style="color: #808080;">/</span><br/>
(<br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> All Products</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Reseller Sales Amount</span><span style="color: #ff0000;">]</span>) <br/>
    <span style="color: #808080;">+</span><br/>
    (<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Product</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;">Category</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> All Products</span><span style="color: #ff0000;">]</span>, <span style="color: #ff0000;">[</span><span style="color: #ff0000;">Measures</span><span style="color: #ff0000;">]</span>.<span style="color: #ff0000;">[</span><span style="color: #ff0000;"> Internet Sales Amount</span><span style="color: #ff0000;">]</span>)<br/>
)</code></pre><p>= 28,318,144.65 + 66,302,381.56　/29,358,677.22 + 80,450,596.98</p><p>= 94629526.21 /109809274.2 = 0.86176 = 86.17%</p><p>写了这么多，也是为了验证一下　SOLVE_ORDER　起到的作用包括 MDX 大概是如何解析这些计算成员的。</p><p>通过这些分析相信可以更深的理解 SSAS 对局部元组的填充规则，只有理解SSAS对局部元组的填充规则包括在计算成员中对已存在的上下文的引用，才能最终定位真正参与运算的单元格的值。换句话说所有的数值的出现都离不开参与运算的成员在Cube空间上的坐标定位，而这种坐标定位是通过元组填充来实现的。所以了解SSAS在不同情况下对元组的填充规则是非常重要的！</p><p>最后总结一下　SOLVE_ORDER 我理解的和书上有点不一样，通过我上面的推理 SOLVE_ORDER 值越大的计算成员被处理的优先级别就越高。</p><p>它的范围应该是从1开始，最大值是65535。</p><p>写的很辛苦! 希望我的理解是正确的!</p><p><strong>Formatting Calculated Members</strong></p><p>之前的例子里在计算成员中使用了 FORMAT_STRING 属性来格式化最终在查询结果中返回的值。比如像之前显示的百分比，就是通过定义 FORMAT_STRING= "Percent" 来实现了，除了这个之外，格式化的结果还有其它更多的选择。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201304/19094319-3060a1ac8d744ebe98871578c119f828.png"/></p>
</div>]
</body>
</html>
