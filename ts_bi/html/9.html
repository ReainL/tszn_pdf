
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
[<div class="message-content editor-style">
<h3 id="articleHeader1" style="margin-left: 0px;">开篇介绍</h3><p>假设在业务中也有这样的一个需求，再从数据源抽取数据到目标表比如 Staging 表时，需要记录每次抽取的条数改如何实现？实际上，实现的方式也很多种，这取决于你的日志系统的设计与架构。这个案例只是简单的用到 SSIS 中的一个可以记录行数的控件 Row Count 来实现一下这个需求。</p><h3 id="articleHeader2" style="margin-left: 0px;">Row Count 的使用</h3><p>首先我们有一张记录表插入条数的日志表，功能非常简单，就是记录在哪一批次的执行下，位于哪个包的表插入日志记录。</p><pre><code><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">IF</span> <span style="color: rgb(255, 0, 255); line-height: 1.5 !important;">OBJECT_ID</span>(<span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">'</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">T039_ROWCOUNT_LOG</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">'</span>,<span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">'</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">U</span><span style="color: rgb(255, 0, 0); line-height: 1.5 !important;">'</span>) <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">IS</span> <span style="color: rgb(128, 128, 128); line-height: 1.5 !important;">NOT</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">NULL</span><br/>
<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">DROP</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">TABLE</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;"> T039_ROWCOUNT_LOG<br/>
</span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">GO</span><br/>
<br/>
<span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">CREATE</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">TABLE</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;"> T039_ROWCOUNT_LOG<br/>
(<br/>
 EXECUTION_ID </span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">255</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
 PACKAGE_NAME </span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">255</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">), <br/>
 TABLE_NAME </span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">NVARCHAR</span>(<span style="color: rgb(128, 0, 0); font-weight: bold; line-height: 1.5 !important;">225</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">),<br/>
 INSERTED_COUNT </span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">BIGINT</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;">, <br/>
 INSERTED_DATE </span><span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">DATETIME</span><span style="color: rgb(0, 0, 0); line-height: 1.5 !important;"> <br/>
)</span></code></pre><p style="margin-left: auto;">比如插入的测试结果如下：</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121529182727100.png"/></p><h4 id="articleHeader3" style="margin-left: 0px;">实现过程</h4><p>在包中先定义一个变量，这个变量就是用来记录插入的条数。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121529305851494.png"/></p><p>拖放一个 Row Count 控件到源与目标控件之间。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121529494138479.png"/> </p><p>双击编辑 Row Count 控件，选择之前创建好的变量。这样当从 FF_SRC_INTERNET_SALES 文件数据源向 OLE_DST_INTERNET_SALES 目标写入数据的时候，ROW_COUNT 就会记录所有的条数。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121529572252099.png"/></p><p>当 DFT_LOAD_INTERNET_SALES 数据流结束之后，变量已经获取到插入的条数，因此可以直接通过 Execute SQL Task 向日志表中插入这次条数的信息。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121530035694405.png"/></p><p>编辑 EST_INSERT_TABLE_COUNT_LOG 的 SQL 语句，表的名称是 Hard Code 硬编码的，这一点要注意。也就是说，一个 Execute SQL Task 只为一个表负责，并且每一个 Execute SQL Task 只紧跟在当前需要记录表插入条数的 Data Flow Task 数据流之后。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121530102564580.png"/></p><p>参数的配置。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121530163977357.png"/></p><p>保存并运行包。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121530231004304.png"/></p><p>那么每次包运行抽取数据的记录都会被插入到日志表中，每次写入的条数也可以被记录下来了。</p><p><img alt="" src="http://images.cnitblog.com/blog/477275/201411/121530293811123.png"/></p><h3 id="articleHeader4" style="margin-left: 0px;">总结</h3><p>这个例子比较简单，只是单纯的记录一下写入的条数，基于这个非常基础的案例可扩展的日志内容还有很多，实现的方式也有很多种，因为一个完整的数据仓库日志系统是包含很多方面的：</p><p><strong>系统方面</strong></p><ul><li>包执行状态，包中各层级任务执行状态（正常，错误，取消），时长等日志信息。</li><li>数据源端数据变化日志信息，每天，每月重点数据源表，文件数据量变化日志信息。</li><li>数据仓库维度，事实每天，每周，每月的数据量变化日志信息。</li><li>数据库文件，每天，每周，每月的数据量变化日志信息。</li></ul><p><strong>业务方面</strong></p><ul><li>重点业务数据的增长对数据仓库事实表，维度表的增长状态的关联信息。</li><li>不同时间阶段业务数据的增长与数据仓库事实表，维度表在不同周期增长的关联信息。</li></ul><p><strong>报表方面</strong></p><ul><li>不同业务报表的分布情况，访问量，周期性的访问频率等等。</li></ul><p>有了这些体系，我们才能对我们的数据仓库了如指掌！可以更好的维护，管理，预判业务的增长量对数据仓库的影响等等有着非常至关重要的作用，包括对包，任务，报表的调优都可以起到非常大的作用，可以说是基于 BI 的 BI 系统。</p>
<ul class="aw-upload-file-list">
</ul>
</div>]
</body>
</html>
